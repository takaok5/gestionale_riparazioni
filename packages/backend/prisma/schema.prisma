generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TECNICO
  COMMERCIALE
}

enum TipoCliente {
  PRIVATO
  AZIENDA
}

enum CategoriaFornitore {
  RICAMBI
  SERVIZI
  ALTRO
}

enum TipoNotifica {
  STATO_RIPARAZIONE
  PREVENTIVO
}

enum StatoNotifica {
  INVIATA
  FALLITA
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  role      Role     @default(TECNICO)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs              AuditLog[]
  riparazioniAssegnate   Riparazione[] @relation("RiparazioneTecnico")
  statiHistoryChanges    RiparazioneStatoHistory[] @relation("RiparazioneStatoHistoryUser")
}

model Cliente {
  id             Int         @id @default(autoincrement())
  codiceCliente  String      @unique
  tipologia      TipoCliente @default(PRIVATO)
  nome           String
  cognome        String?
  ragioneSociale String?
  partitaIva     String?
  codiceFiscale  String?
  indirizzo      String
  citta          String
  cap            String
  provincia      String
  telefono       String?
  email          String?      @unique
  note           String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  riparazioni    Riparazione[]
}

model Fornitore {
  id              Int                @id @default(autoincrement())
  codiceFornitore String             @unique
  categoria       CategoriaFornitore @default(ALTRO)
  nome            String
  cognome         String?
  ragioneSociale  String?
  partitaIva      String?             @unique
  codiceFiscale   String?
  indirizzo       String
  citta           String
  cap             String
  provincia       String
  telefono        String?
  email           String?
  note            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  ordini          OrdineFornitore[]
  articoli        Articolo[]
}

model Articolo {
  id             Int       @id @default(autoincrement())
  codiceArticolo String    @unique
  nome           String
  descrizione    String
  categoria      String
  fornitoreId    Int
  fornitore      Fornitore @relation(fields: [fornitoreId], references: [id])
  prezzoAcquisto Float
  prezzoVendita  Float
  sogliaMinima   Int
  giacenza       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  ricambiUsati   RiparazioneRicambio[]
  ordiniVoci     OrdineFornitoreVoce[]

  @@index([fornitoreId])
}

model ServizioVetrina {
  id                  Int      @id @default(autoincrement())
  slug                String   @unique
  title               String
  summary             String
  description         String
  priceFrom           String
  averageDuration     String
  categoria           String
  attivo              Boolean  @default(true)
  ordineVisualizzazione Int    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([attivo, ordineVisualizzazione])
}

model OrdineFornitore {
  id           Int       @id @default(autoincrement())
  fornitoreId  Int
  fornitore    Fornitore @relation(fields: [fornitoreId], references: [id])
  numeroOrdine String    @unique
  stato        String
  dataOrdine   DateTime
  dataEmissione DateTime?
  dataRicezione DateTime?
  totale       Float
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  voci         OrdineFornitoreVoce[]

  @@index([fornitoreId])
}

model OrdineFornitoreVoce {
  id               Int             @id @default(autoincrement())
  ordineId         Int
  ordine           OrdineFornitore @relation(fields: [ordineId], references: [id], onDelete: Cascade)
  articoloId       Int
  articolo         Articolo        @relation(fields: [articoloId], references: [id])
  quantitaOrdinata Int
  quantitaRicevuta Int             @default(0)
  dataUltimaRicezione DateTime?
  prezzoUnitario   Float
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([ordineId])
  @@index([articoloId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  modelName String
  objectId  String
  timestamp DateTime @default(now())
  dettagli  Json?
}

model Riparazione {
  id               Int      @id @default(autoincrement())
  clienteId        Int
  cliente          Cliente  @relation(fields: [clienteId], references: [id])
  tecnicoId        Int?
  tecnico          User?    @relation("RiparazioneTecnico", fields: [tecnicoId], references: [id])
  codiceRiparazione String  @unique
  stato            String   @default("RICEVUTA")
  dataRicezione    DateTime @default(now())
  tipoDispositivo  String
  marcaDispositivo String
  modelloDispositivo String
  serialeDispositivo String
  descrizioneProblema String
  accessoriConsegnati String
  priorita         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  statiHistory     RiparazioneStatoHistory[]
  preventivi       RiparazionePreventivo[]
  ricambi          RiparazioneRicambio[]
  notifiche        Notifica[]

  @@index([clienteId])
  @@index([tecnicoId])
  @@index([dataRicezione])
}

model Notifica {
  id             Int          @id @default(autoincrement())
  tipo           TipoNotifica
  destinatario   String
  oggetto        String
  contenuto      String
  stato          StatoNotifica
  riferimentoTipo String
  riferimentoId  Int
  dataInvio      DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  riparazioneId  Int?
  riparazione    Riparazione? @relation(fields: [riparazioneId], references: [id])

  @@index([tipo])
  @@index([stato])
  @@index([riferimentoId])
  @@index([riparazioneId])
}

model RiparazioneStatoHistory {
  id            Int         @id @default(autoincrement())
  riparazioneId Int
  riparazione   Riparazione @relation(fields: [riparazioneId], references: [id])
  stato         String
  dataOra       DateTime    @default(now())
  userId        Int?
  user          User?       @relation("RiparazioneStatoHistoryUser", fields: [userId], references: [id])
  note          String?

  @@index([riparazioneId])
  @@index([userId])
  @@index([dataOra])
}

model RiparazionePreventivo {
  id               Int         @id @default(autoincrement())
  riparazioneId    Int
  riparazione      Riparazione @relation(fields: [riparazioneId], references: [id])
  numeroPreventivo String      @unique
  stato            String
  dataInvio        DateTime?
  dataRisposta     DateTime?
  subtotale        Float?
  iva              Float?
  totale           Float
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  voci             PreventivoVoce[]

  @@index([riparazioneId])
}

model PreventivoVoce {
  id            Int                  @id @default(autoincrement())
  preventivoId  Int
  preventivo    RiparazionePreventivo @relation(fields: [preventivoId], references: [id], onDelete: Cascade)
  tipo          String
  descrizione   String
  articoloId    Int?
  quantita      Int
  prezzoUnitario Float
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@index([preventivoId])
}

model RiparazioneRicambio {
  id            Int         @id @default(autoincrement())
  riparazioneId Int
  riparazione   Riparazione @relation(fields: [riparazioneId], references: [id])
  articoloId    Int?
  articolo      Articolo?   @relation(fields: [articoloId], references: [id])
  codiceArticolo String
  descrizione   String
  quantita      Int
  prezzoUnitario Float
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([riparazioneId])
  @@index([articoloId])
}
