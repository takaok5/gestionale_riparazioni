# Step 10: Merge to Main

## GOAL

Merge the worktree into main with conflict resolution handled by Claude.

## CONTEXT LOADING

```yaml
load: [] # No context needed, git operations only
```

## EXECUTION

### 1. Pre-merge check

```bash
# Ensure we are in the worktree
BRANCH=$(git branch --show-current)
if [[ ! "$BRANCH" == story/* ]]; then
  echo "ERROR: Not in a story/* worktree"
  exit 1
fi
```

### 2. Fetch and rebase on main

```bash
echo "Fetching latest main..."
git fetch origin main

echo "Rebasing on main..."
git rebase origin/main
```

**If rebase fails with conflicts -> CONFLICT RESOLUTION section**

### 3. Re-run gate pre-merge

```bash
# After rebase, re-verify everything
npm run typecheck || exit 1
npm run lint || exit 1
npm run build || exit 1
npm test -- --run || exit 1
```

---

## BLOCKING GATE (MANDATORY)

**Run BEFORE push/merge. If it fails, DO NOT proceed.**

```bash
#!/bin/bash
set -e

echo "=== GATE: PRE-MERGE ==="

# 1. Branch is story/*
BRANCH=$(git branch --show-current)
if [[ ! "$BRANCH" == story/* ]]; then
  echo "GATE FAIL: Not on a story/* branch"
  exit 1
fi
echo "✓ Branch: $BRANCH"

# 2. No uncommitted files
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "GATE FAIL: Uncommitted changes detected"
  git status --short
  exit 1
fi
echo "✓ Working tree clean"

# 3. Up to date with origin/main
git fetch origin main
BEHIND=$(git rev-list --count HEAD..origin/main)
if [ "$BEHIND" -gt 0 ]; then
  echo "GATE FAIL: Branch is $BEHIND commits behind origin/main"
  echo "Run: git rebase origin/main"
  exit 1
fi
echo "✓ Up to date with origin/main"

# 4. All tests pass (post-rebase)
npm test -- --run || { echo "GATE FAIL: Tests fail post-rebase"; exit 1; }
echo "✓ Tests pass"

# 5. No secrets in diff
if git diff origin/main..HEAD | grep -iE "(password|secret|api[._]?key|token|credential).*=.*['\"]"; then
  echo "GATE FAIL: Possible secrets in diff"
  exit 1
fi
echo "✓ No secrets detected"

echo "=== GATE PASS: READY TO MERGE ==="
```

### If GATE FAIL:

1. Read the specific error
2. Go back and fix:
   - "Not on a story/* branch" -> Verify you are in the correct worktree
   - "Uncommitted changes" -> `git add` and `git commit` pending files
   - "Behind origin/main" -> `git rebase origin/main`
   - "Tests fail" -> Fix and re-test
   - "Secrets" -> Remove credentials from code
3. **Re-run the GATE** after fixing

---

## POST-GATE: Push, PR, Merge

**Run ONLY after the GATE has passed.**

### 4. Push branch

```bash
git push -u origin "$BRANCH" --force-with-lease
```

### 5. Create PR (optional, for audit trail)

```bash
gh pr create \
  --title "feat(${STORY_ID}): $(head -1 docs/stories/*.story.md | grep title | cut -d: -f2)" \
  --body "## Story ${STORY_ID}

### Changes
$(git log origin/main..HEAD --oneline)

### Tests
All tests passing (gate verified)

---
Auto-generated by story-pipeline-v2" \
  --base main
```

### 6. Merge

```bash
# Save main repo path AND current worktree path
REPO_ROOT=$(git worktree list | head -1 | awk '{print $1}')
WORKTREE_PATH=$(pwd)

# Go to main repo (checkout main fails from worktree because main is already checked out there)
cd "$REPO_ROOT"
git checkout main
git pull origin main
git merge "$BRANCH" --ff-only || git merge "$BRANCH" --no-ff -m "Merge $BRANCH"
git push origin main
```

### 7. Cleanup worktree

```bash
# Ensure we are in the main repo (not in the worktree being removed)
cd "$REPO_ROOT"

# Remove worktree using PATH (not branch name)
git worktree remove "$WORKTREE_PATH" --force

# Remove local branch
git branch -d "$BRANCH"

# Notify SFT (optional, ignore error if SFT is not running)
curl -s -X DELETE "http://localhost:5321/api/worktrees/${STORY_ID}" || true
```

---

## CONFLICT RESOLUTION

If `git rebase` fails with conflicts:

### 1. Identify conflicts

```bash
git diff --name-only --diff-filter=U
```

### 2. For each conflicted file

```bash
# Show the conflict
git diff "$FILE"

# Claude resolves:
# - Read both versions
# - Pick the correct solution
# - If both needed, combine them
# - Remove markers <<<<< ===== >>>>>
```

### 3. After resolution

```bash
git add "$FILE"
git rebase --continue
```

### 4. If too complex

```bash
git rebase --abort
echo "Conflict too complex - requires human intervention"
exit 1
```

---

## CONTEXT CHECK (Rule 6)

If session context exceeds 50%:
1. **DO NOT interrupt** - save state to `docs/sprint-artifacts/pipeline-state-{story_id}.yaml`
2. Write HANDOFF with: current step, completed steps, next action
3. The conversation will be auto-compacted. After compact, RE-READ state file + current step and resume

---

## OUTPUT

If GATE PASS and merge completed:

```
✓ Merge completed
✓ Worktree removed
✓ Branch deleted
→ Story ${STORY_ID} completed
```

If GATE FAIL:

```
✗ STOP - Resolve before merging:
  - Conflicts: git rebase origin/main
  - Test fail: npm test -- --run
  - Secrets: remove credentials
```

## MANDATORY CHECKLIST (DO NOT SKIP)

Before declaring the story complete, you MUST have done ALL of these:

```
□ In the correct worktree (branch story/*)
□ git fetch origin main executed
□ git rebase origin/main completed (or conflicts resolved)
□ npm run typecheck PASSES (post-rebase)
□ npm run lint PASSES (post-rebase)
□ npm run build PASSES (post-rebase)
□ npm test -- --run PASSES (post-rebase)
□ Working tree clean (no uncommitted changes)
□ No secrets in diff
□ Pre-merge gate executed - PASSES
□ git push completed
□ Merge to main completed
□ Worktree removed
```

**If even ONE of these is not done -> DO NOT proceed.**

## FORBIDDEN ANTI-PATTERNS

- ❌ Merge without rebase on latest main
- ❌ Force push to main
- ❌ Skip tests after rebase
- ❌ Leave orphan worktree
- ❌ Merge with unresolved conflicts
