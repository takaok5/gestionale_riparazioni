---
status: ready-for-dev
priority: medium
estimate: M
story_id: "2.4"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.4: Creazione Fornitore

**As an** Admin, **I want** to create a new supplier record with validated data, **so that** I can manage supplier relationships.

## Dependencies

- none

## Acceptance Criteria

### AC-1
**Given** sono autenticato come `ADMIN` (token access valido), non esistono fornitori creati nel dataset del test corrente e invio `POST /api/fornitori` con payload `{ nome: "Ricambi SRL", categoria: "RICAMBI", partitaIva: "12345678901", telefono: "0612345678", email: "info@ricambi.it", indirizzo: "Via Milano 10", cap: "20100", citta: "Milano", provincia: "MI" }`
**When** la richiesta viene processata dal backend
**Then** ricevo `201` con body contenente `id` numerico, `codiceFornitore = "FOR-000001"` e `categoria = "RICAMBI"`
Source: Derived from epic-details AC-1

### AC-2
**Given** sono autenticato come `ADMIN` e invio `POST /api/fornitori` con payload `{ nome: "Assistenza Roma", categoria: "SERVIZI", partitaIva: "98765432109", telefono: "0698765432", email: "supporto@assistenza.it", indirizzo: "Via Appia 22", cap: "00181", citta: "Roma", provincia: "RM" }`
**When** la richiesta viene processata dal backend
**Then** ricevo `201` e il body contiene `categoria = "SERVIZI"` e un `codiceFornitore` con prefisso `FOR-`
Source: Derived from epic-details AC-2

### AC-3
**Given** sono autenticato come `ADMIN` e invio `POST /api/fornitori` con payload valido tranne `partitaIva = "123"`
**When** la richiesta viene validata dal backend
**Then** ricevo `400` con errore `{ error: { code: "VALIDATION_ERROR", message: "P.IVA must be 11 digits", details: { field: "partitaIva" } } }`
Source: Derived from epic-details AC-3

### AC-4
**Given** esiste gia un fornitore con `partitaIva = "11111111111"` e invio un nuovo `POST /api/fornitori` con la stessa partita IVA
**When** la richiesta viene processata dal backend
**Then** ricevo `409` con errore `{ error: { code: "PARTITA_IVA_EXISTS" } }`
Source: Derived from epic-details AC-4

### AC-5
**Given** sono autenticato come `TECNICO` (token access valido)
**When** invio `POST /api/fornitori` con un payload fornitore valido
**Then** ricevo `403` con errore `{ error: { code: "FORBIDDEN", message: "Accesso negato" } }`
Source: Derived from epic-details AC-5

## Target Modules

- `packages/backend/src/routes/fornitori.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/backend/src/__tests__/fornitori-create-atdd.spec.ts`
- `packages/backend/src/__tests__/audit-trail.spec.ts`
- `packages/shared/src/validators/index.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4, AC-5): estendere `packages/backend/src/routes/fornitori.ts` con endpoint `POST /` usando `authenticate + authorize("ADMIN")`, payload tipizzato e risposta `201`.
- [x] Task 2 (AC-3, AC-4): aggiungere in `packages/backend/src/routes/fornitori.ts` il mapping errori dominio `VALIDATION_ERROR -> 400` e `PARTITA_IVA_EXISTS -> 409` con `buildErrorResponse`.
- [x] Task 3 (AC-1, AC-2, AC-3, AC-4): introdurre in `packages/backend/src/services/anagrafiche-service.ts` i tipi `CreateFornitoreInput`/`CreateFornitoreResult` e parser con validazioni su campi obbligatori, categoria e partita IVA.
- [x] Task 4 (AC-1, AC-2, AC-4): implementare in `packages/backend/src/services/anagrafiche-service.ts` `createFornitoreInTestStore` con generazione `codiceFornitore` progressivo `FOR-NNNNNN` e controllo duplicato `partitaIva`.
- [x] Task 5 (AC-1, AC-2, AC-4): implementare in `packages/backend/src/services/anagrafiche-service.ts` `createFornitoreInDatabase` con transaction Prisma, inserimento fornitore, audit `CREATE` e gestione conflitti unici.
- [x] Task 6 (AC-4): aggiornare `packages/backend/prisma/schema.prisma` per garantire univocita su `Fornitore.partitaIva` (vincolo o strategia equivalente robusta per `409` deterministico).
- [x] Task 7 (AC-1, AC-2, AC-3, AC-4, AC-5): creare `packages/backend/src/__tests__/fornitori-create-atdd.spec.ts` con casi RED per successo `RICAMBI`/`SERVIZI`, validazione `partitaIva`, duplicato `partitaIva` e blocco ruolo `TECNICO`.
- [x] Task 8 (AC-1): estendere `packages/backend/src/__tests__/audit-trail.spec.ts` per verificare audit `CREATE` su modello `Fornitore` con `action`, `modelName`, `objectId`.
- [x] Task 9 (AC-3): implementare una regola unica di validazione `partitaIva` tra `packages/backend/src/services/anagrafiche-service.ts` e `packages/shared/src/validators/index.ts`, con test espliciti sull'errore atteso.

## Implementation Notes

- AC e dipendenze derivano da `docs/epics/epic-2-anagrafiche.md` (Story 2.4).
- Moduli target, rischi e pattern derivano da `docs/sprint-artifacts/story-brief-2.4.yaml`.
- Pattern principali da seguire: route POST in `packages/backend/src/routes/clienti.ts:234`, mapping errori in `packages/backend/src/routes/clienti.ts:33`, RBAC in `packages/backend/src/middleware/auth.ts:106`, create transaction con audit in `packages/backend/src/services/anagrafiche-service.ts:1134`.

## Validation Fixes Applied

1. Problema: AC-1 non fissava il pre-requisito della sequenza codice, quindi `FOR-000001` non era deterministicamente verificabile.
   Fix: aggiunto pre-requisito esplicito "nessun fornitore creato nel dataset del test corrente".

2. Problema: AC-2 conteneva testo vago ("campi obbligatori valorizzati") non traducibile in assert ripetibili.
   Fix: sostituito con payload completo e valori concreti.

3. Problema: AC-3 non includeva il messaggio errore richiesto da epic-details, quindi il Then non copriva completamente il requisito.
   Fix: aggiunto `message: "P.IVA must be 11 digits"` nel Then insieme a `details.field`.

4. Problema: il file conteneva caratteri di controllo e riferimenti path non formattati, rendendo alcune task ambigue/non testabili.
   Fix: ripulito il markdown e resi espliciti path/API con backtick, inclusa Task 9 resa operativa.
