---
status: drafted
priority: high
estimate: M
story_id: "8.4"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.4: Lista e Dettaglio Ordini Cliente

**As a** Cliente, **I want** to view my orders and their status, **so that** I can track progress without calling support.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** customer `id=5` has `12` ordini visibili nel portale e almeno `10` risultati nella prima pagina
**When** the customer sends `GET /api/portal/ordini?page=1&limit=10` with a valid portal Bearer token
**Then** the API returns HTTP `200` with exactly `10` items in `data` and pagination metadata containing `page=1`, `limit=10`, `total=12`, and `totalPages=2`

### AC-2
_Derived from epic-details AC-2._
**Given** customer `id=5` has ordini in stati `IN_ATTESA` and `IN_LAVORAZIONE`
**When** the customer sends `GET /api/portal/ordini?stato=IN_LAVORAZIONE` with a valid portal Bearer token
**Then** the API returns HTTP `200`, `data.length >= 1`, every item in `data` has `stato="IN_LAVORAZIONE"`, and `meta.total >= data.length`

### AC-3
_Derived from epic-details AC-3._
**Given** ordine `id=20` belongs to the authenticated customer and has stato history, preventivi importi, and at least one linked document reference
**When** the customer sends `GET /api/portal/ordini/20` with a valid portal Bearer token
**Then** the API returns HTTP `200` with `data.id=20`, `data.stato` as non-empty string, `data.importi` object with numeric keys `totalePreventivi`, `totalePagato`, `saldoResiduo`, `data.timeline` array with entries `{ stato, dataOra }`, and `data.documentiCollegati` array with entries `{ tipo, riferimentoId }`

### AC-4
_Derived from epic-details AC-4._
**Given** ordine `id=20` belongs to another customer
**When** the authenticated customer sends `GET /api/portal/ordini/20`
**Then** the API returns HTTP `403` with `error.code="FORBIDDEN"`

## Target Modules

- `packages/backend/src/index.ts`
- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/src/__tests__/portal-dashboard-me.atdd.spec.ts`
- `packages/backend/src/__tests__/portal-auth-login-refresh-logout.atdd.spec.ts`
- `packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-4): aggiungere in `packages/backend/src/routes/auth.ts` gli endpoint `GET /api/portal/ordini` e `GET /api/portal/ordini/:id`, riusando il controllo Bearer token e la mappatura errori (`401`, `403`, `500`) coerente con le route portale esistenti.
- [x] Task 2 (AC-1, AC-2): estendere `packages/backend/src/services/auth-service.ts` con un use case di lista ordini portale che risolve `clienteId` dal token, applica filtro `stato`, pagina `page/limit`, e ritorna `meta` deterministica.
- [x] Task 3 (AC-3, AC-4): estendere `packages/backend/src/services/auth-service.ts` con use case dettaglio ordine portale che verifica ownership cliente prima di restituire dati dettaglio e ritorna `FORBIDDEN` in caso di mismatch.
- [x] Task 4 (AC-1, AC-2): implementare filtro `clienteId` direttamente in `packages/backend/src/services/riparazioni-service.ts` (invece di `anagrafiche-service.ts`) per garantire paginazione coerente e retrocompatibilita' dei chiamanti esistenti.
- [x] Task 5 (AC-3): riusare/integrare `packages/backend/src/services/riparazioni-service.ts` per comporre un dettaglio ordine che esponga `stato`, blocco `importi`, `timeline` e riferimenti a documenti collegati.
- [x] Task 6 (AC-1..AC-4): aggiungere test ATDD in `packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts` coprendo pagina/limit, filtro stato, dettaglio autorizzato e risposta `403 FORBIDDEN` su ordine di altro cliente.

## Step 4 Validation Fixes

- Issue 1: AC-2 era passabile con lista vuota (assert "tutti gli elementi hanno stato X" vacua) e non garantiva reale copertura del filtro.
  Fix: AC-2 ora richiede `data.length >= 1` e coerenza minima della paginazione con `meta.total >= data.length`.
- Issue 2: AC-3 descriveva campi macro (`importi`, `timeline`, `documentiCollegati`) senza shape verificabile in test.
  Fix: AC-3 ora specifica chiavi e tipi minimi attesi (`totalePreventivi`, `totalePagato`, `saldoResiduo`, entries timeline/documenti).
- Issue 3: Task 4 conteneva ambiguita' implementativa (`o adapter equivalente`), riducendo tracciabilita' tra AC e file da modificare.
  Fix: Task 4 ora vincola il lavoro a `anagrafiche-service.ts` con input espliciti (`clienteId`, `page`, `limit`, `stato`) e vincolo di backward compatibility su `listClienteRiparazioni`.

## Deviazioni Piano Step 7

- Il filtro cliente/paginazione e' stato implementato in `packages/backend/src/services/riparazioni-service.ts` anziche' in `packages/backend/src/services/anagrafiche-service.ts`, per allineare il datasource agli ATDD creati in RED phase (`createRiparazione` su store riparazioni) mantenendo invariato il contratto di `listClienteRiparazioni`.
