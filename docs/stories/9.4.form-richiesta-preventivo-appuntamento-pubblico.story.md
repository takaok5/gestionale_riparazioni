---
status: drafted
priority: medium
estimate: M
story_id: "9.4"
epic: "Epic 9 - Vetrina Pubblica e Lead Capture"
---

# Story 9.4: Form Richiesta Preventivo/Appuntamento Pubblico

**As a** Visitor, **I want** to submit a quote or appointment request online, **so that** I can be contacted by the workshop.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** an anonymous visitor submits `POST /api/public/richieste` with payload `{ "tipo": "PREVENTIVO", "nome": "Mario Rossi", "email": "mario@test.it", "problema": "Display rotto", "consensoPrivacy": true }`
**When** backend validation passes and the request is persisted as a new public lead
**Then** the API responds with HTTP `201` and body `{ "data": { "ticketId": "LEAD-20260210-0001" } }` with no `error` field

### AC-2
_Derived from epic-details AC-2._
**Given** an anonymous visitor submits `POST /api/public/richieste` with `consensoPrivacy=false` or without `consensoPrivacy`
**When** the payload is validated by the public-request input parser
**Then** the API responds with HTTP `400` and `error.code="VALIDATION_ERROR"` indicating `consensoPrivacy` is mandatory and must be `true`

### AC-3
_Derived from epic-details AC-3._
**Given** six `POST /api/public/richieste` attempts are sent from the same IP `203.0.113.44` within `60` seconds and the policy allows at most `5` attempts per window
**When** the public request endpoint evaluates rate-limit state for that IP
**Then** the sixth request responds with HTTP `429`, includes `Retry-After` header with integer seconds, and returns `error.code="RATE_LIMIT_EXCEEDED"`

### AC-4
_Derived from epic-details AC-4._
**Given** an anonymous visitor submits `POST /api/public/richieste` with payload `{ "tipo": "PREVENTIVO", "nome": "Mario Rossi", "email": "mario@test.it", "problema": "Display rotto", "consensoPrivacy": true, "antispamToken": "invalid-token" }`
**When** anti-spam verification rejects the token before persistence
**Then** the API responds with HTTP `400` and `error.code="INVALID_ANTISPAM_TOKEN"` without creating a ticketId

## Target Modules

- `packages/backend/src/routes/public.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/services/login-rate-limit.ts`
- `packages/backend/src/__tests__/public-richieste-api.atdd.spec.ts`
- `packages/frontend/src/App.tsx`
- `packages/frontend/src/__tests__/public-home-vetrina.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-4): extend `packages/backend/src/services/anagrafiche-service.ts` with a dedicated parser/use-case for public lead creation (`tipo`, `nome`, `email`, `problema`, `consensoPrivacy`, `antispamToken`) and deterministic domain failure codes.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): add `POST /richieste` handler to `packages/backend/src/routes/public.ts` with status mapping `201/400/429/500` using `buildErrorResponse` and stable success payload shape containing `ticketId`.
- [x] Task 3 (AC-3): reuse/adapt IP throttling logic from `packages/backend/src/services/login-rate-limit.ts` for public requests and expose reset hooks needed by tests.
- [x] Task 4 (AC-1, AC-2, AC-3, AC-4): create backend ATDD in `packages/backend/src/__tests__/public-richieste-api.atdd.spec.ts` covering valid create, `consensoPrivacy=false`, missing `consensoPrivacy`, anti-spam failure, and per-IP `429` throttling behavior.
- [x] Task 5 (AC-1): update public CTA flow in `packages/frontend/src/App.tsx` and assertions in `packages/frontend/src/__tests__/public-home-vetrina.atdd.spec.ts` so `/richiedi-preventivo` exposes the request form entry point aligned with backend contract.
- [x] Task 6 (AC-1): ensure deterministic `ticketId` generation (`LEAD-YYYYMMDD-####`) in `packages/backend/src/services/anagrafiche-service.ts` with sequence behavior testable under concurrent requests.
