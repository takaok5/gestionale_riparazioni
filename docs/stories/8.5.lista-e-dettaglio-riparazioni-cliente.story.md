---
status: drafted
priority: high
estimate: M
story_id: "8.5"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.5: Lista e Dettaglio Riparazioni Cliente

**As a** Cliente, **I want** to view my repairs with status history, **so that** I can follow every step of the repair process.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** customer `id=5` has exactly `3` riparazioni visibili nel portale with current `stato` and basic device fields (`tipoDispositivo`, `marcaDispositivo`, `modelloDispositivo`)
**When** the customer sends `GET /api/portal/riparazioni` with a valid portal Bearer token linked to `clienteId=5`
**Then** the API returns HTTP `200` with `data.length=3`, each item exposes a non-empty `stato`, and each item includes non-empty `tipoDispositivo`, `marcaDispositivo`, and `modelloDispositivo`

### AC-2
_Derived from epic-details AC-2._
**Given** customer `id=5` has riparazioni in stati `IN_DIAGNOSI` and `COMPLETATA`
**When** the customer sends `GET /api/portal/riparazioni?stato=IN_DIAGNOSI` with a valid portal Bearer token
**Then** the API returns HTTP `200`, `data.length >= 1`, every `data[].stato` equals `IN_DIAGNOSI`, and pagination metadata is coherent with the filtered list (`meta.total >= data.length`, `meta.page >= 1`, `meta.limit >= 1`)

### AC-3
_Derived from epic-details AC-3._
**Given** riparazione `id=10` belongs to the authenticated customer and has state history plus linked quote/invoice references
**When** the customer sends `GET /api/portal/riparazioni/10` with a valid portal Bearer token
**Then** the API returns HTTP `200` with `data.id=10`, `data.timeline` as an array of entries `{ stato: string, dataOra: ISO-8601 string }`, and `data.documentiCollegati` as an array of entries `{ tipo: "PREVENTIVO" | "FATTURA", riferimentoId: number }`

### AC-4
_Derived from epic-details AC-4._
**Given** riparazione `id=10` belongs to another customer
**When** an authenticated customer sends `GET /api/portal/riparazioni/10`
**Then** the API returns HTTP `403` with `error.code="FORBIDDEN"` and no detail payload (`data` absent or null)

## Target Modules

- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/src/index.ts`
- `packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts`
- `packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts`
- `packages/backend/src/__tests__/portal-riparazioni-list-detail.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2): add `GET /api/portal/riparazioni` in `packages/backend/src/routes/auth.ts`, reusing the existing Bearer guard/error mapping pattern used by `GET /api/portal/ordini` (`401/400/500`).
- [x] Task 2 (AC-1, AC-2): implement `listPortalRiparazioni` in `packages/backend/src/services/auth-service.ts` resolving `clienteId` from the portal access token and delegating filtering/pagination to `listRiparazioni`.
- [x] Task 3 (AC-3, AC-4): add `GET /api/portal/riparazioni/:id` in `packages/backend/src/routes/auth.ts` and map service failures so ownership mismatch returns `403 FORBIDDEN`.
- [x] Task 4 (AC-3, AC-4): implement `getPortalRiparazioneDettaglio` in `packages/backend/src/services/auth-service.ts` with ownership check (`dettaglio.cliente.id === clienteId`) before returning timeline/document references.
- [x] Task 5 (AC-3): extend/reuse `packages/backend/src/services/riparazioni-service.ts` output mapping so detail payload can expose timeline entries and linked document references with deterministic shape.
- [x] Task 6 (AC-1..AC-4): create `packages/backend/src/__tests__/portal-riparazioni-list-detail.atdd.spec.ts` covering list base case, stato filter, authorized detail `200`, and forbidden detail `403`.

## Step 4 Validation Fixes

- Issue 1: YAML frontmatter was syntactically invalid (`story_id`/`epic` escaped and broken), making metadata non-parseable.
  Fix: restored valid YAML frontmatter with explicit `story_id: "8.5"` and `epic: "Epic 8 - Portale Cliente"`.
- Issue 2: AC-3 contained corrupted tokens and an undefined document schema, so it was not directly testable with `expect()`.
  Fix: defined explicit response shape for `timeline` and `documentiCollegati` including types and required keys.
- Issue 3: AC-4 did not fully constrain the error payload and leak behavior.
  Fix: constrained failure contract to `HTTP 403` + `error.code="FORBIDDEN"` + no detail payload.
- Issue 4: task list had typos and ambiguous implementation scope (`otal`, `imeline`, unclear test target).
  Fix: rewrote tasks with explicit files, endpoint names, and AC coverage mapping.

## Deviazioni Piano Step 7

- Task 5 non ha richiesto modifiche a `packages/backend/src/services/riparazioni-service.ts`: la shape dettaglio necessaria (`timeline` e `documentiCollegati`) era gia' riusabile dal flusso esistente; e' stato sufficiente adattare `auth-service`/route portale.
