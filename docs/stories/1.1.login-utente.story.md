---
status: ready-for-dev
priority: high
estimate: M
story_id: "1.1"
epic: "Epic 1 - Autenticazione e Gestione Utenti"
---

# Story 1.1: Login Utente

**As a** Tecnico, **I want** to log in with my credentials, **so that** I can access the system with my role permissions.

## Acceptance Criteria

### AC-1
**Given** a user with username "mario.rossi" and password "Password1" exists  
**When** I POST `/api/auth/login` with those credentials  
**Then** I receive `200` with `accessToken` (JWT 15min), `refreshToken` (7d), and `user` `{ id, username, email, role }`

### AC-2
**Given** no user with username "utente.inesistente" exists and the login payload includes password "Password1"  
**When** I POST `/api/auth/login`  
**Then** I receive `401` with error code `INVALID_CREDENTIALS`

### AC-3
**Given** a user with username "mario.disabilitato", password "Password1", and `isActive=false` exists  
**When** I POST `/api/auth/login` with that username and password  
**Then** I receive `401` with error code `ACCOUNT_DISABLED`

### AC-4
**Given** 5 failed login attempts from same IP in 1 minute  
**When** I attempt a 6th login  
**Then** I receive `429` with `retryAfter` header containing an integer number of seconds in range `1..60`

## Target Modules

- `packages/backend/src/index.ts`
- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/login-rate-limit.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/shared/src/types/index.ts`
- `packages/backend/src/__tests__/auth-login.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3): create `packages/backend/src/routes/auth.ts` with `POST /login` handler, request parsing, and explicit error mapping for invalid credentials and disabled accounts.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): update `packages/backend/src/index.ts` to register `authRouter` at `/api/auth` with middleware order consistent with existing app initialization.
- [x] Task 3 (AC-1, AC-2, AC-3): add `packages/backend/src/services/auth-service.ts` for credential verification, `isActive` checks, and token payload composition.
- [x] Task 4 (AC-1, AC-3): update `packages/backend/prisma/schema.prisma` to support disabled-account state (`isActive`) and prepare migration for existing users.
- [x] Task 5 (AC-1): extend token utilities in `packages/backend/src/middleware/auth.ts` to issue `accessToken` (15 minutes) and `refreshToken` (7 days) for successful login.
- [x] Task 6 (AC-4): add `packages/backend/src/services/login-rate-limit.ts` with per-IP failed-attempt tracking (5 attempts/60s) and `retryAfter` header in seconds.
- [x] Task 7 (AC-1): update `packages/shared/src/types/index.ts` with typed login success response `{ accessToken, refreshToken, user: { id, username, email, role } }`.
- [x] Task 8 (AC-1, AC-2, AC-3, AC-4): add `packages/backend/src/__tests__/auth-login.spec.ts` with API tests for success, invalid username, disabled account, and rate-limit behavior including `retryAfter` range validation.

## Implementation Notes

- Deviation from initial plan documented: added workspace-local Vitest configs in `packages/backend/vitest.config.ts`, `packages/frontend/vitest.config.ts`, and `packages/shared/vitest.config.ts` to ensure backend ATDD tests are discoverable while keeping zero-test workspaces non-blocking.
