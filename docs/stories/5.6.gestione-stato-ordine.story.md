---
story_id: "5.6"
title: "Gestione Stato Ordine"
status: "draft"
priority: "high"
estimate: "M"
---

# Story 5.6: Gestione Stato Ordine

## Story

As an Admin, I want to track order status through its lifecycle, so that I know order progress.

## Acceptance Criteria

### AC-1 - BOZZA -> EMESSO imposta dataEmissione
**Given** utente autenticato con ruolo `ADMIN`, ordine `id=12` in stato `BOZZA`, e `dataEmissione = null`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "EMESSO" }`.
**Then** ricevo `200`, `response.body.data.stato = "EMESSO"` e `response.body.data.dataEmissione` e' valorizzata in formato ISO.

### AC-2 - EMESSO -> CONFERMATO
**Given** utente autenticato con ruolo `ADMIN` e ordine `id=12` in stato `EMESSO`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "CONFERMATO" }`.
**Then** ricevo `200` e `response.body.data.stato = "CONFERMATO"`.

### AC-3 - CONFERMATO -> SPEDITO
**Given** utente autenticato con ruolo `ADMIN` e ordine `id=12` in stato `CONFERMATO`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "SPEDITO" }`.
**Then** ricevo `200` e `response.body.data.stato = "SPEDITO"`.

### AC-4 - SPEDITO -> RICEVUTO imposta dataRicezione
**Given** utente autenticato con ruolo `ADMIN`, ordine `id=12` in stato `SPEDITO`, e `dataRicezione = null`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "RICEVUTO" }`.
**Then** ricevo `200`, `response.body.data.stato = "RICEVUTO"` e `response.body.data.dataRicezione` e' valorizzata in formato ISO.

### AC-5 - BOZZA -> ANNULLATO
**Given** utente autenticato con ruolo `ADMIN` e ordine `id=12` in stato `BOZZA`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "ANNULLATO" }`.
**Then** ricevo `200` e `response.body.data.stato = "ANNULLATO"`.

### AC-6 - Override Admin: CONFERMATO -> ANNULLATO
**Given** utente autenticato con ruolo `ADMIN` e ordine `id=12` in stato `CONFERMATO`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "ANNULLATO" }`.
**Then** ricevo `200` e `response.body.data.stato = "ANNULLATO"`.

### AC-7 - Blocco annullamento da SPEDITO per non Admin
**Given** utente autenticato con ruolo `COMMERCIALE` (non `ADMIN`) e ordine `id=12` in stato `SPEDITO`.
**When** invoco `PATCH /api/ordini/12/stato` con payload `{ stato: "ANNULLATO" }`.
**Then** ricevo `400`, `response.body.error.code = "VALIDATION_ERROR"`, `response.body.error.message = "Cannot cancel order in SPEDITO state"`, e lo stato ordine resta `SPEDITO`.

## AC Source Mapping

- AC-1: Derived from epic-details AC-1.
- AC-2: Derived from epic-details AC-2.
- AC-3: Derived from epic-details AC-3.
- AC-4: Derived from epic-details AC-4.
- AC-5: Derived from epic-details AC-5.
- AC-6: Derived from epic-details AC-6.
- AC-7: Derived from epic-details AC-7.

## Task Breakdown

- [x] API routing: estendere `packages/backend/src/routes/ordini.ts` con endpoint `PATCH /:id/stato`, parsing `id` + body `{ stato }`, actor context da `req.user` e mapping errori dominio su `buildErrorResponse`.
- [x] Service contract: estendere `packages/backend/src/services/anagrafiche-service.ts` con input/result type per cambio stato ordine (codici: `VALIDATION_ERROR`, `ORDINE_NOT_FOUND`, `SERVICE_UNAVAILABLE`).
- [x] Service implementation test-store: implementare transizioni e guardie ruolo in `packages/backend/src/services/anagrafiche-service.ts` su `testFornitoreOrdini`, con set timestamp `dataEmissione` e `dataRicezione` dove richiesto.
- [x] Service implementation database: implementare aggiornamento stato su Prisma in `packages/backend/src/services/anagrafiche-service.ts` con stesse regole delle transizioni test-store.
- [x] Data model: aggiornare `packages/backend/prisma/schema.prisma` per persistenza campi temporali necessari agli AC (`dataEmissione`, `dataRicezione`) su `OrdineFornitore`.
- [x] Test fixtures: allineare `resetAnagraficheStoreForTests` e fixture ordine in `packages/backend/src/services/anagrafiche-service.ts` per coprire stati iniziali BOZZA, EMESSO, CONFERMATO, SPEDITO.
- [x] ATDD: coprire scenari AC-1..AC-7 in `packages/backend/src/__tests__/ordini-stato-atdd.spec.ts` per `PATCH /api/ordini/:id/stato`, assert su HTTP code, stato risultante, messaggi errore e timestamp.
- [x] Failure invariants: negli ATDD verificare esplicitamente che, nei path di errore (es. AC-7), uno step di dettaglio successivo confermi stato invariato (`SPEDITO`).
- [x] Regression: rieseguire suite ordini e suite dipendenti da anagrafiche (`packages/backend/src/__tests__/fornitori-detail-update-atdd.spec.ts`) per verificare assenza regressioni.

## Task-to-AC Coverage

- AC-1 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, Data model, ATDD.
- AC-2 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD.
- AC-3 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD.
- AC-4 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, Data model, ATDD.
- AC-5 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD.
- AC-6 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD.
- AC-7 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD.
- AC-7 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD, Failure invariants.

## Dependencies

- Story 5.5 completata (creazione ordine e struttura base dominio ordini).

## Notes for Implementation

- Riutilizzare pattern di validazione transizioni gia' presenti in `riparazioni-service` per mantenere messaggi errore deterministici.
- L'endpoint `PATCH /api/ordini/:id/stato` deve essere protetto con `authenticate` (non `authorize("ADMIN")`) per permettere il controllo dominio su AC-7.
- Mantenere equivalenza regole tra test-store e database per evitare falsi verdi nei test.
- Preservare formato risposta errore standard `{ error: { code, message } }`.
