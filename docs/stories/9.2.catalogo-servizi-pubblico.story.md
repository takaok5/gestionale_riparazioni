---
status: drafted
priority: high
estimate: M
story_id: "9.2"
epic: "Epic 9 - Vetrina Pubblica e Lead Capture"
---

# Story 9.2: Catalogo Servizi Pubblico

**As a** Visitor, **I want** to browse available repair services, **so that** I can understand price ranges and expected times.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** the catalog contains 8 services with `attivo=true` and each record includes `slug`, `title`, `summary`, `priceFrom`, and `averageDuration`
**When** an anonymous user sends `GET /api/public/services`
**Then** the API returns HTTP 200 with body `{ "data": [...] }`, `data.length=8`, and each item includes `slug`, `title`, `summary`, `priceFrom`, and `averageDuration`

### AC-2
_Derived from epic-details AC-2._
**Given** the public catalog contains services in categories `smartphone` and `laptop`
**When** an anonymous user sends `GET /api/public/services?categoria=smartphone`
**Then** the API returns HTTP 200 with body `{ "data": [...] }` where every item has `categoria="smartphone"` and no `laptop` items are present

### AC-3
_Derived from epic-details AC-3._
**Given** a public service with slug `sostituzione-display` exists and is active
**When** the visitor opens `/servizi/sostituzione-display` and the detail flow requests `GET /api/public/services/sostituzione-display`
**Then** the backend returns HTTP 200 with `{ "data": { "slug": "sostituzione-display", "title", "summary", "description", "priceFrom", "averageDuration", "categoria" } }` and the page renders title plus full description

### AC-4
_Derived from epic-details AC-4._
**Given** a service exists with slug `riparazione-legacy` and is marked `attivo=false`
**When** the visitor requests `GET /api/public/services/riparazione-legacy`
**Then** the API returns HTTP 404 with `error.code="SERVICE_NOT_FOUND"` and does not expose any service detail payload

## Target Modules

- `packages/backend/prisma/schema.prisma`
- `packages/backend/src/index.ts`
- `packages/backend/src/routes/public.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/routes/fornitori.ts` (pattern reference for list/filter response mapping)
- `packages/frontend/src/App.tsx`
- `packages/frontend/src/main.tsx`
- `gestionale_riparazioni/urls.py`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-4): define and persist a public service catalog entity with fields `slug`, `title`, `summary`, `priceFrom`, `averageDuration`, `categoria`, `attivo` in `packages/backend/prisma/schema.prisma`, then expose test fixtures in `packages/backend/src/services/anagrafiche-service.ts`.
- [x] Task 2 (AC-1, AC-2): implement public list use-case in `packages/backend/src/services/anagrafiche-service.ts` with category filter validation and stable response shape for `GET /api/public/services`.
- [x] Task 3 (AC-1, AC-2, AC-3, AC-4): create unauthenticated public routes in `packages/backend/src/routes/public.ts` for list (`GET /api/public/services`) and detail (`GET /api/public/services/:slug`), then mount the router in `packages/backend/src/index.ts`.
- [x] Task 4 (AC-3, AC-4): implement service-detail lookup by slug in `packages/backend/src/services/anagrafiche-service.ts` with `attivo=true` guard and explicit `SERVICE_NOT_FOUND` mapping in `packages/backend/src/routes/public.ts`.
- [x] Task 5 (AC-3): implement `/servizi/:slug` detail rendering in `packages/frontend/src/main.tsx` and `packages/frontend/src/App.tsx`, and align `gestionale_riparazioni/urls.py` to serve the same public detail path.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): add backend ATDD specs `packages/backend/src/__tests__/public-services-api.atdd.spec.ts` and add frontend coverage for slug detail rendering in `packages/frontend/src/__tests__/public-services-detail.atdd.spec.ts`.

## Step 4 Validation Fixes

- Issue 1: AC-1 did not define a deterministic response envelope, so test assertions could not target a stable JSON shape.
  Fix: specified HTTP 200 body structure `{ data: [...] }`, exact length, and required card fields.
- Issue 2: AC-3 mixed UI wording with no explicit detail API contract, making backend and frontend verification ambiguous.
  Fix: defined detail request path `GET /api/public/services/sostituzione-display` and concrete success payload fields rendered by the page.
- Issue 3: AC-4 did not define how 404 is represented, risking inconsistent error handling across routes.
  Fix: constrained 404 behavior to `error.code="SERVICE_NOT_FOUND"` and no detail payload leakage.
- Issue 4: Task 5 used ambiguous implementation ownership (`and/or`) across React and Django.
  Fix: made route ownership actionable by explicitly requiring React detail rendering and Django path alignment.
