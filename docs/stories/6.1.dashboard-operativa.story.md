---
status: drafted
priority: high
estimate: M
story_id: "6.1"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.1: Dashboard Operativa

**As a** user, **I want** a role-specific dashboard, **so that** I see relevant information for my work.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** I am authenticated as `ADMIN` and I call `GET /api/dashboard` with `Authorization: Bearer <admin_access_token>`
**When** the request is processed by the dashboard backend route
**Then** I receive `200` with JSON body containing all top-level keys `riparazioniPerStato`, `caricoTecnici`, `alertMagazzino`, and `ultimiPagamenti`; `riparazioniPerStato` includes numeric fields for at least `RICEVUTA`, `IN_DIAGNOSI`, `IN_LAVORAZIONE`, `COMPLETATA`; `caricoTecnici` contains items shaped as `{ tecnicoId: number, nome: string, riparazioniAttive: number }`; `alertMagazzino` is an integer; and `ultimiPagamenti` contains items shaped as `{ fatturaId: number, importo: number, data: "YYYY-MM-DD" }`

### AC-2
_Derived from epic-details AC-2._
**Given** I am authenticated as `TECNICO` with `userId=7` and I call `GET /api/dashboard`
**When** the dashboard response is generated for technician scope
**Then** I receive `200` with JSON body containing keys `mieRiparazioni` and `nextRiparazioni`, where `mieRiparazioni` has numeric counters by stato (including `IN_DIAGNOSI` and `IN_LAVORAZIONE`) and `nextRiparazioni` is an array of objects shaped as `{ id: number, codiceRiparazione: string, stato: string }`; and the keys `caricoTecnici` and `alertMagazzino` are absent

### AC-3
_Derived from epic-details AC-3._
**Given** I am authenticated as `COMMERCIALE` and I call `GET /api/dashboard`
**When** the dashboard response is generated for commercial scope
**Then** I receive `200` with JSON body containing numeric fields `clientiAttivi`, `preventiviPendenti`, `fattureNonPagate`, and `fatturato30gg`; each field is present and `>= 0`; and admin-only keys (`caricoTecnici`, `alertMagazzino`) are absent

### AC-4
_Derived from epic-details AC-4._
**Given** I call `GET /api/dashboard` without `Authorization` header
**When** authentication middleware runs before the dashboard handler
**Then** I receive `401` with error payload `{ "error": "Token mancante" }` and no dashboard metric keys are present

## Validation Fixes Applied (Step 4)

1. Fixed corrupted control characters in AC text and task list that made keys like `riparazioniPerStato` unreadable/un-testable.
2. Replaced non-deterministic AC outputs with explicit response shapes and key presence/absence rules per role.
3. Aligned unauthorized AC with current middleware contract (`401` + `{ "error": "Token mancante" }`) to avoid false test failures.

## Target Modules

- `packages/backend/src/index.ts`
- `packages/backend/src/routes/dashboard.ts` (new)
- `packages/backend/src/services/dashboard-service.ts` (new)
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts` (new)

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): create `packages/backend/src/routes/dashboard.ts` with `GET /api/dashboard`, `authenticate` middleware, and role-based response branching for `ADMIN`, `TECNICO`, `COMMERCIALE`.
- [x] Task 2 (AC-1, AC-2, AC-3): create `packages/backend/src/services/dashboard-service.ts` to aggregate dashboard metrics with Prisma queries and return typed payloads per role.
- [x] Task 3 (AC-1): in `packages/backend/src/services/dashboard-service.ts`, implement admin metrics `riparazioniPerStato`, `caricoTecnici`, `alertMagazzino`, `ultimiPagamenti`.
- [x] Task 4 (AC-2): in `packages/backend/src/services/dashboard-service.ts`, implement tecnico metrics scoped to logged user (`mieRiparazioni`, `nextRiparazioni`) and enforce absence of admin-only keys.
- [x] Task 5 (AC-3): in `packages/backend/src/services/dashboard-service.ts`, implement commerciale metrics (`clientiAttivi`, `preventiviPendenti`, `fattureNonPagate`, `fatturato30gg`) with explicit rolling 30-day UTC window.
- [x] Task 6 (AC-1, AC-2, AC-3): update `packages/backend/src/index.ts` to register `dashboardRouter` at `/api/dashboard`.
- [x] Task 7 (AC-1, AC-2, AC-3, AC-4): add `packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts` with ATDD coverage for role payloads and unauthenticated `401` behavior.
- [x] Task 8 (AC-1, AC-2, AC-3, AC-4): enforce response/error contract assertions in tests so payload keys and forbidden key absence are validated explicitly.
