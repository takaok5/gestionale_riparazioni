---
status: drafted
priority: high
estimate: S
story_id: "8.7"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.7: Download Documenti dal Portale Cliente

**As a** Cliente, **I want** to download my quote and invoice PDFs from the portal, **so that** I can archive my repair documentation.
_Scope note: epic text cites invoice/quote/receipt; this story implements invoice + quote endpoints because ACs define only those two document types._

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** fattura `id=8` belongs to the authenticated portal customer `clienteId=5` and a valid portal Bearer token is provided
**When** the customer calls `GET /api/portal/documenti/fattura/8/pdf`
**Then** the API returns HTTP `200`, header `Content-Type` contains `application/pdf`, and header `Content-Disposition` includes `filename=` ending with `.pdf` (for seeded data it matches `2026-0008-8.pdf`)

### AC-2
_Derived from epic-details AC-2._
**Given** preventivo `id=5` belongs to the authenticated portal customer `clienteId=5` and a valid portal Bearer token is provided
**When** the customer calls `GET /api/portal/documenti/preventivo/5/pdf`
**Then** the API returns HTTP `200`, header `Content-Type` contains `application/pdf`, and header `Content-Disposition` includes `filename=preventivo-5.pdf`

### AC-3
_Derived from epic-details AC-3._
**Given** requested fattura `id=8` belongs to another customer and the caller is authenticated as portal customer `clienteId=5`
**When** the caller requests `GET /api/portal/documenti/fattura/8/pdf`
**Then** the API returns HTTP `403` with `error.code="FORBIDDEN"` and no PDF bytes in response body

### AC-4
_Derived from epic-details AC-4._
**Given** no portal Bearer token is provided for a preventivo download request
**When** the caller requests `GET /api/portal/documenti/preventivo/5/pdf`
**Then** the API returns HTTP `401` with `error.code="UNAUTHORIZED"` and `error.message="Token mancante o non valido"`

## Target Modules

- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/fatture-service.ts`
- `packages/backend/src/services/preventivi-service.ts`
- `packages/backend/src/__tests__/portal-documenti-download.atdd.spec.ts`
- `packages/backend/src/__tests__/fatture-lista-dettaglio-atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): add portal endpoints `GET /api/portal/documenti/fattura/:id/pdf` and `GET /api/portal/documenti/preventivo/:id/pdf` in `packages/backend/src/routes/auth.ts` using the same bearer-token guard and portal error mapping used by existing `/api/portal/*` routes.
- [x] Task 2 (AC-1, AC-2, AC-3): add a portal document download use case in `packages/backend/src/services/auth-service.ts` that resolves customer identity from access token and enforces ownership checks before exposing PDF content.
- [x] Task 3 (AC-1): expose/reuse fattura PDF retrieval in `packages/backend/src/services/fatture-service.ts` for portal-safe download payload (`fileName`, `content`) without bypassing domain validation.
- [x] Task 4 (AC-2): expose/reuse preventivo PDF retrieval in `packages/backend/src/services/preventivi-service.ts` for portal-safe download payload (`fileName`, `content`) without bypassing ownership constraints.
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): implement ATDD coverage in `packages/backend/src/__tests__/portal-documenti-download.atdd.spec.ts` for success (fattura/preventivo), forbidden cross-customer access, and unauthenticated request behavior (`401` + `UNAUTHORIZED` code + token error message).

## Step 4 Validation Fixes

- Issue 1: AC-1/AC-2 `Then` used ambiguous wording ("matching document name"), not strictly assertable in tests.
  Fix: constrained assertions to concrete HTTP headers and deterministic filename expectations.
- Issue 2: AC-4 expected generic "Unauthorized" text, but portal routes currently expose structured `UNAUTHORIZED` code and localized message.
  Fix: aligned AC-4 to established API contract: `error.code="UNAUTHORIZED"` and `error.message="Token mancante o non valido"`.
- Issue 3: Story scope could drift because epic narrative mentions receipt download, while ACs define only invoice/quote endpoints.
  Fix: added explicit scope note to prevent implementing undocumented receipt behavior in this story.
- Issue 4: Task 5 did not explicitly require full unauthorized payload assertions, risking incomplete AC-4 coverage.
  Fix: expanded Task 5 to include status/code/message checks for unauthenticated requests.
