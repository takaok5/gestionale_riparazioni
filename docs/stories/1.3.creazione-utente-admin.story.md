---
status: ready-for-dev
priority: high
estimate: M
story_id: "1.3"
epic: "Epic 1 - Autenticazione e Gestione Utenti"
---

# Story 1.3: Creazione Utente (Admin)

**As an** Admin, **I want** to create new user accounts with a specific role, **so that** new team members can access the system.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._  
**Given** I am authenticated as `ADMIN` with header `Authorization: Bearer <admin_access_token>` and JSON payload `{ "username": "nuovo.utente", "email": "nuovo@test.it", "password": "Password1", "role": "TECNICO" }`  
**When** I send `POST /api/users` with that header and payload  
**Then** I receive `201` with JSON body containing `{ id, username, email, role, isActive }` for `nuovo.utente`, and fields `password`/`passwordHash` are absent

### AC-2
_Derived from epic-details AC-2._  
**Given** I am authenticated as `ADMIN` and username `nuovo.utente` already exists in `User.username`  
**When** I send `POST /api/users` with the same username  
**Then** I receive `409` with error code `USERNAME_EXISTS`

### AC-3
_Derived from epic-details AC-3._  
**Given** I am authenticated as `ADMIN` and I send `POST /api/users` with password `"abc"` (length 3)  
**When** payload validation is executed before persistence  
**Then** I receive `400` with `error.code = "VALIDATION_ERROR"` and `error.details` containing at least `{ field: "password", rule: "min_length", min: 8 }`

### AC-4
_Derived from epic-details AC-4._  
**Given** I am authenticated as `TECNICO` (for example user `mario.rossi`) with header `Authorization: Bearer <tecnico_access_token>`  
**When** I send `POST /api/users` to create another account  
**Then** I receive `403` with `error.code = "FORBIDDEN"`

## Target Modules

- `packages/backend/src/index.ts`
- `packages/backend/src/routes/users.ts`
- `packages/backend/src/services/users-service.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/backend/src/__tests__/users-create.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/routes/users.ts` con endpoint `POST /api/users`, middleware `authenticate` + `authorize("ADMIN")`, mapping errori e status HTTP coerenti.
- [x] Task 2 (AC-1, AC-2, AC-3): creare `packages/backend/src/services/users-service.ts` con validazione payload (`username`, `email`, `password`, `role`), hash password e creazione utente su Prisma.
- [x] Task 3 (AC-2): in `packages/backend/src/services/users-service.ts` gestire conflitto username esistente restituendo codice dominio `USERNAME_EXISTS` da mappare su `409`.
- [x] Task 4 (AC-3): implementare regola password minima 8 caratteri e risposta di validazione `400` su campo `password`.
- [x] Task 5 (AC-1, AC-4): aggiornare `packages/backend/src/index.ts` per registrare `usersRouter` su `/api/users` mantenendo ordine middleware globale invariato.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): aggiungere `packages/backend/src/__tests__/users-create.spec.ts` con test API per creazione valida admin, username duplicato, password corta e accesso tecnico vietato.
- [x] Task 7 (AC-1): nel service/route garantire che la risposta di creazione non esponga mai `password` o `passwordHash`.
- [x] Task 8 (AC-4): uniformare il payload errore `403` al formato `buildErrorResponse("FORBIDDEN", ...)`.
