---
status: drafted
priority: high
estimate: M
---

Email invio preventivo must send the quotation to `cliente@test.it` with PDF attachment and produce a Notifica trail for both success and failure paths.

### AC-1: Invio preventivo crea email con PDF e Notifica PREVENTIVO (Derived from epic-details AC-1)
**Given** preventivo `id=5` linked to riparazione code `RIP-20260209-0001` with cliente email `cliente@test.it`
**When** `POST /api/preventivi/5/invia` is executed
**Then** API returns `200` with `data.id=5`, `data.stato="INVIATO"` and `data.dataInvio` not null, an email is sent to `cliente@test.it` with subject `Preventivo - RIP-20260209-0001`, attachment file name `preventivo-5.pdf`, and a Notifica row is persisted with `tipo="PREVENTIVO"`, `destinatario="cliente@test.it"`, `stato="INVIATA"`, and `allegato` containing the PDF path

### AC-2: Body email preventivo include dettagli economici template (Derived from epic-details AC-2)
**Given** preventivo `id=5` has monetary values `subtotale=200.00`, `IVA=44.00`, `totale=244.00` and at least one voce in `voci[]`
**When** `POST /api/preventivi/5/invia` composes the outgoing email body
**Then** the email content includes the preventivo detail block with `voci`, `subtotale=200.00`, `IVA=44.00`, and `totale=244.00 EUR`

### AC-3: Fallimento email ritorna 500 e salva Notifica FALLITA (Derived from epic-details AC-3)
**Given** test hook `setPreventivoEmailFailureForTests(5, true)` forces email delivery failure for preventivo `id=5`
**When** `POST /api/preventivi/5/invia` is executed
**Then** API returns `500` with `error.code="EMAIL_SEND_FAILED"` and message `Failed to send email`, Notifica is recorded with `tipo="PREVENTIVO"` and `stato="FALLITA"`, and preventivo `id=5` remains in stato `BOZZA` with `dataInvio=null`

### AC-4: Lista notifiche PREVENTIVO mostra record inviato (Derived from epic-details AC-4)
**Given** preventivo `id=5` was sent successfully to `cliente@test.it`
**When** `GET /api/notifiche?tipo=PREVENTIVO` is called
**Then** API returns `200` with `data[]` containing only rows with `tipo="PREVENTIVO"` and at least one row exposes `destinatario="cliente@test.it"`, non-null `dataInvio`, and `stato="INVIATA"`

### Tasks
- [x] AC-1: Update `packages/backend/src/services/preventivi-service.ts` to include subject `Preventivo - RIP-20260209-0001`, attachment name pattern `preventivo-{id}.pdf`, and success Notifica payload with `tipo="PREVENTIVO"` and `stato="INVIATA"`
- [x] AC-1, AC-3: Update `packages/backend/src/routes/preventivi.ts` failure mapping to preserve `EMAIL_SEND_FAILED` contract (`500`, `error.code`, `error.message`)
- [x] AC-1, AC-3, AC-4: Extend `packages/backend/src/services/notifiche-service.ts` to support PREVENTIVO notifications (success/failure) with `destinatario`, `dataInvio`, `stato`, `allegato`
- [x] AC-4: Ensure `packages/backend/src/routes/notifiche.ts` + service filtering returns only `tipo=PREVENTIVO` rows for `GET /api/notifiche?tipo=PREVENTIVO`
- [x] AC-1, AC-2, AC-3: Add/extend ATDD in `packages/backend/src/__tests__/preventivi-notifiche-atdd.spec.ts` to assert `200` happy path, body details (`subtotale=200`, `IVA=44`, `totale=244`), and `500` failure path (`Failed to send email`)
- [x] AC-4: Add/extend notification query assertions in `packages/backend/src/__tests__/riparazioni-stato-notifiche-atdd.spec.ts` (or dedicated `preventivi-notifiche-atdd.spec.ts`) for fields `destinatario`, `dataInvio`, `stato` on `tipo=PREVENTIVO`

AC count: 4
Task count: 6
