---
story_id: "5.7"
title: "Ricezione Ordine e Carico Magazzino"
status: "draft"
priority: "high"
estimate: "M"
---

# Story 5.7: Ricezione Ordine e Carico Magazzino

## Story

As an Admin, I want to record order receipt and automatically update inventory, so that stock levels reflect received goods.

## Acceptance Criteria

### AC-1 - Ricezione completa di tutte le voci ordine
**Given** utente autenticato con ruolo `ADMIN`, ordine `id=12` in stato `SPEDITO` con voci `[{ articoloId: 5, quantitaOrdinata: 10 }, { articoloId: 7, quantitaOrdinata: 5 }]`, articolo `5` con `giacenza=3` e articolo `7` con `giacenza=8`.
**When** invoco `POST /api/ordini/12/ricevi` con payload `{ voci: [{ articoloId: 5, quantitaRicevuta: 10 }, { articoloId: 7, quantitaRicevuta: 5 }] }`.
**Then** ricevo `200`, la `giacenza` articolo `5` diventa `13`, la `giacenza` articolo `7` diventa `13`, vengono creati movimenti automatici `CARICO` per entrambe le voci e `ordine.stato` diventa `RICEVUTO`.

### AC-2 - Ricezione parziale mantiene ordine in SPEDITO
**Given** utente autenticato con ruolo `ADMIN`, ordine `id=12` in stato `SPEDITO` con voci `[{ articoloId: 5, quantitaOrdinata: 10 }, { articoloId: 7, quantitaOrdinata: 5 }]`, articolo `5` con `giacenza=3` e articolo `7` con `giacenza=8`.
**When** invoco `POST /api/ordini/12/ricevi` con payload parziale `{ voci: [{ articoloId: 5, quantitaRicevuta: 6 }] }`.
**Then** ricevo `200`, viene creato solo il movimento `CARICO` per `articoloId=5` con quantita `6`, la giacenza dell'articolo `5` diventa `9`, la giacenza dell'articolo `7` resta `8`, e `ordine.stato` resta `SPEDITO`.

### AC-3 - Completamento successivo porta ordine in RICEVUTO
**Given** utente autenticato con ruolo `ADMIN`, ordine `id=12` in stato `SPEDITO` con voce `articoloId=5` gia' ricevuta completamente (`10/10`) e voce `articoloId=7` ancora da ricevere (`0/5`), articolo `7` con `giacenza=8`.
**When** invoco `POST /api/ordini/12/ricevi` con payload `{ voci: [{ articoloId: 7, quantitaRicevuta: 5 }] }`.
**Then** ricevo `200`, viene creato movimento `CARICO` per `articoloId=7` con quantita `5`, la giacenza articolo `7` diventa `13`, la seconda voce risulta completata e, con tutte le voci complete, `ordine.stato` diventa `RICEVUTO`.

### AC-4 - Blocco ricezione da stato BOZZA
**Given** utente autenticato con ruolo `ADMIN` e ordine `id=12` in stato `BOZZA`.
**When** invoco `POST /api/ordini/12/ricevi` con payload valido di ricezione.
**Then** ricevo `400`, `response.body.error.code = "VALIDATION_ERROR"` e `response.body.error.message = "Cannot receive order in BOZZA state"`.

## AC Source Mapping

- AC-1: Derived from epic-details AC-1.
- AC-2: Derived from epic-details AC-2.
- AC-3: Derived from epic-details AC-3.
- AC-4: Derived from epic-details AC-4.

## Task Breakdown

- [x] API routing: estendere `packages/backend/src/routes/ordini.ts` con endpoint `POST /:id/ricevi`, payload `{ voci: [{ articoloId, quantitaRicevuta }] }`, actor context da `req.user`, mapping errori dominio su `buildErrorResponse`.
- [x] Service contract: aggiungere in `packages/backend/src/services/anagrafiche-service.ts` input/result per ricezione ordine con codici errore coerenti (`VALIDATION_ERROR`, `ORDINE_NOT_FOUND`, `SERVICE_UNAVAILABLE`).
- [x] Service implementation test-store: implementare ricezione parziale/completa su ordini e voci in `packages/backend/src/services/anagrafiche-service.ts`, con aggiornamento stock e creazione movimenti `CARICO`.
- [x] Service implementation database: implementare transazione Prisma atomica in `packages/backend/src/services/anagrafiche-service.ts` che aggiorna voci ricevute, articoli, movimenti audit e stato ordine finale.
- [x] Data model: aggiornare `packages/backend/prisma/schema.prisma` con campi necessari a tracciare ricezione per voce (es. quantita ricevuta cumulata) mantenendo compatibilita con ordini esistenti.
- [x] Router wiring: aggiornare export/import se necessario in `packages/backend/src/routes/ordini.ts` e `packages/backend/src/index.ts` senza alterare endpoint esistenti.
- [x] ATDD: creare `packages/backend/src/__tests__/ordini-ricezione-atdd.spec.ts` per AC-1..AC-4 con assert su HTTP, stato ordine, giacenze e movimenti creati.
- [x] Sad-path ATDD: nello stesso `packages/backend/src/__tests__/ordini-ricezione-atdd.spec.ts` verificare per AC-4 il messaggio esatto `Cannot receive order in BOZZA state` e l'assenza di incrementi giacenza.
- [x] Regression tests: eseguire e mantenere verdi `packages/backend/src/__tests__/ordini-create-atdd.spec.ts`, `packages/backend/src/__tests__/ordini-stato-atdd.spec.ts`, `packages/backend/src/__tests__/articoli-movimenti-atdd.spec.ts`.

## Task-to-AC Coverage

- AC-1 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, Data model, ATDD.
- AC-2 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, Data model, ATDD.
- AC-3 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, Data model, ATDD.
- AC-4 coperta da task: API routing, Service contract, Service implementation test-store, Service implementation database, ATDD, Sad-path ATDD.

## Dependencies

- Story 5.5 completata (creazione ordine e struttura ordine/voci).
- Story 5.6 completata (regole stato ordine e controlli transizione).
- Story 5.3 completata (pattern movimenti magazzino e aggiornamento giacenza).

## Notes for Implementation

- Mantenere parita di comportamento tra test-store (`NODE_ENV=test`) e percorso database Prisma.
- La ricezione deve essere idempotente rispetto alla quantita residua per evitare doppio carico sulla stessa voce.
- Applicare validazione di stato: ricezione consentita solo quando ordine e' in stato compatibile (`SPEDITO` o stato esplicitamente ammesso).
- Preservare shape errori standard: `{ error: { code, message, details? } }`.
