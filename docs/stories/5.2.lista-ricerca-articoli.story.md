---
story_id: "5.2"
title: "Lista e Ricerca Articoli"
status: "draft"
priority: "medium"
estimate: "S"
---

# Story 5.2: Lista e Ricerca Articoli

## Story

As a Tecnico, I want to search inventory and view low-stock alerts, so that I can find parts and know what needs reordering.

## Acceptance Criteria

### AC-1 - Lista paginata articoli
**Given** nel sistema esistono 30 articoli e la richiesta e `GET /api/articoli?page=1&limit=20`.
**When** un utente autenticato con ruolo `TECNICO` invoca l'endpoint lista articoli.
**Then** la risposta e `200` con `data` contenente 20 articoli e `meta` uguale a `{ page: 1, limit: 20, total: 30 }`.

### AC-2 - Ricerca full-text su campi articolo
**Given** esistono articoli con valori contenenti `Samsung` in `nome`, `codiceArticolo` o `descrizione`.
**When** un utente autenticato con ruolo `TECNICO` invoca `GET /api/articoli?search=Samsung`.
**Then** la risposta e `200` e il body contiene `{ data, meta }`, con `data` composta solo da articoli che matchano `Samsung` in almeno uno tra `nome`, `codiceArticolo`, `descrizione`.

### AC-3 - Alert giacenza sotto soglia
**Given** articolo `id=5` ha `giacenza=3` e `sogliaMinima=5`, mentre articolo `id=7` ha `giacenza=10` e `sogliaMinima=5`.
**When** un utente autenticato con ruolo `TECNICO` invoca `GET /api/articoli/alert`.
**Then** la risposta e `200` con `data` che contiene solo l'articolo `id=5` dove `giacenza <= sogliaMinima` e non contiene articoli con `giacenza > sogliaMinima`.

### AC-4 - Filtro categoria
**Given** esistono articoli con categorie diverse e tra questi articoli con `categoria=DISPLAY`.
**When** un utente autenticato con ruolo `TECNICO` invoca `GET /api/articoli?categoria=DISPLAY`.
**Then** la risposta contiene esclusivamente articoli con `categoria` uguale a `DISPLAY`.

### AC-5 - Sad path query invalida
**Given** il limite massimo supportato dalle API lista e `100` e `categoria` deve essere una stringa non vuota.
**When** un utente autenticato con ruolo `TECNICO` invoca `GET /api/articoli?limit=1000` oppure `GET /api/articoli?categoria=`.
**Then** la risposta e `400` con `error.code` uguale a `VALIDATION_ERROR` e `error.details.field` coerente con il parametro non valido.

## Task Breakdown

- [x] Backend route: estendere `packages/backend/src/routes/articoli.ts` con `GET /` e `GET /alert`, payload query (`page`, `limit`, `search`, `categoria`) e mapping errori coerente con pattern anagrafiche.
- [x] Backend service input parsing: aggiungere in `packages/backend/src/services/anagrafiche-service.ts` i parser per lista/alert articoli con validazioni su `page`, `limit`, `search`, `categoria`.
- [x] Backend service data access: implementare in `packages/backend/src/services/anagrafiche-service.ts` funzioni `listArticoli` e `listArticoliAlert` per test store e database Prisma con `orderBy id asc`, `skip/take`, meta paginazione.
- [x] Access control: applicare middleware `authenticate` + `authorize("TECNICO", "ADMIN")` in `packages/backend/src/routes/articoli.ts` per endpoint di lettura.
- [x] ATDD tests: creare `packages/backend/src/__tests__/articoli-list-search-alert-atdd.spec.ts` con scenari AC-1..AC-4 (happy + sad path limiti/query invalid).
- [x] Sad path tests: coprire in `packages/backend/src/__tests__/articoli-list-search-alert-atdd.spec.ts` gli errori `limit=1000` e `categoria=` con verifica di `error.code=VALIDATION_ERROR`.
- [ ] Regression tests: verificare che `packages/backend/src/__tests__/articoli-create-atdd.spec.ts` continui a passare dopo le modifiche su route/service articoli.

## Dependencies

- Story 5.1 completata (creazione articolo e modello `Articolo` disponibile).
- Router registrato in `packages/backend/src/index.ts` su `/api/articoli`.

## Notes for Implementation

- Riutilizzare il contratto risposta `{ data, meta }` gia usato da clienti/fornitori.
- Ricerca case-insensitive su `nome`, `codiceArticolo`, `descrizione`.
- Endpoint `/api/articoli/alert` deve filtrare con condizione `giacenza <= sogliaMinima`.
