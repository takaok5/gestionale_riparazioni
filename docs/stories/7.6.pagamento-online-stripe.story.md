---
status: drafted
priority: high
estimate: M
story_id: "7.6"
title: "Pagamento Online Stripe"
---

# Story 7.6: Pagamento Online Stripe

## User Story
Come Commerciale voglio generare un link Stripe Checkout per una fattura cosi' che il cliente possa pagare online e il sistema aggiorni automaticamente pagamento e stato fattura via webhook.

## Acceptance Criteria

### AC-1
**Given** fattura `id=8` con `totale=244.00 EUR` e `stato="EMESSA"`.
**When** invio `POST /api/pagamenti/crea-link/8`.
**Then** viene creata una Stripe Checkout session e ricevo HTTP `200` con `{ "paymentUrl": "https://checkout.stripe.com/pay/cs_test_...", "sessionId": "cs_test_..." }`.

_Traceability: Derived from epic-details AC-1._

### AC-2
**Given** la fattura ha `stato="PAGATA"`.
**When** invio `POST /api/pagamenti/crea-link/8`.
**Then** ricevo HTTP `400` con errore esatto `"Invoice is already paid"`.

_Traceability: Derived from epic-details AC-2._

### AC-3
**Given** Stripe invia webhook event `"checkout.session.completed"` con `sessionId="cs_test_..."` e `metadata.fatturaId=8`.
**When** invio `POST /api/webhooks/stripe` con l'event payload.
**Then** il sistema crea automaticamente un record `Pagamento` con `{ fatturaId: 8, importo: 244.00, metodo: "STRIPE", dataPagamento: event.created }`, aggiorna `fattura.stato` a `"PAGATA"` e restituisce HTTP `200`.

_Traceability: Derived from epic-details AC-3._

### AC-4
**Given** la firma webhook Stripe e' invalida.
**When** invio `POST /api/webhooks/stripe`.
**Then** ricevo HTTP `400` con messaggio `"Invalid signature"`.

_Traceability: Derived from epic-details AC-4._

### AC-5
**Given** esiste gia' un pagamento registrato per lo stesso `sessionId`.
**When** invio `POST /api/webhooks/stripe` con un evento duplicato.
**Then** il sistema ignora il duplicato (idempotenza), non crea ulteriori pagamenti e restituisce HTTP `200`.

_Traceability: Derived from epic-details AC-5._

## Task Breakdown
- [ ] Implementare endpoint `POST /api/pagamenti/crea-link/:fatturaId` in `packages/backend/src/routes/pagamenti.ts` con validazione input, mapping errori (`400/404/500`) e response contract AC-1/AC-2.
- [ ] Estendere `packages/backend/src/services/stripe.service.ts` per creazione Checkout session con `metadata.fatturaId`, ritorno `{ paymentUrl, sessionId }`, e controllo di coerenza importo fattura AC-1.
- [ ] Integrare in `packages/backend/src/services/fatture-service.ts` la validazione stato fattura prima della creazione link (`EMESSA` ammessa, `PAGATA` rifiutata con messaggio esatto) AC-2.
- [ ] Implementare webhook handler in `packages/backend/src/webhooks/stripe.ts` con verifica firma, gestione evento `checkout.session.completed`, creazione pagamento `metodo="STRIPE"`, aggiornamento stato fattura a `PAGATA` e risposta `200` AC-3/AC-4.
- [ ] Registrare route webhook raw-body e route pagamenti in `packages/backend/src/index.ts`, garantendo ordine middleware compatibile con verifica firma Stripe AC-3/AC-4.
- [ ] Aggiungere/aggiornare test ATDD in `packages/backend/src/__tests__/fatture-pagamenti-atdd.spec.ts` per i 5 scenari: creazione link riuscita, fattura gia' pagata, webhook completion, firma invalida, duplicate event idempotente AC-1..AC-5.
- [ ] Introdurre controllo idempotenza su `sessionId` in `packages/backend/src/webhooks/stripe.ts` (con supporto servizi esistenti) per evitare doppia registrazione pagamenti AC-5.