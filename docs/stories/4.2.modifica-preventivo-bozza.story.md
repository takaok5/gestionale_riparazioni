---
status: drafted
priority: high
estimate: M
story_id: "4.2"
title: "Modifica Preventivo (Bozza)"
---

# Story 4.2: Modifica Preventivo (Bozza)

## User Story
Come Tecnico voglio modificare un preventivo in bozza per aggiornare prezzi e voci prima dell'invio al cliente.

## Acceptance Criteria (Expanded)

### AC-1
**Given** esiste il preventivo `id=5` con `stato="BOZZA"` e payload aggiornamento:
```json
{
  "voci": [
    {
      "tipo": "MANODOPERA",
      "descrizione": "Riparazione aggiornata",
      "quantita": 2,
      "prezzoUnitario": 90.00
    }
  ]
}
```
**When** invio `PUT /api/preventivi/5`
**Then** le voci precedenti vengono sostituite, i totali vengono ricalcolati con `subtotale=180.00`, `iva=39.60`, `totale=219.60` e ricevo HTTP `200`.

### AC-2
**Given** esiste il preventivo `id=5` con `stato="BOZZA"` e una voce iniziale `MANODOPERA` (`quantita=1`, `prezzoUnitario=50.00`)
**When** invio `PUT /api/preventivi/5` con payload:
```json
{
  "voci": [
    {
      "tipo": "MANODOPERA",
      "descrizione": "Diagnosi iniziale",
      "quantita": 1,
      "prezzoUnitario": 50.00
    },
    {
      "tipo": "RICAMBIO",
      "descrizione": "Batteria",
      "articoloId": 8,
      "quantita": 1,
      "prezzoUnitario": 90.00
    }
  ]
}
```
**Then** il preventivo aggiornato contiene `2` voci, `subtotale=140.00`, `iva=30.80`, `totale=170.80` e risposta HTTP `200`.

### AC-3
**Given** esiste il preventivo `id=5` con `stato="INVIATO"`
**When** invio `PUT /api/preventivi/5`
**Then** ricevo HTTP `400` con messaggio esatto `"Cannot edit preventivo with stato INVIATO"`.

### AC-4
**Given** esiste il preventivo `id=5` con `stato="APPROVATO"`
**When** invio `PUT /api/preventivi/5`
**Then** ricevo HTTP `400` con messaggio esatto `"Cannot edit preventivo with stato APPROVATO"`.

## Task Breakdown

- [x] Estendere packages/backend/src/routes/preventivi.ts aggiungendo endpoint PUT /:id con validazione input voci e mapping errori HTTP (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Estendere packages/backend/src/services/preventivi-service.ts con funzione di update preventivo:
  - lettura preventivo per id;
  - verifica stato === "BOZZA";
  - sostituzione voci e ricalcolo tramite computeTotals;
  - persistenza coerente su path test-store e path Prisma (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Aggiornare gestione persistenza voci correlate in packages/backend/src/services/preventivi-service.ts per evitare residui durante replace completo (copertura AC-1, AC-2).
- [x] Aggiungere test ATDD dedicati in `packages/backend/src/__tests__/preventivi-update-atdd.spec.ts` per i casi:
  - update bozza con sostituzione voci e verifica totali (AC-1);
  - update bozza con voce aggiuntiva e verifica `voci.length=2` e totali attesi (AC-2);
  - blocco update su `stato=INVIATO` con messaggio esatto (AC-3);
  - blocco update su `stato=APPROVATO` con messaggio esatto (AC-4).
- [x] Estendere seed/reset test in `packages/backend/src/services/preventivi-service.ts` aggiungendo fixture coerenti per `id=5` negli stati `BOZZA`, `INVIATO`, `APPROVATO` necessari agli ATDD (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Verificare bootstrap router in packages/backend/src/index.ts senza regressioni su endpoint POST/GET già esistenti (copertura regressioni trasversali).

## Note Tecniche
- Riutilizzare il pattern di validazione/errore già adottato in packages/backend/src/routes/preventivi.ts.
- Riutilizzare computeTotals in packages/backend/src/services/preventivi-service.ts per garantire coerenza di calcolo IVA al 22%.
- Mantenere simmetria tra implementazione in-memory (test mode) e implementazione Prisma (runtime DB).

## Validazione Step 4 - Issue e Fix Applicati

1. Problema: AC-1 aveva blocco JSON non valido in Markdown e typo su `totale` (`otale`), con rischio di interpretazione ambigua nei test.
   Fix: blocco JSON corretto (` ```json ... ``` `) e valori Then normalizzati con campi numerici espliciti.
2. Problema: AC-2 era vaga (`aumenta`, `coerentemente`) e non direttamente traducibile in assert deterministici.
   Fix: AC-2 ora include payload completo, conteggio voci atteso e totali numerici esatti (`140.00`, `30.80`, `170.80`).
3. Problema: task test non era concreto (`estendere ... o creare ...`) e non indicava un file unico da implementare.
   Fix: task aggiornato con file specifico `packages/backend/src/__tests__/preventivi-update-atdd.spec.ts` e scenari ATDD puntuali per ogni AC.
4. Problema: mancava un task esplicito per predisporre fixture test sugli stati `BOZZA/INVIATO/APPROVATO` richiesti dagli AC.
   Fix: aggiunto task dedicato su `packages/backend/src/services/preventivi-service.ts` per seed/reset test con dataset coerente.
