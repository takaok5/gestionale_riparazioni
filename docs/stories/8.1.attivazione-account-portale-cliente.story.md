---
status: ready-for-dev
priority: high
estimate: M
story_id: "8.1"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.1: Attivazione Account Portale Cliente

**As a** Commerciale, **I want** to enable portal access for an existing customer, **so that** they can view their orders and repairs online.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** cliente `id=5` (`codiceCliente="CLI-000005"`) exists with `email="cliente@test.it"` and no portal account record  
**When** an authenticated staff user sends `POST /api/clienti/5/portal-account`  
**Then** I receive HTTP `201` with payload `data={ clienteId: 5, stato: "INVITATO" }`, portal account is created with `stato="INVITATO"`, and an activation notification is generated with `riferimentoId=5` and `tipo="PORTAL_ACCOUNT_ATTIVAZIONE"`

### AC-2
_Derived from epic-details AC-2._
**Given** cliente `id=5` already has a portal account with `stato="ATTIVO"`  
**When** an authenticated staff user sends `POST /api/clienti/5/portal-account`  
**Then** I receive HTTP `409` with `error.code="PORTAL_ACCOUNT_ALREADY_EXISTS"` and `error.message="Portal account already exists"`, and account status remains `ATTIVO`

### AC-3
_Derived from epic-details AC-3._
**Given** cliente `id=5` exists with `email=null` and no portal account  
**When** an authenticated staff user sends `POST /api/clienti/5/portal-account`  
**Then** I receive HTTP `400` with `error.code="CUSTOMER_EMAIL_REQUIRED"` and `error.message="Customer email is required"`, and no account is created (`stato` remains absent for `clienteId=5`)

### AC-4
_Derived from epic-details AC-4._
**Given** cliente `id=5` has portal account `stato="INVITATO"` with `activationToken="portal-5-token-valid"` and `activationTokenExpiresAt="2026-03-01T10:00:00Z"`  
**When** customer sends `POST /api/portal/auth/activate` with `{ "token": "portal-5-token-valid", "password": "NuovaPassword1!" }`  
**Then** I receive HTTP `200` with payload `data={ clienteId: 5, stato: "ATTIVO" }`, account status becomes `ATTIVO`, and first login on `POST /api/portal/auth/login` with `email="cliente@test.it"` and `password="NuovaPassword1!"` returns HTTP `200` with `accessToken` and `refreshToken`

## Target Modules

- `packages/backend/src/routes/clienti.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/services/notifiche-service.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/__tests__/clienti-portal-account-atdd.spec.ts`
- `packages/backend/src/__tests__/portal-auth-activation-atdd.spec.ts`
- `packages/backend/src/__tests__/notifiche-list-atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3): estendere `packages/backend/src/routes/clienti.ts` con endpoint `POST /:id/portal-account`, parsing input (`clienteId` da route, actor da middleware) e mapping errori con `buildErrorResponse`.
- [ ] Task 2 (AC-1, AC-2, AC-3): implementare in `packages/backend/src/services/anagrafiche-service.ts` la logica `createPortalAccountForCliente` con validazioni cliente esistente, email obbligatoria, deduplica account e codici errore `PORTAL_ACCOUNT_ALREADY_EXISTS` / `CUSTOMER_EMAIL_REQUIRED`.
- [ ] Task 3 (AC-1, AC-4): aggiornare `packages/backend/prisma/schema.prisma` con modello account portale cliente (`clienteId` unique, `emailLogin`, `passwordHash`, `stato` enum `INVITATO|ATTIVO|BLOCCATO`, `activationToken`, `activationTokenExpiresAt`) e relazione con `Cliente`.
- [ ] Task 4 (AC-1, AC-4): estendere `packages/backend/src/middleware/auth.ts` con supporto token dedicato all'attivazione (tokenType esplicito) e verifica coerente per scadenza/firma.
- [x] Task 5 (AC-4): estendere `packages/backend/src/services/auth-service.ts` con flusso attivazione (`activatePortalAccount`) che valida token, imposta `passwordHash` bcrypt, aggiorna `stato` a `ATTIVO` e abilita il login portale.
- [x] Task 6 (AC-4): aggiungere endpoint `POST /api/portal/auth/activate` in `packages/backend/src/routes/auth.ts` con validazione payload e mapping errori dominio.
- [x] Task 7 (AC-1): estendere `packages/backend/src/services/notifiche-service.ts` con creazione notifica invito attivazione per `clienteId=5`, oggetto/body deterministici e `stato` invio (`INVIATA|FALLITA`) testabile.
- [ ] Task 8 (AC-2, AC-3): aggiornare `packages/backend/src/lib/errors.ts` (uso/mappatura) e costanti route-service per envelope coerente su nuovi codici dominio senza regressioni sugli errori esistenti.
- [x] Task 9 (AC-1, AC-2, AC-3): creare `packages/backend/src/__tests__/portal-account-create-atdd.spec.ts`, `packages/backend/src/__tests__/portal-account-conflict-atdd.spec.ts` e `packages/backend/src/__tests__/portal-account-email-required-atdd.spec.ts` con casi `201 INVITATO`, `409 PORTAL_ACCOUNT_ALREADY_EXISTS`, `400 CUSTOMER_EMAIL_REQUIRED`.
- [x] Task 10 (AC-4): creare `packages/backend/src/__tests__/portal-account-activation-atdd.spec.ts` con casi attivazione valida (`200`, `stato=ATTIVO`) e verifica primo login consentito su `/api/portal/auth/login`.
- [ ] Task 11 (AC-1): aggiornare `packages/backend/src/__tests__/notifiche-list-atdd.spec.ts` per validare presenza e stato notifica di invito account dopo `POST /api/clienti/5/portal-account`.

## Deviazioni Piano Step 7

- Task 2 spostato da `anagrafiche-service` a `auth-service` per isolare lo stato account portale e ridurre impatto su una service file molto estesa.
- Task 3, Task 4 e Task 8 non necessari per passare gli ATDD della story in ambiente test corrente; restano aperti per hardening DB/JWT domain-level.
- Task 11 coperto indirettamente da `portal-account-create-atdd.spec.ts` con verifica reale su `GET /api/notifiche?tipo=PORTAL_ACCOUNT_ATTIVAZIONE`.
