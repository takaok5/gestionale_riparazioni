---
status: drafted
priority: medium
estimate: M
story_id: "9.7"
epic: "Epic 9 - Vetrina Pubblica e Lead Capture"
---

# Story 9.7: Conversione Lead in Cliente + Pratica

**As a** Commerciale, **I want** to convert a qualified lead into customer and repair/order record, **so that** no manual re-entry is required.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** richiesta `id=12` exists in backoffice lead list with fields `nome`, `email`, `problema`, `tipo`, and `stato="NUOVA"`
**When** an authenticated `COMMERCIALE` or `ADMIN` calls `POST /api/richieste/12/converti`
**Then** API returns HTTP `200`, response body includes `data.richiesta.id=12` and `data.richiesta.stato="CONVERTITA"`, creates a Cliente from lead contact data, and appends an audit entry for model `RichiestaPubblica` with old/new state transition

### AC-2
_Derived from epic-details AC-2._
**Given** richiesta `id=12` contains `email` already associated to an existing cliente, and conversion matcher checks normalized `email` first and `telefono` only when present on lead payload
**When** `POST /api/richieste/12/converti` is executed
**Then** conversion reuses existing `cliente.id`, does not increase total clienti count, and response body includes `data.cliente.id` equal to the pre-existing customer id

### AC-3
_Derived from epic-details AC-3._
**Given** conversion target is repair flow and richiesta `id=12` has `problema="Display rotto"` with no additional device fields in public lead record
**When** `POST /api/richieste/12/converti` succeeds in mode `RIPARAZIONE`
**Then** conversion creates a riparazione draft via `createRiparazione` with `clienteId` from conversion result, `descrizioneProblema="Display rotto"`, `priorita="NORMALE"`, and non-empty fallback values for required fields `tipoDispositivo`, `marcaDispositivo`, `modelloDispositivo`, `serialeDispositivo`, `accessoriConsegnati`

### AC-4
_Derived from epic-details AC-4._
**Given** richiesta `id=12` has state `CONVERTITA`
**When** conversion endpoint `POST /api/richieste/12/converti` is called again
**Then** API returns HTTP `409` with domain error code `REQUEST_ALREADY_CONVERTED` and does not create new cliente or riparazione

## Target Modules

- `packages/backend/src/routes/richieste.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/src/__tests__/richieste-backoffice-api.atdd.spec.ts`
- `packages/backend/src/__tests__/public-richieste-api.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-4): add `POST /api/richieste/:id/converti` in `packages/backend/src/routes/richieste.ts` with `authenticate`, role guard (`COMMERCIALE`/`ADMIN`), and explicit HTTP 409 mapping for `REQUEST_ALREADY_CONVERTED`.
- [x] Task 2 (AC-1, AC-2): extend conversion logic in `packages/backend/src/services/anagrafiche-service.ts` to load richiesta by id, resolve existing cliente by email/phone, and only create cliente when no match exists.
- [x] Task 3 (AC-1, AC-4): update richiesta lifecycle transition logic in `packages/backend/src/services/anagrafiche-service.ts` to support `CONVERTITA` transition and write conversion audit metadata.
- [x] Task 4 (AC-3): integrate conversion flow with `packages/backend/src/services/riparazioni-service.ts` to create riparazione draft prefilled with lead data after cliente resolution.
- [x] Task 5 (AC-1, AC-2, AC-4): add/extend ATDD in `packages/backend/src/__tests__/richieste-backoffice-api.atdd.spec.ts` for successful conversion, customer reuse, duplicate conversion 409, and role authorization.
- [x] Task 6 (AC-3): add a dedicated backend test file `packages/backend/src/__tests__/richieste-conversione-api.atdd.spec.ts` to verify riparazione draft mapping (`descrizioneProblema`, default `priorita`, required fallback fields) from lead conversion output.
