---
status: drafted
priority: medium
estimate: S
story_id: "6.2"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.2: Dashboard Dettaglio Riparazioni per Stato

**As an** Admin, **I want** to see repair counts by status over time, **so that** I can monitor workflow.

## Acceptance Criteria

### AC-1
**Given** riparazioni esistenti con stati RICEVUTA, IN_DIAGNOSI, IN_LAVORAZIONE, PREVENTIVO_EMESSO, COMPLETATA, CONSEGNATA, ANNULLATA  
**When** I GET /api/dashboard/riparazioni-per-stato con token Admin valido  
**Then** I receive 200 with JSON object containing exactly these keys RICEVUTA, IN_DIAGNOSI, IN_LAVORAZIONE, PREVENTIVO_EMESSO, COMPLETATA, CONSEGNATA, ANNULLATA, and each key maps to an integer >= 0

### AC-2
**Given** today is 2026-02-09 and riparazioni include rows on 2026-02-09 plus rows on 2026-02-08  
**When** I GET /api/dashboard/riparazioni-per-stato?periodo=today con token Admin valido  
**Then** I receive 200 and the sum of all returned counts equals the number of riparazioni with dataRicezione on 2026-02-09 only

### AC-3
**Given** week range is 2026-02-03 to 2026-02-09 and riparazioni exist both inside and outside that interval  
**When** I GET /api/dashboard/riparazioni-per-stato?periodo=week con token Admin valido  
**Then** I receive 200 and the sum of all returned counts equals the number of riparazioni with dataRicezione in the inclusive range 2026-02-03..2026-02-09

### AC-4
**Given** month is February 2026 and riparazioni exist in February and in January 2026  
**When** I GET /api/dashboard/riparazioni-per-stato?periodo=month con token Admin valido  
**Then** I receive 200 and the sum of all returned counts equals the number of riparazioni with dataRicezione in 2026-02-01..2026-02-28

### AC-5
**Given** an authenticated user with role TECNICO or COMMERCIALE  
**When** the user GETs /api/dashboard/riparazioni-per-stato  
**Then** the API returns 403 with error code FORBIDDEN

## Target Modules

- packages/backend/src/routes/dashboard.ts
- packages/backend/src/services/dashboard-service.ts
- packages/backend/src/services/riparazioni-service.ts
- packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts
- packages/backend/src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts

## Task Breakdown

- [x] Task 1 (AC-1, AC-5): extend packages/backend/src/routes/dashboard.ts with authenticated GET /riparazioni-per-stato, periodo query parsing, and explicit mapping for VALIDATION_ERROR/FORBIDDEN/service errors.
- [x] Task 2 (AC-1): implement a dedicated service entrypoint in packages/backend/src/services/dashboard-service.ts that returns a complete status counter object with all expected keys even when count is .
- [x] Task 3 (AC-2, AC-3, AC-4): implement periodo handling (	oday, week, month) in packages/backend/src/services/dashboard-service.ts and translate each period into deterministic UTC date boundaries.
- [x] Task 4 (AC-2, AC-3, AC-4): reuse listRiparazioni filters from packages/backend/src/services/riparazioni-service.ts via dataRicezioneDa/dataRicezioneA to keep date filtering consistent with existing list endpoint semantics.
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4, AC-5): add ATDD scenarios in packages/backend/src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts for base aggregation, each period filter, and forbidden roles.
- [x] Task 6 (AC-1): keep regression checks for existing /api/dashboard behavior in packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts when dashboard route/service logic is extended.