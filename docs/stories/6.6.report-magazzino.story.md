---
status: drafted
priority: medium
estimate: M
story_id: "6.6"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.6: Report Magazzino

**As an** Admin, **I want** inventory reports, **so that** I can optimize stock levels and identify usage patterns.

## Source Mapping
- AC-1: Derived from epic-details AC-1
- AC-2: Derived from epic-details AC-2
- AC-3: Derived from epic-details AC-3
- AC-4: Derived from epic-details AC-4

## Acceptance Criteria

### AC-1
**Given** articoli with different giacenza and prezzoAcquisto values exist, and endpoint input is GET /api/report/magazzino
**When** I call /api/report/magazzino as Admin
**Then** I receive a JSON payload with keys aloreGiacenze, rticoliEsauriti, rticoliSottoSoglia, and 	opArticoliUtilizzati where one top item can be { articoloId: 5, nome: "Display Samsung S21", quantitaUtilizzata: 45 }

### AC-2
**Given** articolo id=5 has giacenza=0 and sogliaMinima > 0
**When** I call GET /api/report/magazzino as Admin
**Then** articolo 5 is counted in rticoliEsauriti

### AC-3
**Given** there are SCARICO movimenti for multiple articoli in the last 30 days
**When** I call GET /api/report/magazzino as Admin
**Then** 	opArticoliUtilizzati returns the top 10 articoli ordered by total quantita scaricata in that window

### AC-4
**Given** I am authenticated with role TECNICO
**When** I call GET /api/report/magazzino
**Then** I receive 403 with body { error: { code: "FORBIDDEN", message: "Admin only" } }

## Target Modules
- packages/backend/src/routes/report.ts
- packages/backend/src/services/report-service.ts
- packages/backend/src/services/anagrafiche-service.ts
- packages/backend/prisma/schema.prisma
- packages/backend/src/__tests__/report-finanziari-atdd.spec.ts
- packages/backend/src/__tests__/report-riparazioni-atdd.spec.ts
- packages/backend/src/__tests__/articoli-movimenti-atdd.spec.ts

## Task Breakdown
- [ ] Task 1 (AC-1, AC-4): Add GET /api/report/magazzino route in packages/backend/src/routes/report.ts following current report route flow (uthenticate -> service call -> explicit error mapping).
- [ ] Task 2 (AC-1, AC-2, AC-3): Implement getReportMagazzino in packages/backend/src/services/report-service.ts to compute aloreGiacenze, rticoliEsauriti, rticoliSottoSoglia, and 	opArticoliUtilizzati (top 10 by SCARICO quantity in 30 days).
- [ ] Task 3 (AC-1, AC-2): Use articolo inventory fields and thresholds from packages/backend/prisma/schema.prisma and service conventions in packages/backend/src/services/anagrafiche-service.ts as source of truth.
- [ ] Task 4 (AC-3): Reuse movement semantics from packages/backend/src/services/anagrafiche-service.ts to aggregate only SCARICO rows within the rolling 30-day window.
- [ ] Task 5 (AC-4): Enforce Admin-only guard and forbidden payload contract in packages/backend/src/routes/report.ts consistent with other report endpoints.
- [ ] Task 6 (AC-1, AC-2, AC-3, AC-4): Add ATDD tests in packages/backend/src/__tests__/report-magazzino-atdd.spec.ts covering happy path, esauriti counting, top-10 ordering, and 403 Admin only behavior.
