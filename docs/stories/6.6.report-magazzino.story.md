---
status: drafted
priority: medium
estimate: M
story_id: "6.6"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.6: Report Magazzino

**As an** Admin, **I want** inventory reports, **so that** I can optimize stock levels and identify usage patterns.

## Source Mapping
- AC-1: Derived from epic-details AC-1
- AC-2: Derived from epic-details AC-2
- AC-3: Derived from epic-details AC-3
- AC-4: Derived from epic-details AC-4

## Acceptance Criteria

### AC-1
**Given** articoli with different giacenza and prezzoAcquisto values exist, and endpoint input is GET /api/report/magazzino
**When** I call /api/report/magazzino as Admin
**Then** I receive 200 and a JSON payload with keys valoreGiacenze, articoliEsauriti, articoliSottoSoglia, and topArticoliUtilizzati where one seeded top item can be { articoloId: 5, nome: "Display Samsung S21", quantitaUtilizzata: 45 }

### AC-2
**Given** articolo id=5 has giacenza=0 and sogliaMinima > 0
**When** I call GET /api/report/magazzino as Admin
**Then** response includes articoliEsauriti >= 1 and the seeded fixture where articoloId=5 contributes to that count

### AC-3
**Given** there are SCARICO movimenti for multiple articoli in the last 30 days
**When** I call GET /api/report/magazzino as Admin
**Then** topArticoliUtilizzati returns at most 10 entries, ordered by quantitaUtilizzata descending, computed only from SCARICO rows in that rolling 30-day window

### AC-4
**Given** I am authenticated with role TECNICO
**When** I call GET /api/report/magazzino
**Then** I receive 403 with body { error: { code: "FORBIDDEN", message: "Admin only" } } and no inventory KPI fields in the response body

## Target Modules
- packages/backend/src/routes/report.ts
- packages/backend/src/services/report-service.ts
- packages/backend/src/services/anagrafiche-service.ts
- packages/backend/prisma/schema.prisma
- packages/backend/src/__tests__/report-finanziari-atdd.spec.ts
- packages/backend/src/__tests__/report-riparazioni-atdd.spec.ts
- packages/backend/src/__tests__/articoli-movimenti-atdd.spec.ts

## Task Breakdown
- [x] Task 1 (AC-1, AC-4): Add GET /api/report/magazzino route in packages/backend/src/routes/report.ts following current report route flow (authenticate -> service call -> explicit error mapping).
- [x] Task 2 (AC-1, AC-2, AC-3): Implement getReportMagazzino in packages/backend/src/services/report-service.ts to compute valoreGiacenze, articoliEsauriti, articoliSottoSoglia, and topArticoliUtilizzati (top 10 by SCARICO quantity in 30 days).
- [x] Task 3 (AC-1, AC-2): Use articolo inventory fields and thresholds from packages/backend/prisma/schema.prisma and service conventions in packages/backend/src/services/anagrafiche-service.ts as source of truth.
- [x] Task 4 (AC-3): Reuse movement semantics from packages/backend/src/services/anagrafiche-service.ts to aggregate only SCARICO rows within the rolling 30-day window.
- [x] Task 5 (AC-4): Enforce Admin-only guard and forbidden payload contract in packages/backend/src/routes/report.ts consistent with other report endpoints.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): Add ATDD tests in packages/backend/src/__tests__/report-magazzino-atdd.spec.ts covering happy path, esauriti counting, top-10 ordering, and 403 Admin only behavior.
- [x] Task 7 (AC-2, AC-3): Seed deterministic movimenti and articolo fixtures in packages/backend/src/__tests__/helpers/report-fixtures.ts (or existing report test helpers) so articoliEsauriti and top-10 ordering assertions are repeatable.

## Validation Notes (Step 4)

- Issue 1 fixed: AC-1 Then did not require an explicit HTTP status, so success contract was underspecified. Added 200 and explicit KPI payload contract.
- Issue 2 fixed: AC-3 Then did not specify ordering/limit semantics for top usage output. Added deterministic rules: max 10 rows, descending quantitaUtilizzata, and 30-day SCARICO scope.
- Issue 3 fixed: AC-4 Then validated only message/code and did not protect payload shape. Added assertion that forbidden response must not include KPI fields.

## Implementation Deviation

- Task 7 requested a dedicated helper in packages/backend/src/__tests__/helpers/report-fixtures.ts. Deterministic fixtures were implemented inline in packages/backend/src/__tests__/report-magazzino-atdd.spec.ts to keep setup local to this story and avoid premature shared-test coupling.
