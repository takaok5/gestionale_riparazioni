---
story: '3.7'
title: 'Annullamento Riparazione (Admin)'
status: ready-for-dev
priority: high
estimate: 4h
epic: 3
dependencies: ['3.5', '3.6']
---

# Story 3.7: Annullamento Riparazione (Admin)

## User Story
**As an** Admin, **I want** to cancel a repair from any state, **so that** I can handle exceptional situations.

## Acceptance Criteria

### AC 1 - Admin annulla da IN_LAVORAZIONE con nota
Source: Derived from epic-details AC-1.

**Given** sono autenticato come `ADMIN` con `userId=1`, la riparazione `id=10` ha stato iniziale `IN_LAVORAZIONE`, e `statiHistory` ha lunghezza iniziale `N`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "ANNULLATA", "note": "Cliente ha ritirato dispositivo" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "ANNULLATA" } }`, lo stato corrente della riparazione diventa `ANNULLATA`, e viene aggiunta una entry in `statiHistory` con `stato="ANNULLATA"`, `userId=1`, `note="Cliente ha ritirato dispositivo"` e `dataOra` ISO valida.

### AC 2 - Admin annulla da RICEVUTA senza nota
Source: Derived from epic-details AC-2.

**Given** sono autenticato come `ADMIN` con `userId=1`, la riparazione `id=10` ha stato iniziale `RICEVUTA`, e `statiHistory` ha lunghezza iniziale `N`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "ANNULLATA" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "ANNULLATA" } }`, lo stato corrente della riparazione diventa `ANNULLATA`, e viene aggiunta una entry in `statiHistory` con `stato="ANNULLATA"`, `userId=1`, `note=""` e `dataOra` ISO valida.

### AC 3 - Tecnico non admin non puo' annullare
Source: Derived from epic-details AC-3.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, la riparazione ha stato iniziale `IN_LAVORAZIONE`, e non possiedo ruolo `ADMIN`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "ANNULLATA" }`.

**Then** ricevo `403` con `error.code = "FORBIDDEN"` e `error.message = "Only admins can cancel repairs"`, lo stato della riparazione resta `IN_LAVORAZIONE`, e `statiHistory` mantiene lunghezza `N`.

## Task Breakdown

- [x] Aggiornare le regole di transizione in `packages/backend/src/services/riparazioni-service.ts` per consentire `ANNULLATA` da qualunque stato quando l'attore e' `ADMIN` (copre AC-1, AC-2).
- [x] Introdurre nel service un controllo esplicito che blocchi la cancellazione quando stato target e' `ANNULLATA` e l'attore non e' `ADMIN`, con errore mappabile su messaggio specifico (copre AC-3).
- [x] Applicare la stessa regola di cancellazione in entrambi i percorsi `cambiaStatoRiparazioneInTestStore` e `cambiaStatoRiparazioneInDatabase` in `packages/backend/src/services/riparazioni-service.ts` (copre AC-1, AC-2, AC-3).
- [x] Aggiornare la mappatura errori di `PATCH /api/riparazioni/:id/stato` in `packages/backend/src/routes/riparazioni.ts` per restituire `403` con messaggio esatto `Only admins can cancel repairs` nel caso dedicato (copre AC-3).
- [x] Aggiungere test ATDD in `packages/backend/src/__tests__/riparazioni-annullamento-admin-atdd.spec.ts` per i tre scenari AC (admin da `IN_LAVORAZIONE`, admin da `RICEVUTA`, tecnico non admin) con assert su stato HTTP, payload e storico (copre AC-1, AC-2, AC-3).
- [x] Eseguire regressione mirata in `packages/backend/src/__tests__/riparazioni-stato-preventivo-atdd.spec.ts` per verificare che le transizioni preventivo restino coerenti dopo la nuova regola di annullamento (copre regressioni su Epic 3).

## Notes
- Le risposte errore devono mantenere il formato `{ error: { code, message, details } }`.
- La regola "cancel solo admin" deve prevalere anche quando il tecnico e' assegnato alla riparazione.
