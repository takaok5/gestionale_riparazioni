---
status: drafted
priority: medium
estimate: S
story_id: "6.7"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.7: Export Report

**As an** Admin, **I want** to export reports as CSV, **so that** I can analyze data in Excel.

## Source Mapping
- AC-1: Derived from epic-details AC-1
- AC-2: Derived from epic-details AC-2
- AC-3: Derived from epic-details AC-3
- AC-4: Derived from epic-details AC-4

## Acceptance Criteria

### AC-1
**Given** riparazioni exist and I request `GET /api/report/export/riparazioni?dateFrom=2026-01-01&dateTo=2026-01-31`
**When** I call the endpoint as authenticated `ADMIN`
**Then** I receive `200` with `Content-Type: text/csv`, `Content-Disposition: attachment; filename="report-riparazioni-2026-01-01_2026-01-31.csv"`, and CSV headers `codiceRiparazione,cliente,tecnico,stato,dataRicezione,dataCompletamento`

### AC-2
**Given** fatture exist in period `2026-01-01` to `2026-01-31`, including examples `{ numero: "FAT-2026-0001", totale: 1220.00, stato: "EMESSA", dataEmissione: "2026-01-05" }` and `{ numero: "FAT-2026-0002", totale: 780.50, stato: "PAGATA", dataEmissione: "2026-01-10" }`
**When** I call `GET /api/report/export/finanziari?dateFrom=2026-01-01&dateTo=2026-01-31` as `ADMIN`
**Then** I receive `200` with `Content-Type: text/csv`, `Content-Disposition: attachment; filename="report-finanziari-2026-01-01_2026-01-31.csv"`, CSV headers `numeroFattura,cliente,stato,totale,dataEmissione,dataPagamento`, and rows only for fatture within the requested range

### AC-3
**Given** articoli exist with current giacenze
**When** I call `GET /api/report/export/magazzino` as `ADMIN`
**Then** I receive `200` with `Content-Type: text/csv`, `Content-Disposition: attachment; filename="report-magazzino.csv"`, CSV headers `articoloId,nome,giacenza,sogliaMinima,prezzoAcquisto,valoreGiacenza`, and rows containing each articolo with `valoreGiacenza = giacenza * prezzoAcquisto`

### AC-4
**Given** I am authenticated with role `TECNICO`
**When** I call `GET /api/report/export/riparazioni`
**Then** I receive `403` with body `{ error: { code: "FORBIDDEN", message: "Admin only" } }`

## Target Modules
- packages/backend/src/routes/report.ts
- packages/backend/src/services/report-service.ts
- packages/backend/src/__tests__/report-export-atdd.spec.ts

## Task Breakdown
- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): Add export CSV endpoints in `packages/backend/src/routes/report.ts` for `/export/riparazioni`, `/export/finanziari`, and `/export/magazzino` with `authenticate` middleware and existing error mapping pattern.
- [x] Task 2 (AC-1): Implement riparazioni CSV generation in `packages/backend/src/services/report-service.ts` using existing report/riparazioni data sources and fixed header order `codiceRiparazione,cliente,tecnico,stato,dataRicezione,dataCompletamento`.
- [x] Task 3 (AC-2): Implement finanziari CSV generation in `packages/backend/src/services/report-service.ts` scoped by `dateFrom/dateTo`, with header order `numeroFattura,cliente,stato,totale,dataEmissione,dataPagamento`, and based on existing `listFatture` integration.
- [x] Task 4 (AC-3): Implement magazzino CSV generation in `packages/backend/src/services/report-service.ts` with header order `articoloId,nome,giacenza,sogliaMinima,prezzoAcquisto,valoreGiacenza` and deterministic `valoreGiacenza` calculation.
- [x] Task 5 (AC-4): Enforce admin-only guard for all export endpoints in `packages/backend/src/services/report-service.ts` returning `FORBIDDEN` with message `Admin only`.
- [x] Task 6 (AC-1, AC-2, AC-3): Set `Content-Disposition` attachment filename convention in `packages/backend/src/routes/report.ts` for each export endpoint.
- [x] Task 7 (AC-1, AC-2, AC-3, AC-4): Add ATDD coverage in `packages/backend/src/__tests__/report-export-atdd.spec.ts` for CSV headers/body, `text/csv` content type, filename header, date filtering behavior, and `403` for non-admin role.

## Validation Notes (Step 4)

- Issue 1 fixed: AC-2 Given was not specific enough for deterministic tests ("fatture exist"). Added concrete invoice examples with explicit fields and values.
- Issue 2 fixed: AC-2 Then did not define a verifiable CSV contract. Added exact CSV header schema and explicit date-range filtering expectation.
- Issue 3 fixed: AC-3 Then did not define download/header behavior or a concrete computed column. Added `Content-Disposition` filename, explicit headers, and `valoreGiacenza` formula.
