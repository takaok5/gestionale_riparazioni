---
status: ready-for-dev
priority: medium
estimate: M
story_id: "3.2"
epic: "Epic 3 - Gestione Riparazioni"
---

# Story 3.2 Lista e Filtro Riparazioni

**As a** Tecnico, **I want** to filter and search repairs, **so that** I can find relevant repairs quickly.

## Acceptance Criteria

### AC-1
**Given** esistono 30 riparazioni nel sistema
**When** invio `GET /api/riparazioni?page=1&limit=15`
**Then** ricevo `200` con `data` contenente 15 riparazioni ordinate per `dataRicezione` decrescente (a parita, `id` crescente) e `meta` uguale a `{ page: 1, limit: 15, total: 30, totalPages: 2 }`
Source: Derived from epic-details AC-1

### AC-2
**Given** esistono riparazioni con stati differenti, inclusa almeno una con `stato=IN_LAVORAZIONE`
**When** invio `GET /api/riparazioni?stato=IN_LAVORAZIONE`
**Then** ricevo solo riparazioni con `stato` uguale a `IN_LAVORAZIONE`
Source: Derived from epic-details AC-2

### AC-3
**Given** esistono riparazioni assegnate al tecnico con `tecnicoId=3`
**When** invio `GET /api/riparazioni?tecnicoId=3`
**Then** ricevo solo riparazioni assegnate al tecnico con id `3`
Source: Derived from epic-details AC-3

### AC-4
**Given** esistono riparazioni con `priorita=ALTA` e `priorita=NORMALE`
**When** invio `GET /api/riparazioni?priorita=ALTA`
**Then** ricevo solo riparazioni con `priorita` uguale a `ALTA`
Source: Derived from epic-details AC-4

### AC-5
**Given** esistono riparazioni ricevute tra `2026-02-01` e `2026-02-10`
**When** invio `GET /api/riparazioni?dataRicezioneDa=2026-02-01&dataRicezioneA=2026-02-10`
**Then** ricevo solo riparazioni con `dataRicezione` tra `2026-02-01T00:00:00.000Z` e `2026-02-10T23:59:59.999Z` (estremi inclusi), escludendo record fuori range
Source: Derived from epic-details AC-5

### AC-6
**Given** esistono riparazioni con `modelloDispositivo`, `marcaDispositivo` o `codiceRiparazione` che contengono `Galaxy`
**When** invio `GET /api/riparazioni?search=Galaxy`
**Then** ricevo riparazioni che matchano `Galaxy` in modo case-insensitive in almeno uno tra `modelloDispositivo`, `marcaDispositivo` o `codiceRiparazione`
Source: Derived from epic-details AC-6

### AC-7
**Given** il limite massimo supportato dalla lista e `100`
**When** invio `GET /api/riparazioni?limit=1000`
**Then** ricevo `400` con errore `{ code: "VALIDATION_ERROR", details: { field: "limit", rule: "too_large" } }`
Source: Validation extension for sad path based on list validation patterns

## Target Modules

- `packages/backend/src/routes/riparazioni.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/prisma/schema.prisma`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4, AC-5, AC-6): aggiornare `packages/backend/src/routes/riparazioni.ts` per esporre `GET /api/riparazioni`, leggere `page`, `limit`, `stato`, `tecnicoId`, `priorita`, `dataRicezioneDa`, `dataRicezioneA`, `search` da query e inoltrare al service.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4, AC-5, AC-6, AC-7): estendere `packages/backend/src/services/riparazioni-service.ts` con parser input lista, default `page=1` e `limit=15`, limite massimo `100`, validazioni query e normalizzazione filtri.
- [x] Task 3 (AC-1, AC-2, AC-3, AC-4, AC-5, AC-6): implementare in `packages/backend/src/services/riparazioni-service.ts` la logica list/filter/search su test store con ordinamento deterministico (`dataRicezione desc`, fallback `id asc`), slicing paginato e `meta.totalPages`.
- [x] Task 4 (AC-1, AC-2, AC-3, AC-4, AC-5, AC-6): implementare in `packages/backend/src/services/riparazioni-service.ts` la query database con `where` condizionale, filtri range data inclusivi, `skip/take`, `count` totale e risposta `{ data, meta }`.
- [x] Task 5 (AC-3): aggiornare `packages/backend/prisma/schema.prisma` per supportare il filtro `tecnicoId` sulla riparazione coerentemente ai requisiti della story.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4, AC-5, AC-6, AC-7): aggiungere scenari ATDD in `packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts` per paginazione, filtri (`stato`, `tecnicoId`, `priorita`, range date), ricerca `Galaxy` e sad path `limit=1000`.
