---
status: ready-for-dev
priority: high
estimate: M
story_id: "8.2"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.2: Login, Refresh e Logout Portale Cliente

**As a** Cliente, **I want** to authenticate securely in the portal, **so that** I can access my private data.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** a portal account exists with `emailLogin="cliente@test.it"`, `stato="ATTIVO"`, and password hash for `"Password123!"` linked to `clienteId=5`  
**When** the customer sends `POST /api/portal/auth/login` with `{ "email": "cliente@test.it", "password": "Password123!" }`  
**Then** the API returns HTTP `200` with top-level `accessToken`, `refreshToken`, and `profileSummary={ clienteId: 5, codiceCliente: "CLI-000005", ragioneSociale: "Cliente Test SRL" }`

### AC-2
_Derived from epic-details AC-2._
**Given** portal account `emailLogin="cliente@test.it"` exists and stored hash does not match password `"PasswordErrata1!"`  
**When** the customer sends `POST /api/portal/auth/login` with invalid credentials  
**Then** the API returns HTTP `401` with `error.code="INVALID_CREDENTIALS"`, no access token, and no refresh token

### AC-3
_Derived from epic-details AC-3._
**Given** the same IP `203.0.113.10` and account `cliente@test.it` already produced `10` failed portal login attempts in the last `15` minutes  
**When** another `POST /api/portal/auth/login` request is sent from that IP/account pair  
**Then** the API returns HTTP `423` with `error.code="ACCOUNT_TEMPORARILY_LOCKED"`, includes header `Retry-After`, and does not return `accessToken` or `refreshToken`

### AC-4
_Derived from epic-details AC-4._
**Given** a valid portal refresh token `rt_valid_portal_5_v1` is associated to `clienteId=5` and not expired  
**When** the customer sends `POST /api/portal/auth/refresh` with that token  
**Then** the API returns HTTP `200` with a new `accessToken` and a new `refreshToken`, and any reuse of `rt_valid_portal_5_v1` afterwards returns HTTP `401` with `error.code="INVALID_REFRESH_TOKEN"`

### AC-5
_Derived from epic-details AC-5._
**Given** an authenticated portal session for `clienteId=5` with refresh token `rt_active_portal_5`  
**When** the customer sends `POST /api/portal/auth/logout` with header `Authorization: Bearer <portalAccessToken>` and body `{ "refreshToken": "rt_active_portal_5" }`  
**Then** the refresh token is revoked, API returns HTTP `200` with `data.revoked=true` and no auth tokens in response body, and subsequent refresh with `rt_active_portal_5` returns HTTP `401`

## Target Modules

- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/login-rate-limit.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/routes/clienti.ts`
- `packages/backend/src/__tests__/auth-login.spec.ts`
- `packages/backend/src/__tests__/auth-refresh.spec.ts`
- `packages/backend/src/__tests__/portal-auth-login-refresh-logout.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3): aggiornare `packages/backend/src/routes/auth.ts` per consolidare endpoint `POST /api/portal/auth/login`, mappare errori dominio (`INVALID_CREDENTIALS`, `ACCOUNT_TEMPORARILY_LOCKED`) e mantenere envelope `buildErrorResponse`.
- [x] Task 2 (AC-3): estendere `packages/backend/src/services/login-rate-limit.ts` con finestra `15` minuti e soglia `10` tentativi per coppia `ip+account`, esponendo stato lock necessario al route layer.
- [x] Task 3 (AC-1, AC-4, AC-5): estendere `packages/backend/src/services/auth-service.ts` con payload profilo cliente nel login portale, refresh con rotazione/revoca token precedente e servizio logout con revoca refresh token.
- [x] Task 4 (AC-4, AC-5): adeguare `packages/backend/src/middleware/auth.ts` (o utility correlate) per supportare verifica token revocati e separazione semantica access/refresh nel dominio portal.
- [x] Task 5 (AC-4): aggiungere endpoint `POST /api/portal/auth/refresh` in `packages/backend/src/routes/auth.ts` delegando a service e restituendo nuovi token con invalidazione del precedente.
- [x] Task 6 (AC-5): aggiungere endpoint `POST /api/portal/auth/logout` in `packages/backend/src/routes/auth.ts` con revoca refresh token e risposta deterministica `data.revoked=true`.
- [x] Task 7 (AC-1..AC-5): creare/aggiornare test backend in `packages/backend/src/__tests__/portal-auth-login-refresh-logout.atdd.spec.ts`, `packages/backend/src/__tests__/auth-login.spec.ts` e `packages/backend/src/__tests__/auth-refresh.spec.ts` per coprire tutti i codici HTTP e i codici errore richiesti.

## Step 4 Validation Fixes

- Issue 1: AC-1 usava envelope `data.*` non allineato al pattern auth esistente, rendendo ambiguo l'`expect()` sul payload.
  Fix: AC-1 ora richiede token top-level e campo esplicito `profileSummary` con chiavi deterministiche.
- Issue 2: AC-3 includeva un requisito interno ("non valida hash password") non verificabile da test black-box.
  Fix: AC-3 ora definisce solo outcome osservabili (`423`, `error.code`, header `Retry-After`, assenza token).
- Issue 3: AC-5 non specificava il contratto input (header/body) per logout, riducendo testabilita' e coerenza endpoint.
  Fix: AC-5 ora esplicita header `Authorization` e body `{ refreshToken }`, oltre all'assenza token in risposta.

## Deviazioni Piano Step 7

- Task 4 completato senza modificare `packages/backend/src/middleware/auth.ts`: la revoca refresh token portale e la separazione access/refresh sono state implementate in `packages/backend/src/services/auth-service.ts` con controllo tokenType e blacklist in-memory, mantenendo invariato il middleware shared.
