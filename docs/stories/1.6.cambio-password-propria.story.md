---
status: ready-for-dev
priority: high
estimate: S
story_id: "1.6"
epic: "Epic 1 - Autenticazione e Gestione Utenti"
---

# Story 1.6: Cambio Password Propria

**As a** Tecnico, **I want** to change my password, **so that** I can keep my account secure.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** I am authenticated with header `Authorization: Bearer <access-token>` for user `username "mario.rossi"` whose current password is `"Password1"`
**When** I send `PUT /api/users/me/password` with JSON payload `{ "currentPassword": "Password1", "newPassword": "NewPass2" }`
**Then** I receive HTTP `200` with `response.body.success` set to `true`, a subsequent `POST /api/auth/login` with `username "mario.rossi"` and `password "NewPass2"` returns HTTP `200`, and login with old password `Password1` returns HTTP `401` with `error.code` set to `"INVALID_CREDENTIALS"`

### AC-2
_Derived from epic-details AC-2._
**Given** I am authenticated with header `Authorization: Bearer <access-token>` for user `username "mario.rossi"`
**When** I send `PUT /api/users/me/password` with JSON payload `{ "currentPassword": "WrongPass9", "newPassword": "NewPass2" }`
**Then** I receive HTTP `400` with `response.body.error.code` set to `"CURRENT_PASSWORD_INCORRECT"` and `response.body.error.message` set to `"Current password is incorrect"`

### AC-3
_Derived from epic-details AC-3._
**Given** I am authenticated with header `Authorization: Bearer <access-token>` for user `username "mario.rossi"`
**When** I send `PUT /api/users/me/password` with JSON payload `{ "currentPassword": "Password1", "newPassword": "abc" }`
**Then** I receive HTTP `400` with `response.body.error.code` set to `"VALIDATION_ERROR"`, `response.body.error.message` set to `"Payload non valido"`, and `response.body.error.details` equal to `{ field: "newPassword", rule: "password_policy", min: 8, requiresUppercase: true, requiresNumber: true }`

## Target Modules

- `packages/backend/src/routes/users.ts`
- `packages/backend/src/services/users-service.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/backend/src/__tests__/users-change-password.spec.ts`
- `packages/shared/src/types/index.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3): aggiungere endpoint `PUT /api/users/me/password` in `packages/backend/src/routes/users.ts` con middleware `authenticate` e mapping errori in `buildErrorResponse`.
- [x] Task 2 (AC-1, AC-2): implementare in `packages/backend/src/services/users-service.ts` il cambio password per utente autenticato con verifica `bcrypt.compare(currentPassword, storedHash)` e persistenza nuovo hash.
- [x] Task 3 (AC-3): introdurre in `packages/backend/src/services/users-service.ts` la validazione `newPassword` (lunghezza minima 8, almeno 1 uppercase, almeno 1 numero) e restituire `VALIDATION_ERROR` con `details` strutturati.
- [x] Task 4 (AC-1, AC-2, AC-3): estendere i contratti condivisi in `packages/shared/src/types/index.ts` per payload cambio password e response error.
- [x] Task 5 (AC-1, AC-2, AC-3): creare `packages/backend/src/__tests__/users-change-password.spec.ts` con test API per successo, current password errata e nuova password non valida.
- [x] Task 6 (AC-1): sincronizzare gli helper test tra `packages/backend/src/services/users-service.ts` e `packages/backend/src/services/auth-service.ts` per evitare mismatch credenziali dopo update password.
