---
status: drafted
priority: high
estimate: S
story_id: "8.3"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.3: Dashboard Cliente

**As a** Cliente, **I want** to see a personal dashboard with key counters, **so that** I immediately know what requires action.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** customer id=5 has 2 open orders, 1 active repair, and 1 pending quote in the system
**When** the customer sends GET /api/portal/me with a valid portal access token
**Then** the API returns HTTP 200 with stats exactly equal to { "ordiniAperti": 2, "riparazioniAttive": 1, "preventiviInAttesa": 1 }

### AC-2
_Derived from epic-details AC-2._
**Given** customer id=5 has 0 open orders, 0 active repairs, and 0 pending quotes
**When** the customer sends GET /api/portal/me with a valid portal access token
**Then** the API returns HTTP 200 with numeric zero values stats.ordiniAperti=0, stats.riparazioniAttive=0, stats.preventiviInAttesa=0 and no null counter values

### AC-3
_Derived from epic-details AC-3._
**Given** customer id=5 has recent events including at least one repair status change and one newly issued invoice
**When** the customer sends GET /api/portal/me with a valid portal access token
**Then** the response contains `eventiRecenti` as an array of objects with keys `tipo`, `riferimentoId`, `timestamp`, `descrizione`, and every adjacent pair is sorted desc by `timestamp` (`eventiRecenti[i].timestamp >= eventiRecenti[i+1].timestamp`)

### AC-4
_Derived from epic-details AC-4._
**Given** the request has no valid Authorization header with Bearer token
**When** GET /api/portal/me is called
**Then** the API returns HTTP 401 with `error.code="UNAUTHORIZED"` and `error.message="Token mancante o non valido"`, and no `stats` or `eventiRecenti` payload

## Target Modules

- packages/backend/src/index.ts
- packages/backend/src/routes/auth.ts
- packages/backend/src/middleware/auth.ts
- packages/backend/src/services/auth-service.ts
- packages/backend/src/services/anagrafiche-service.ts
- packages/backend/src/services/riparazioni-service.ts
- packages/backend/src/services/preventivi-service.ts
- packages/backend/src/services/notifiche-service.ts
- packages/backend/src/__tests__/portal-auth-login-refresh-logout.atdd.spec.ts
- packages/backend/src/__tests__/portal-dashboard-me.atdd.spec.ts

## Task Breakdown

- [ ] Task 1 (AC-1, AC-2, AC-4): Add authenticated GET /api/portal/me handler in packages/backend/src/routes/auth.ts with coherent error envelope and 401 mapping.
- [ ] Task 2 (AC-1, AC-2): Implement aggregation for ordiniAperti, riparazioniAttive, preventiviInAttesa in packages/backend/src/services/auth-service.ts with non-null numeric values.
- [ ] Task 3 (AC-1, AC-2): Reuse/query helpers from packages/backend/src/services/anagrafiche-service.ts, packages/backend/src/services/riparazioni-service.ts, packages/backend/src/services/preventivi-service.ts to compute counters for customer id=5.
- [ ] Task 4 (AC-3): Build eventiRecenti sorted by timestamp desc by following patterns from packages/backend/src/services/notifiche-service.ts.
- [ ] Task 5 (AC-1..AC-4): Register the route in packages/backend/src/index.ts under /api/portal namespace while preserving portal-token contract.
- [ ] Task 6 (AC-1..AC-4): Create ATDD coverage in packages/backend/src/__tests__/portal-dashboard-me.atdd.spec.ts for nominal case, zero counters, event ordering, and 401 without token.
- [ ] Task 7 (AC-4): Verify middleware compatibility in packages/backend/src/middleware/auth.ts to block unauthenticated access.

## Step 4 Validation Fixes

- Issue 1: AC-3 did not define a deterministic payload contract for each timeline event, so test assertions could be inconsistent across implementations.
  Fix: AC-3 now mandates event object keys (`tipo`, `riferimentoId`, `timestamp`, `descrizione`) and explicit adjacent-pair descending order check.
- Issue 2: AC-4 had a vague "Unauthorized error response" outcome with no stable error code/message for black-box tests.
  Fix: AC-4 now requires HTTP 401 with `error.code="UNAUTHORIZED"` and `error.message="Token mancante o non valido"`, plus absence of dashboard payload fields.
- Issue 3: Task 1 and Task 2 allowed alternate file targets ("or equivalent"/"or dedicated"), creating implementation ambiguity and weak traceability to modules.
  Fix: task breakdown now pins implementation to `packages/backend/src/routes/auth.ts` and `packages/backend/src/services/auth-service.ts`.
