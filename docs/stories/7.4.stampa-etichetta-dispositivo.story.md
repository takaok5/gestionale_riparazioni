---
status: drafted
priority: medium
estimate: M
---

Tecnico must be able to print a device label PDF for a repair, including QR and key identification fields for workshop handling.

### AC-1: Generazione PDF etichetta 62x100mm con QR e dati riparazione (Derived from epic-details AC-1)
**Given** repair `id=10` exists with `codiceRiparazione="RIP-20260209-0001"`, customer `"Rossi Mario"`, device `marca="Samsung"` and `modello="Galaxy S21"`, and `dataRicezione="2026-02-09T10:00:00.000Z"`
**When** `GET /api/riparazioni/10/etichetta` is called by authenticated role `TECNICO`
**Then** API returns `200`, `Content-Type` containing `application/pdf`, `Content-Disposition` containing `filename="etichetta-riparazione-10.pdf"`, binary body starting with `%PDF`, and PDF content includes `RIP-20260209-0001`, `Rossi Mario`, `Samsung`, `Galaxy S21`, `09/02/2026`, with QR payload encoding exactly `RIP-20260209-0001`

### AC-2: Fallback su codice cliente quando nome assente (Derived from epic-details AC-2)
**Given** repair `id=10` exists and related customer has `nome=""` and `codiceCliente="CLI-000005"`
**When** `GET /api/riparazioni/10/etichetta` is called by authenticated role `TECNICO`
**Then** generated PDF contains `CLI-0005` in the customer line, does not contain `Rossi Mario`, and still contains all mandatory fields from AC-1

### AC-3: Riparazione inesistente (Derived from epic-details AC-3)
**Given** repair `id=999` does not exist
**When** `GET /api/riparazioni/999/etichetta` is called by authenticated role `TECNICO`
**Then** API returns `404` with error code `RIPARAZIONE_NOT_FOUND`, message `Riparazione non trovata`, and no `data` payload

### Tasks
- [x] AC-1: Add route `GET /api/riparazioni/:id/etichetta` in `packages/backend/src/routes/riparazioni.ts`, including auth and PDF headers aligned with `packages/backend/src/routes/fatture.ts`.
- [x] AC-1, AC-2, AC-3: Add service entrypoint `getRiparazioneEtichettaPdf` in `packages/backend/src/services/riparazioni-service.ts` with typed input parsing, riparazione lookup, and domain error mapping.
- [x] AC-1: Implement deterministic label builder in `packages/backend/src/services/riparazioni-etichetta-pdf.ts` with fixed 62x100mm page size conversion and QR payload equal to `codiceRiparazione`.
- [x] AC-2: Extend customer projection in `packages/backend/src/services/riparazioni-service.ts` to include fields needed for `nome` -> `codiceCliente` fallback in the label payload.
- [x] AC-1, AC-2, AC-3: Add ATDD file `packages/backend/src/__tests__/riparazioni-etichetta-atdd.spec.ts` covering PDF headers/content contract, fallback behavior, and 404 `RIPARAZIONE_NOT_FOUND`.
- [x] AC-1: Update `packages/backend/package.json` with required QR/PDF runtime dependencies and keep scripts unchanged.

AC count: 3
Task count: 6
