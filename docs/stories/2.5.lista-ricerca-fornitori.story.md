---
status: ready-for-dev
priority: medium
estimate: S
story_id: "2.5"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.5: Lista e Ricerca Fornitori

**As an** Admin, **I want** to search and filter suppliers, **so that** I can manage supplier information.

## Dependencies

- 2.4

## Acceptance Criteria

### AC-1
**Given** sono autenticato come `ADMIN` e nel dataset corrente esistono esattamente 15 fornitori con campi minimi `{ id, codiceFornitore, nome, categoria }`
**When** invio `GET /api/fornitori?page=1&limit=20`
**Then** ricevo `200`, `data.length = 15` e `meta = { page: 1, limit: 20, total: 15, totalPages: 1 }`
Source: Derived from epic-details AC-1

### AC-2
**Given** esistono fornitori con `categoria = "RICAMBI"` e `categoria = "SERVIZI"`
**When** invio `GET /api/fornitori?categoria=RICAMBI`
**Then** ricevo `200` e tutti gli elementi in `data` hanno `categoria = "RICAMBI"`
Source: Derived from epic-details AC-2

### AC-3
**Given** esistono almeno i fornitori `{ nome: "Ricambi SRL Nord", codiceFornitore: "FOR-000101" }`, `{ nome: "Officina SRL Delta", codiceFornitore: "FOR-000102" }` e `{ nome: "Laboratorio Alfa", codiceFornitore: "FOR-000103" }`
**When** invio `GET /api/fornitori?search=SRL`
**Then** ricevo `200`, ogni elemento in `data` matcha `"srl"` in `nome` o `codiceFornitore` (case-insensitive), e almeno un elemento e' presente per match su `nome`
Source: Derived from epic-details AC-3

### AC-4
**Given** sono autenticato come `ADMIN`
**When** invio `GET /api/fornitori?limit=1000`
**Then** ricevo `400` con errore `{ error: { code: "VALIDATION_ERROR", details: { field: "limit", rule: "too_large" } } }`
Source: Quality validation extension (sad path required)

## Target Modules

- `packages/backend/src/routes/fornitori.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/__tests__/fornitori-list-search-atdd.spec.ts`
- `packages/shared/src/types/index.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): estendere `packages/backend/src/routes/fornitori.ts` con endpoint `GET /` che legge query `page`, `limit`, `search`, `categoria`, invoca il service e mappa `VALIDATION_ERROR -> 400`.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): introdurre in `packages/backend/src/services/anagrafiche-service.ts` i tipi `ListFornitoriInput`/`ListFornitoriResult` e parser validato per `page`, `limit`, `search`, `categoria` con regola `limit <= MAX_LIST_LIMIT`.
- [x] Task 3 (AC-1, AC-2, AC-3): implementare `listFornitoriInTestStore` in `packages/backend/src/services/anagrafiche-service.ts` con filtro categoria, ricerca case-insensitive su `nome`/`codiceFornitore`, ordinamento per `id` e `meta` paginata.
- [x] Task 4 (AC-1, AC-2, AC-3): implementare `listFornitoriInDatabase` in `packages/backend/src/services/anagrafiche-service.ts` con query Prisma (`where`, `OR`, `contains`, `mode: insensitive`, `skip`, `take`).
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/__tests__/fornitori-list-search-atdd.spec.ts` con test API per paginazione, filtro categoria, ricerca `SRL` su `nome`/`codiceFornitore` e sad path `limit=1000`.
- [x] Task 6 (AC-1): aggiornare `packages/shared/src/types/index.ts` se necessario per allineare i tipi response della lista fornitori (`data` + `meta`).

## Implementation Notes

- AC e dipendenze derivano da `docs/epics/epic-2-anagrafiche.md` (Story 2.5).
- Moduli target, pattern e rischi derivano da `docs/sprint-artifacts/story-brief-2.5.yaml`.
- Pattern principali da seguire: `packages/backend/src/routes/clienti.ts:172`, `packages/backend/src/services/anagrafiche-service.ts:1060`, `packages/backend/src/services/anagrafiche-service.ts:2198`, `packages/backend/src/services/anagrafiche-service.ts:2243`, `packages/backend/src/__tests__/clienti-list-search-atdd.spec.ts:57`.
- Verifica Task 6: nessun aggiornamento necessario in `packages/shared/src/types/index.ts` per completare gli AC backend di questa story.

## Validation Fixes Applied

1. Problema: AC-1 usava il placeholder non verificabile `data: [15 fornitori]`.
   Fix: sostituito con assert testabili su `data.length` e `meta` completa, inclusa `totalPages`.

2. Problema: AC-3 non era sufficientemente deterministico sui dati di match/non-match.
   Fix: introdotti esempi concreti con record specifici e vincolo esplicito di esclusione dei non-match.

3. Problema: mancava un sad path per input non valido, richiesto dalla validazione critica.
   Fix: aggiunta AC-4 per `limit=1000` con errore atteso `400 VALIDATION_ERROR` e dettagli validazione.
