---
status: ready-for-dev
priority: medium
estimate: M
story_id: "2.1"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.1: Creazione Cliente

**As a** Commerciale, **I want** to creare una nuova anagrafica cliente con dati fiscali validati, **so that** posso gestire correttamente le informazioni cliente.

## Acceptance Criteria

### AC-1
**Given** sono autenticato come utente applicativo e ho il payload `{ nome: "Rossi Mario", tipologia: "PRIVATO", codiceFiscale: "RSSMRA80A01H501U", telefono: "3331234567", email: "mario@test.it", indirizzo: "Via Roma 1", cap: "00100", citta: "Roma", provincia: "RM" }`  
**When** invio `POST /api/clienti` con quel payload  
**Then** ricevo `201` con body contenente almeno `{ id: <number>, codiceCliente: "CLI-000001" }` e il record cliente viene creato con i valori inviati  
Source: Derived from epic-details AC-1

### AC-2
**Given** sono autenticato e ho il payload `{ nome: "ACME SRL", tipologia: "AZIENDA", partitaIva: "12345678901", email: "acme@test.it", indirizzo: "Via Milano 10", cap: "20100", citta: "Milano", provincia: "MI" }`  
**When** invio `POST /api/clienti` con quel payload  
**Then** ricevo `201` e la partita IVA viene accettata solo se composta da 11 cifre, con cliente creato in tipologia `AZIENDA`  
Source: Derived from epic-details AC-2

### AC-3
**Given** sono autenticato e ho il payload `{ nome: "Mario Rossi", tipologia: "PRIVATO", codiceFiscale: "INVALID", email: "mario.invalid@test.it", indirizzo: "Via Roma 1", cap: "00100", citta: "Roma", provincia: "RM" }`  
**When** invio `POST /api/clienti` con quel payload  
**Then** ricevo `400` con errore di validazione `"Invalid fiscal code format"` associato al campo `codiceFiscale`  
Source: Derived from epic-details AC-3

### AC-4
**Given** esiste gia un cliente con email `"duplicate@test.it"`  
**When** invio `POST /api/clienti` con la stessa email `"duplicate@test.it"`  
**Then** ricevo `409` con errore `"EMAIL_ALREADY_EXISTS"`  
Source: Derived from epic-details AC-4

### AC-5
**Given** sono autenticato e ho il payload `{ nome: "Mario Rossi", tipologia: "PRIVATO", codiceFiscale: "RSSMRA80A01H501U", email: "cap.invalid@test.it", indirizzo: "Via Roma 1", cap: "ABC", citta: "Roma", provincia: "ZZ" }`  
**When** invio `POST /api/clienti` con quel payload  
**Then** ricevo `400` con errore di validazione sui campi `cap` e/o `provincia` (regole `invalid_cap` e `invalid_provincia`)  
Source: Derived from epic-details AC-5

## Target Modules

- packages/backend/src/routes/clienti.ts
- packages/backend/src/services/anagrafiche-service.ts
- packages/shared/src/validators/index.ts
- packages/backend/prisma/schema.prisma
- packages/backend/src/lib/errors.ts
- packages/backend/src/__tests__/audit-trail.spec.ts

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4, AC-5): aggiornare `packages/backend/src/routes/clienti.ts` per gestire payload completo e mappare in modo esplicito gli errori `400`/`409` con `buildErrorResponse`.
- [x] Task 2 (AC-1): allineare policy di autorizzazione in `packages/backend/src/routes/clienti.ts` al requisito "utente autenticato" (non solo `ADMIN`) o documentare fallback compatibile.
- [x] Task 3 (AC-1): modificare `CreateClienteInput` e parser in `packages/backend/src/services/anagrafiche-service.ts` per supportare i campi richiesti e auto-generare `codiceCliente` in formato `CLI-000001`.
- [x] Task 4 (AC-2, AC-3, AC-5): integrare i validatori fiscali/territoriali in `packages/shared/src/validators/index.ts` e applicarli in `packages/backend/src/services/anagrafiche-service.ts`.
- [x] Task 5 (AC-4): introdurre controllo unicita email in `packages/backend/src/services/anagrafiche-service.ts` con risposta errore `EMAIL_ALREADY_EXISTS`.
- [x] Task 6 (AC-4): allineare vincoli dati in `packages/backend/prisma/schema.prisma` per supportare il comportamento di conflitto su email.
- [x] Task 7 (AC-1, AC-2, AC-3, AC-4, AC-5): estendere i test API in `packages/backend/src/__tests__/audit-trail.spec.ts` o creare test dedicato per verificare tutti i `Then` con assert espliciti.

## Implementation Notes

- Le AC sono derivate integralmente da docs/epics/epic-2-anagrafiche.md (Story 2.1).
- Pattern di implementazione da seguire: handler route con mapping errori (packages/backend/src/routes/clienti.ts) e creazione con audit trail (packages/backend/src/services/anagrafiche-service.ts).
- Deviazione piano: la validazione fiscale/territoriale e stata consolidata direttamente in `packages/backend/src/services/anagrafiche-service.ts` mantenendo compatibilita con il contratto dei validator condivisi.

