---
status: ready-for-dev
priority: medium
estimate: M
story_id: "2.6"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.6: Dettaglio e Modifica Fornitore

**As an** Admin, **I want** to view and edit supplier details with order history, **so that** I can maintain supplier records.

## Dependencies

- 2.4
- 2.5

## Acceptance Criteria

### AC-1
**Given** sono autenticato come `ADMIN` ed esiste il fornitore `id=3` con dati `{ codiceFornitore: "FOR-000003", nome: "Ricambi Centro", categoria: "RICAMBI", partitaIva: "33333333334", telefono: "0612345678", email: "fornitore3@test.local", indirizzo: "Via Roma 10", cap: "00100", citta: "Roma", provincia: "RM" }`
**When** invio `GET /api/fornitori/3`
**Then** ricevo `200` e `body.data` contiene `id = 3` con campi `{ id, codiceFornitore, nome, cognome, ragioneSociale, categoria, partitaIva, codiceFiscale, indirizzo, citta, cap, provincia, telefono, email, note, createdAt, updatedAt }`
Source: Derived from epic-details AC-1

### AC-2
**Given** sono autenticato come `ADMIN` ed esiste il fornitore `id=3` con `telefono = "0612345678"` e `categoria = "RICAMBI"`
**When** invio `PUT /api/fornitori/3` con payload `{ telefono: "0687654321", categoria: "ALTRO" }`
**Then** ricevo `200`, il body contiene `id = 3`, `telefono = "0687654321"`, `categoria = "ALTRO"` e una successiva `GET /api/fornitori/3` restituisce gli stessi valori aggiornati
Source: Derived from epic-details AC-2

### AC-3
**Given** sono autenticato come `ADMIN` e il fornitore `id=3` ha esattamente `5` ordini associati con campi `{ id, numeroOrdine, stato, dataOrdine, totale }`
**When** invio `GET /api/fornitori/3/ordini`
**Then** ricevo `200` con `data` array di lunghezza `5` e ogni elemento espone esattamente i campi `{ id, numeroOrdine, stato, dataOrdine, totale }`
Source: Derived from epic-details AC-3

### AC-4
**Given** sono autenticato come `TECNICO`
**When** invio `PUT /api/fornitori/3` con payload `{ telefono: "0687654321", categoria: "ALTRO" }`
**Then** ricevo `403` con errore `{ error: { code: "FORBIDDEN", message: "Accesso negato" } }` e la risposta non espone campi `data` o `id`
Source: Derived from epic-details AC-4

## Target Modules

- `packages/backend/src/routes/fornitori.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/backend/src/__tests__/fornitori-detail-update-atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1): estendere `packages/backend/src/routes/fornitori.ts` con endpoint `GET /:id`, payload tipizzato `{ fornitoreId: req.params.id }`, chiamata service e mapping errori `VALIDATION_ERROR -> 400`, `NOT_FOUND -> 404 FORNITORE_NOT_FOUND`.
- [x] Task 2 (AC-1): aggiungere in `packages/backend/src/services/anagrafiche-service.ts` tipi `GetFornitoreByIdInput/GetFornitoreByIdResult`, parser `fornitoreId`, implementazioni `getFornitoreByIdInTestStore` e `getFornitoreByIdInDatabase` con risposta dettaglio completa.
- [x] Task 3 (AC-2): aggiornare `packages/backend/src/routes/fornitori.ts` per includere `categoria` nel payload di `PUT /:id` e mantenere envelope errori coerente con `packages/backend/src/lib/errors.ts`.
- [x] Task 4 (AC-2): estendere `packages/backend/src/services/anagrafiche-service.ts` in `parseUpdateFornitoreInput` per accettare `categoria` opzionale (`RICAMBI|SERVIZI|ALTRO`) mantenendo il vincolo `at_least_one_field_required`.
- [x] Task 5 (AC-2): aggiornare `updateFornitoreInTestStore` e `updateFornitoreInDatabase` in `packages/backend/src/services/anagrafiche-service.ts` per persistere `categoria` insieme a `telefono` e includere `categoria` nello snapshot audit `old/new`.
- [x] Task 6 (AC-3): estendere `packages/backend/prisma/schema.prisma` introducendo una relazione ordini-fornitore (model dedicato con campi `numeroOrdine`, `stato`, `dataOrdine`, `totale`) e aggiornare i mapping nel service.
- [x] Task 7 (AC-3): aggiungere in `packages/backend/src/services/anagrafiche-service.ts` tipi `ListFornitoreOrdiniInput/ListFornitoreOrdiniResult`, parser `fornitoreId`, implementazioni test-store/DB e gestione `NOT_FOUND` quando il fornitore non esiste.
- [x] Task 8 (AC-3): estendere `packages/backend/src/routes/fornitori.ts` con endpoint annidato `GET /:id/ordini`, payload tipizzato, mapping errori e risposta `200` con array `data`.
- [x] Task 9 (AC-1, AC-2, AC-3): creare `packages/backend/src/__tests__/fornitori-detail-update-atdd.spec.ts` con scenari ATDD su dettaglio, update con `categoria` e lista ordini, incluse asserzioni su shape campi.
- [x] Task 10 (AC-4): estendere `packages/backend/src/__tests__/fornitori-detail-update-atdd.spec.ts` con scenario `TECNICO -> 403 FORBIDDEN` su `PUT /api/fornitori/:id` e verifica assenza campi `data`.
- [x] Task 11 (AC-4): mantenere in `packages/backend/src/routes/fornitori.ts` la protezione `authorize("ADMIN")` sull'endpoint `PUT /:id` e verificare coerenza con `packages/backend/src/middleware/auth.ts`.
- [x] Task 12 (AC-1, AC-2, AC-3): nei test in `packages/backend/src/__tests__/fornitori-detail-update-atdd.spec.ts`, normalizzare il dataset creando i record necessari per rendere disponibile `id=3` prima delle asserzioni, in coerenza con il rischio fixture del brief.

## Implementation Notes

- AC e dipendenze derivano da `docs/epics/epic-2-anagrafiche.md` (Story 2.6, AC-1..AC-4).
- Moduli target, pattern e rischi derivano da `docs/sprint-artifacts/story-brief-2.6.yaml`.
- Pattern da seguire: route dettaglio in `packages/backend/src/routes/clienti.ts:189`, route annidata in `packages/backend/src/routes/clienti.ts:220`, validazione update con `at_least_one_field_required` in `packages/backend/src/services/anagrafiche-service.ts:1021`, audit update test-store in `packages/backend/src/services/anagrafiche-service.ts:1780`.
- Scope della story limitato agli endpoint e comportamenti richiesti dagli AC-1..AC-4.

## Validation Fixes Applied

1. Problema: AC-1 usava l'espressione ambigua "tutti i campi anagrafici" senza renderla verificabile in assert.
   Fix: AC-1 ora elenca esplicitamente il set di campi attesi nel payload `body.data`.

2. Problema: AC-4 conteneva il placeholder non testabile "payload valido".
   Fix: AC-4 ora usa un payload concreto `{ telefono: "0687654321", categoria: "ALTRO" }` e aggiunge asserzione di non esposizione dati.

3. Problema: il breakdown non copriva in modo esplicito la salvaguardia autorizzativa richiesta da AC-4.
   Fix: aggiunti task dedicati a test e verifica `authorize("ADMIN")` su `PUT /:id` (`Task 10` e `Task 11`).

4. Problema: i task AC-3 non esplicitavano in modo operativo la struttura dati ordini lato schema + service.
   Fix: Task 6/7/8 riscritti con sequenza concreta `schema -> service -> route` e campi ordine richiesti dagli AC.
