---
status: drafted
priority: high
estimate: M
story_id: "8.6"
epic: "Epic 8 - Portale Cliente"
---

# Story 8.6: Approvazione o Rifiuto Preventivo dal Portale

**As a** Cliente, **I want** to approve or reject my quote online, **so that** the repair can continue without manual phone confirmation.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** preventivo `id=5` belongs to the authenticated portal customer, is linked to riparazione `id=10`, and has `stato="INVIATO"`
**When** the customer sends `POST /api/portal/preventivi/5/risposta` with body `{ "approvato": true }` and a valid portal Bearer token
**Then** the API returns HTTP `200` with `data.id=5`, `data.stato="APPROVATO"`, and `data.riparazioneStato="APPROVATA"`

### AC-2
_Derived from epic-details AC-2._
**Given** preventivo `id=5` belongs to the authenticated portal customer, is linked to riparazione `id=10`, and has `stato="INVIATO"`
**When** the customer sends `POST /api/portal/preventivi/5/risposta` with body `{ "approvato": false }` and a valid portal Bearer token
**Then** the API returns HTTP `200` with `data.id=5`, `data.stato="RIFIUTATO"`, and `data.riparazioneStato="ANNULLATA"`

### AC-3
_Derived from epic-details AC-3._
**Given** preventivo `id=5` already has `stato="APPROVATO"` and `dataRisposta` is already set
**When** the customer sends `POST /api/portal/preventivi/5/risposta` with body `{ "approvato": true }` again for the same preventivo
**Then** the API returns HTTP `400` with `error.code="RESPONSE_ALREADY_RECORDED"`, `data` is absent, and the preventivo state remains `APPROVATO`

### AC-4
_Derived from epic-details AC-4._
**Given** preventivo `id=5` belongs to a riparazione owned by a different customer
**When** an authenticated portal customer sends `POST /api/portal/preventivi/5/risposta`
**Then** the API returns HTTP `403` with `error.code="FORBIDDEN"` and no response payload field `data.id` is exposed

## Target Modules

- `packages/backend/src/routes/auth.ts`
- `packages/backend/src/services/auth-service.ts`
- `packages/backend/src/services/preventivi-service.ts`
- `packages/backend/src/index.ts`
- `packages/backend/src/__tests__/portal-riparazioni-list-detail.atdd.spec.ts`
- `packages/backend/src/__tests__/preventivi-response-atdd.spec.ts`
- `packages/backend/src/__tests__/portal-preventivi-risposta.atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): add `POST /api/portal/preventivi/:id/risposta` in `packages/backend/src/routes/auth.ts`, reusing portal Bearer token guard and dedicated failure mapper pattern already used for `GET /api/portal/riparazioni/:id`.
- [x] Task 2 (AC-1, AC-2, AC-4): implement portal-specific use case in `packages/backend/src/services/auth-service.ts` that resolves `clienteId` from access token, loads preventivo/riparazione ownership, and blocks cross-customer access with `FORBIDDEN`.
- [x] Task 3 (AC-3): update `packages/backend/src/services/preventivi-service.ts` result contract (or mapped domain error) to expose a deterministic duplicate-response signal, then map it in `packages/backend/src/routes/auth.ts` to HTTP `400` with `error.code="RESPONSE_ALREADY_RECORDED"`.
- [x] Task 4 (AC-1..AC-4): add ATDD coverage in `packages/backend/src/__tests__/portal-preventivi-risposta.atdd.spec.ts` for approval path, rejection path, duplicate response rejection, and forbidden cross-customer access.
- [x] Task 5 (AC-1..AC-4): keep regression coverage coherent by reusing portal session helpers from `packages/backend/src/__tests__/portal-riparazioni-list-detail.atdd.spec.ts` and response-state assertions from `packages/backend/src/__tests__/preventivi-response-atdd.spec.ts`.

## Step 4 Validation Fixes

- Issue 1: AC-3 did not specify the exact second request payload, making the `When` partially implicit.
  Fix: bound the second request to `{ "approvato": true }` on the same endpoint.
- Issue 2: AC-3 did not constrain leakage of success payload on error.
  Fix: required `data` to be absent when `RESPONSE_ALREADY_RECORDED` is returned.
- Issue 3: AC-4 had a non-testable statement ("no detail payload is exposed") without a concrete assertion target.
  Fix: constrained the expected absence to `data.id`.
- Issue 4: Task 3 was ambiguous due "and/or" across modules and lacked a deterministic mapping point.
  Fix: split responsibility explicitly between `preventivi-service.ts` (domain signal) and `routes/auth.ts` (HTTP/code mapping).
