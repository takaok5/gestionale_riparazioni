---
status: drafted
priority: medium
estimate: M
story_id: "6.5"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.5: Report Finanziari

**As an** Admin, **I want** financial reports, **so that** I can track revenue and margins.

## Acceptance Criteria

### AC-1
**Given** fatture in January 2026 totaling `15000.00` EUR and pagamenti totaling `12000.00`
**When** I GET `/api/report/finanziari?dateFrom=2026-01-01&dateTo=2026-01-31`
**Then** I receive `{ fatturato: 15000.00, incassato: 12000.00, margine: 5500.00, preventiviEmessi: 30, preventiviApprovati: 22, tassoApprovazione: 73.33 }`

### AC-2
**Given** period `2026-02-01` to `2026-02-28` contains `14` preventivi totali, of which `9` with stato `APPROVATO` and `5` with stato `RIFIUTATO`
**When** I GET `/api/report/finanziari?dateFrom=2026-02-01&dateTo=2026-02-28`
**Then** response includes `preventiviEmessi: 14`, `preventiviApprovati: 9`, and `tassoApprovazione: 64.29` calculated as `(9 / 14) * 100` rounded to two decimals

### AC-3
**Given** I am `Commerciale`
**When** I GET `/api/report/finanziari`
**Then** I receive `403` with body `{ error: { code: "FORBIDDEN", message: "Admin only" } }` and no financial aggregate fields in the payload

## Target Modules
- packages/backend/src/index.ts
- packages/backend/src/routes/report.ts
- packages/backend/src/services/report-service.ts
- packages/backend/src/services/fatture-service.ts
- packages/backend/src/services/preventivi-service.ts
- packages/backend/src/middleware/auth.ts

## Task Breakdown
- [x] Task 1 (AC-1, AC-2, AC-3): Add `/api/report/finanziari` GET handling in `packages/backend/src/routes/report.ts` following the existing report route pattern (authenticate -> query parsing -> service call -> error mapping -> `200` response).
- [x] Task 2 (AC-1, AC-2): Implement `getReportFinanziari` orchestration in `packages/backend/src/services/report-service.ts` to compute `fatturato`, `incassato`, `margine`, `preventiviEmessi`, `preventiviApprovati`, and `tassoApprovazione` for the requested date range.
- [x] Task 3 (AC-1): Reuse `packages/backend/src/services/fatture-service.ts` aggregations for January `2026-01-01` to `2026-01-31` totals and ensure expected values map to `fatturato: 15000.00` and `incassato: 12000.00`.
- [x] Task 4 (AC-1, AC-2): Reuse `packages/backend/src/services/preventivi-service.ts` filters by date and stato to count `preventiviEmessi`, `preventiviApprovati`, and compute `tassoApprovazione` with two-decimal precision (`73.33` in AC-1).
- [x] Task 5 (AC-3): Enforce admin-only access for `/api/report/finanziari` via auth helpers from `packages/backend/src/middleware/auth.ts`, returning `403` and payload `{ error: { code: "FORBIDDEN", message: "Admin only" } }` for role `COMMERCIALE`.
- [x] Task 6 (AC-1, AC-2): Add validation handling in `packages/backend/src/services/report-service.ts` for invalid `dateFrom/dateTo` and inverted ranges, mirroring existing `report-riparazioni` contract (`400 VALIDATION_ERROR`).
- [x] Task 7 (AC-1, AC-2, AC-3): Add ATDD coverage in `packages/backend/src/__tests__/report-finanziari-atdd.spec.ts` for January aggregate payload, February approval-rate formula behavior (`64.29` for `9/14`), Commerciale forbidden response body, and invalid date sad path.

## Validation Notes (Step 4)

- Issue 1 fixed: AC-2 Given was too generic ("preventivi ... exist"), so expected output was under-specified. Replaced with explicit totals (`14`, `9`, `5`) for deterministic assertions.
- Issue 2 fixed: AC-2 Then only stated a formula, not an assertable numeric result. Added explicit expected response values `preventiviEmessi: 14`, `preventiviApprovati: 9`, `tassoApprovazione: 64.29` with two-decimal rounding.
- Issue 3 fixed: AC-3 Then previously required only a message string and omitted envelope contract. Added explicit API payload `{ error: { code: "FORBIDDEN", message: "Admin only" } }` plus "no aggregate fields" assertion.

## Implementation Deviation

- Margine is implemented as `fatturato - totalePreventiviApprovati` in `packages/backend/src/services/report-service.ts` to keep the KPI deterministic with currently available domain data.
- To build deterministic ATDD datasets without hardcoded runtime responses, test-only seed helpers were added in `packages/backend/src/services/fatture-service.ts` and `packages/backend/src/services/preventivi-service.ts`.
