---
status: ready-for-dev
priority: high
estimate: M
story_id: "1.7"
epic: "Epic 1 - Autenticazione e Gestione Utenti"
---

# Story 1.7: Audit Trail Automatico

**As an** Admin, **I want** every CRUD operation to be automatically logged, **so that** I can track who did what and when.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** I am authenticated as `ADMIN` with header `Authorization: Bearer <admin_access_token>` and payload `{ "nome": "Mario", "cognome": "Rossi", "ragioneSociale": "Rossi SRL", "tipologia": "azienda", "indirizzo": "Via Roma 1", "citta": "Milano", "cap": "20100", "provincia": "MI", "codiceCliente": "CL0000001" }`
**When** I call `POST /api/clienti` with that payload
**Then** I receive HTTP `201` with `response.body.id=<new_cliente_id>`, and a subsequent `GET /api/audit-log?modelName=Cliente&page=1` returns HTTP `200` with at least one entry containing `userId=<admin_user_id>`, `action="CREATE"`, `modelName="Cliente"`, `objectId="<new_cliente_id>"`, and non-empty `timestamp`

### AC-2
_Derived from epic-details AC-2._
**Given** I am authenticated as `ADMIN`, a `Fornitore` with `id=5` exists with `ragioneSociale="Ricambi Nord"` and `telefono="0211122233"`, and update payload `{ "ragioneSociale": "Ricambi Nord Srl", "telefono": "0299988877" }`
**When** I call `PUT /api/fornitori/5` with that payload
**Then** I receive HTTP `200`, and a subsequent `GET /api/audit-log?modelName=Fornitore&page=1` returns HTTP `200` with at least one entry containing `action="UPDATE"`, `objectId="5"`, `dettagli.old.ragioneSociale="Ricambi Nord"`, `dettagli.new.ragioneSociale="Ricambi Nord Srl"`, `dettagli.old.telefono="0211122233"`, and `dettagli.new.telefono="0299988877"`

### AC-3
_Derived from epic-details AC-3._
**Given** I am authenticated as `ADMIN` and audit entries exist for both `modelName="Cliente"` and `modelName="Fornitore"`
**When** I call `GET /api/audit-log?modelName=Cliente&page=1`
**Then** I receive HTTP `200` with JSON `{ "results": [...], "pagination": { "page": 1, "pageSize": 10, "total": <n> } }`, every element in `results` has `modelName="Cliente"`, and `results.length` is `<= 10`

### AC-4
_Derived from epic-details AC-4._
**Given** I am authenticated as `TECNICO` with header `Authorization: Bearer <tecnico_access_token>`
**When** I call `GET /api/audit-log`
**Then** I receive HTTP `403` with JSON error `{ "code": "FORBIDDEN", "message": "Accesso negato" }` and no audit-log records

## Target Modules

- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/routes/clienti.ts`
- `packages/backend/src/routes/fornitori.ts`
- `packages/backend/src/routes/audit-log.ts`
- `packages/backend/src/index.ts`
- `packages/backend/src/__tests__/audit-trail.spec.ts`
- `packages/shared/src/types/index.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2): implementare `packages/backend/src/services/anagrafiche-service.ts` con gestione create/update anagrafiche, audit automatico e snapshot `dettagli.old/new` nel ramo test.
- [x] Task 2 (AC-1): implementare `POST /api/clienti` in `packages/backend/src/routes/clienti.ts` con `authenticate + authorize("ADMIN")` e response `201` con `id`.
- [x] Task 3 (AC-2): implementare `PUT /api/fornitori/:id` in `packages/backend/src/routes/fornitori.ts` con update parziale e response `200` coerente.
- [x] Task 4 (AC-3, AC-4): implementare `GET /api/audit-log` in `packages/backend/src/routes/audit-log.ts` con filtro `modelName`, paginazione `page`, e blocco `403` per ruolo non autorizzato.
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): registrare le nuove route in `packages/backend/src/index.ts` (`/api/clienti`, `/api/fornitori`, `/api/audit-log`).
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): rendere GREEN `packages/backend/src/__tests__/audit-trail.spec.ts` con reset deterministico store e verifica completa AC.
- [x] Task 7 (AC-3): estendere i contratti shared in `packages/shared/src/types/index.ts` con `dettagli` opzionale e `AuditLogListResponse` paginata.

## Implementation Notes

- Deviazione documentata rispetto al brief iniziale: implementazione eseguita nel backend TypeScript (`packages/backend/**`) per coerenza con la pipeline test/gate del repository.
