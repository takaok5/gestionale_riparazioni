---
status: drafted
priority: medium
estimate: M
story_id: "6.4"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.4: Report Riparazioni

**As an** Admin, **I want** repair performance reports, **so that** I can analyze efficiency and bottlenecks.

## Acceptance Criteria

### AC-1
**Given** riparazioni completed in January 2026
**When** I GET `/api/report/riparazioni?dateFrom=2026-01-01&dateTo=2026-01-31`
**Then** I receive `totaleRiparazioni: 25`, `completate: 20`, `tempoMedioPerStato: { IN_DIAGNOSI: 2.5, IN_LAVORAZIONE: 5.0 }`, `tassoCompletamento: 80.0` and `countPerStato: { RICEVUTA: 1, COMPLETATA: 20, ANNULLATA: 4 }`

### AC-2
**Given** the seeded January 2026 dataset contains at least 3 riparazioni with `tecnicoId: 7` and at least 1 riparazione with `tecnicoId: 8`
**When** I GET `/api/report/riparazioni?tecnicoId=7`
**Then** I receive `200` and the aggregate payload is computed only on rows where `tecnicoId = 7`, with `totaleRiparazioni` equal to the number of returned source rows for tecnico `7` and `countPerStato` excluding rows assigned to other tecnici

### AC-3
**Given** I am Tecnico
**When** I GET `/api/report/riparazioni`
**Then** I receive `403` with body `{ error: { code: "FORBIDDEN", message: "Admin only" } }`

### AC-4
**Given** January 2026 includes stato-history durations where riparazioni in `IN_DIAGNOSI` sum to `10.0` days across `4` records and riparazioni in `IN_LAVORAZIONE` sum to `15.0` days across `3` records
**When** I GET `/api/report/riparazioni`
**Then** `tempoMedioPerStato` includes `IN_DIAGNOSI: 2.5` and `IN_LAVORAZIONE: 5.0` (rounded to one decimal when needed) and excludes stati without duration records

## Target Modules
- packages/backend/src/index.ts
- packages/backend/src/routes/dashboard.ts
- packages/backend/src/routes/riparazioni.ts
- packages/backend/src/routes/report.ts (new)
- packages/backend/src/services/dashboard-service.ts
- packages/backend/src/services/riparazioni-service.ts
- packages/backend/src/services/report-service.ts (new)
- packages/backend/src/middleware/auth.ts
- packages/backend/prisma/schema.prisma

## Task Breakdown
- [x] Task 1 (AC-1, AC-2, AC-4): Add `/api/report/riparazioni` GET route in `packages/backend/src/routes/report.ts` that reuses the `dashboard` routing pattern, validates query parameters, calls the report service, and maps failures through `buildErrorResponse`.
- [x] Task 2 (AC-1, AC-2, AC-3): Mount `reportRouter` in `packages/backend/src/index.ts` alongside the existing dashboard and riparazioni routers and ensure the global auth middleware enforces `authorize("ADMIN")` for the report endpoint.
- [x] Task 3 (AC-1, AC-2, AC-4): Implement `getReportRiparazioni` in `packages/backend/src/services/report-service.ts`, composing `packages/backend/src/services/riparazioni-service.ts` aggregates, computing `totaleRiparazioni`, `completate`, `tempoMedioPerStato`, `tassoCompletamento`, and `countPerStato` with the same reduction style as `dashboard-service.ts`.
- [x] Task 4 (AC-1, AC-2, AC-4): Extend `packages/backend/src/services/riparazioni-service.ts` to expose date-range and `tecnicoId` filters plus tempo-medio calculations, reusing the validation/where-clause logic outlined around lines 1254-1336 and ensuring Prisma queries hit the indexed fields defined in `packages/backend/prisma/schema.prisma`.
- [x] Task 5 (AC-3): Keep admin-only enforcement tight by consuming `packages/backend/src/middleware/auth.ts` helpers (authenticate + `authorize("ADMIN")`) inside `report.ts` and mirror the `buildErrorResponse` error contract used in `packages/backend/src/routes/dashboard.ts` to return `403 { error: { code: "FORBIDDEN", message: "Admin only" } }` when a Tecnico requests the report.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): Add an ATDD suite under `packages/backend/src/__tests__/report-riparazioni-atdd.spec.ts` that seeds the January dataset, asserts the January aggregates, the tecnico-filtered response, the Tecnico 403 body, and the `tempoMedioPerStato` averages.

## Validation Notes (Step 4)

- Issue 1 fixed: frontmatter `estimate` was `S` while epic defines complexity `M`; aligned to `M` for planning consistency.
- Issue 2 fixed: AC-2 had non-testable wording ("filtered only"); replaced with explicit `200` contract and aggregate-scope assertions on `tecnicoId=7`.
- Issue 3 fixed: AC-3/AC-4 lacked exact assertable contracts; added explicit `403` error body and concrete duration math with expected averages.

## Implementation Deviation

- Task 5 planned `authorize("ADMIN")` middleware for route-level guard, but implementation keeps `authenticate` in route and enforces admin-only in `report-service` to return the exact AC contract `403 { error: { code: "FORBIDDEN", message: "Admin only" } }` instead of middleware default message `Accesso negato`.
- Task 4 planned a direct extension of `riparazioni-service`; implementation keeps `riparazioni-service` unchanged and computes `tempoMedioPerStato` in `report-service` by combining `listRiparazioni` (filters) with `getRiparazioneDettaglio` (statiHistory), preserving existing service contracts.
