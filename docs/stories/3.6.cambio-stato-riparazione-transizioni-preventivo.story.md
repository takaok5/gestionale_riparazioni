---
story: '3.6'
title: 'Cambio Stato Riparazione (Transizioni Preventivo)'
status: ready-for-dev
priority: high
estimate: 6h
epic: 3
dependencies: ['3.5']
---

# Story 3.6: Cambio Stato Riparazione (Transizioni Preventivo)

## User Story
**As a** Tecnico, **I want** to manage repair status transitions related to quotations, **so that** the approval workflow is enforced.

## Acceptance Criteria

### AC 1 - IN_DIAGNOSI -> PREVENTIVO_EMESSO
Source: Derived from epic-details AC-1.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `IN_DIAGNOSI`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "PREVENTIVO_EMESSO", "note": "Preventivo emesso" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "PREVENTIVO_EMESSO" } }`, lo stato corrente diventa `PREVENTIVO_EMESSO`, e l'ultima entry di `statiHistory` risulta `{ stato: "PREVENTIVO_EMESSO", userId: 7, note: "Preventivo emesso" }` con `dataOra` ISO valida.

### AC 2 - PREVENTIVO_EMESSO -> IN_ATTESA_APPROVAZIONE
Source: Derived from epic-details AC-2.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `PREVENTIVO_EMESSO`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_ATTESA_APPROVAZIONE", "note": "In attesa approvazione preventivo" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_ATTESA_APPROVAZIONE" } }`, lo stato corrente diventa `IN_ATTESA_APPROVAZIONE`, e l'ultima entry di `statiHistory` risulta `{ stato: "IN_ATTESA_APPROVAZIONE", userId: 7, note: "In attesa approvazione preventivo" }`.

### AC 3 - IN_ATTESA_APPROVAZIONE -> APPROVATA
Source: Derived from epic-details AC-3.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `IN_ATTESA_APPROVAZIONE`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "APPROVATA", "note": "Preventivo approvato" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "APPROVATA" } }`, lo stato corrente diventa `APPROVATA`, e l'ultima entry di `statiHistory` risulta `{ stato: "APPROVATA", userId: 7, note: "Preventivo approvato" }`.

### AC 4 - IN_ATTESA_APPROVAZIONE -> ANNULLATA
Source: Derived from epic-details AC-4.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `IN_ATTESA_APPROVAZIONE`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "ANNULLATA", "note": "Preventivo annullato dal cliente" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "ANNULLATA" } }`, lo stato corrente diventa `ANNULLATA`, e l'ultima entry di `statiHistory` risulta `{ stato: "ANNULLATA", userId: 7, note: "Preventivo annullato dal cliente" }`.

### AC 5 - APPROVATA -> IN_ATTESA_RICAMBI
Source: Derived from epic-details AC-5.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `APPROVATA`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_ATTESA_RICAMBI", "note": "In attesa ricambi" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_ATTESA_RICAMBI" } }`, lo stato corrente diventa `IN_ATTESA_RICAMBI`, e l'ultima entry di `statiHistory` risulta `{ stato: "IN_ATTESA_RICAMBI", userId: 7, note: "In attesa ricambi" }`.

### AC 6 - APPROVATA -> IN_LAVORAZIONE
Source: Derived from epic-details AC-6.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `APPROVATA`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_LAVORAZIONE", "note": "Lavorazione autorizzata" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_LAVORAZIONE" } }`, lo stato corrente diventa `IN_LAVORAZIONE`, e l'ultima entry di `statiHistory` risulta `{ stato: "IN_LAVORAZIONE", userId: 7, note: "Lavorazione autorizzata" }`.

### AC 7 - IN_ATTESA_RICAMBI -> IN_LAVORAZIONE
Source: Derived from epic-details AC-7.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e la riparazione e' in stato `IN_ATTESA_RICAMBI`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_LAVORAZIONE", "note": "Ricambi disponibili" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_LAVORAZIONE" } }`, lo stato corrente diventa `IN_LAVORAZIONE`, e l'ultima entry di `statiHistory` risulta `{ stato: "IN_LAVORAZIONE", userId: 7, note: "Ricambi disponibili" }`.

### AC 8 - Transizione non valida da PREVENTIVO_EMESSO
Source: Validation fix for missing sad path (derived from transition rules in `riparazioni-service.ts`).

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, la riparazione e' in stato `PREVENTIVO_EMESSO`, e `statiHistory` ha lunghezza iniziale `N`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_LAVORAZIONE", "note": "Tentativo salto approvazione" }`.

**Then** ricevo `400` con `error.code = "VALIDATION_ERROR"` e `error.message = "Invalid state transition from PREVENTIVO_EMESSO to IN_LAVORAZIONE"`, lo stato resta `PREVENTIVO_EMESSO`, e `statiHistory` mantiene lunghezza `N`.

## Task Breakdown

- [x] Estendere `BASE_ALLOWED_TRANSITIONS` in `packages/backend/src/services/riparazioni-service.ts` con le transizioni preventivo richieste (`IN_DIAGNOSI -> PREVENTIVO_EMESSO`, `PREVENTIVO_EMESSO -> IN_ATTESA_APPROVAZIONE`, `IN_ATTESA_APPROVAZIONE -> APPROVATA|ANNULLATA`, `APPROVATA -> IN_ATTESA_RICAMBI|IN_LAVORAZIONE`, `IN_ATTESA_RICAMBI -> IN_LAVORAZIONE`) (copre AC-1..AC-7).
- [x] Verificare che `validateBaseTransition` e `buildInvalidTransitionMessage` in `packages/backend/src/services/riparazioni-service.ts` mantengano invariato il comportamento su transizioni non valide dopo l'estensione della matrice, inclusa `PREVENTIVO_EMESSO -> IN_LAVORAZIONE` (copre AC-8).
- [x] Confermare il comportamento coerente tra `cambiaStatoRiparazioneInTestStore` e `cambiaStatoRiparazioneInDatabase` in `packages/backend/src/services/riparazioni-service.ts` per aggiornamento stato e append su `statiHistory` / `riparazioneStatoHistory` (copre AC-1..AC-7).
- [x] Mantenere invariato il wiring route in `packages/backend/src/routes/riparazioni.ts` per `PATCH /api/riparazioni/:id/stato` e mapping errori con `respondCambiaStatoRiparazioneFailure` (copre AC-1..AC-8, allineamento API).
- [x] Aggiungere test ATDD RED in `packages/backend/src/__tests__/riparazioni-stato-preventivo-atdd.spec.ts` con 8 casi separati (AC-1..AC-8), assert su `status` HTTP, `data.stato` per successi e `error.code/error.message` per il sad path.
- [x] Per AC-1..AC-7 aggiungere assert su `GET /api/riparazioni/10` che verifichino `statiHistory` (stato, userId, note, timestamp ISO) oltre alla risposta della PATCH.
- [x] Per AC-8 aggiungere assert che verifichino stato invariato e nessuna nuova entry in `statiHistory` dopo `VALIDATION_ERROR`.
- [x] Eseguire regression mirata su `packages/backend/src/__tests__/riparazioni-stato-base-atdd.spec.ts` e `packages/backend/src/__tests__/riparazioni-detail-atdd.spec.ts` dopo le modifiche alle transizioni (copre stabilita' workflow stato + storico).

## Notes
- Le risposte errore devono mantenere il formato `{ error: { code, message, details } }`.
- Le transizioni preventivo devono convivere con le transizioni base senza introdurre percorsi non autorizzati.
