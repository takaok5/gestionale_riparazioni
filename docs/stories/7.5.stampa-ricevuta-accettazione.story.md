---
status: drafted
priority: medium
estimate: M
story_id: "7.5"
title: "Stampa Ricevuta Accettazione"
---

Tecnico must be able to print an intake receipt PDF for a repair so the customer receives formal acceptance proof with complete intake details.

### AC-1: PDF A4 ricevuta con sezioni obbligatorie (Derived from epic-details AC-1)
**Given** repair `id=10` exists with full intake data: customer `nome="Rossi Mario"`, `telefono="+39-333-1234567"`, `email="cliente@test.it"`, device `tipoDispositivo="Smartphone"`, `marcaDispositivo="Samsung"`, `modelloDispositivo="Galaxy S21"`, `serialeDispositivo="SN-REC-10"`, `descrizioneProblema="Schermo non si accende"`, `accessoriConsegnati="Caricabatterie, custodia"`, and `dataRicezione="2026-02-09T10:00:00.000Z"`
**When** `GET /api/riparazioni/10/ricevuta` is called by authenticated role `TECNICO`
**Then** API returns `200` with `Content-Type` containing `application/pdf`, `Content-Disposition` containing `filename="ricevuta-riparazione-10.pdf"`, binary body starting with `%PDF`, and PDF content includes customer section (nome/telefono/email), device section (tipo/marca/modello/seriale), `descrizioneProblema`, `accessoriConsegnati`, formatted `dataRicezione`, exact service conditions text `CONDIZIONI DI SERVIZIO: Il laboratorio non risponde di eventuali dati presenti sul dispositivo. Il cliente autorizza la diagnosi tecnica.` and signature label `Firma Cliente: ____________________`

### AC-2: Accessori consegnati mostrati per elemento (Derived from epic-details AC-2)
**Given** repair `id=10` has `accessoriConsegnati="Caricabatterie, custodia"`
**When** `GET /api/riparazioni/10/ricevuta` is called by authenticated role `TECNICO`
**Then** generated PDF contains separate accessory rows `- Caricabatterie` and `- custodia` in the accessories section, and does not contain merged token `Caricabatterie custodia`

### AC-3: Data ricezione formattata dd/MM/yyyy (Derived from epic-details AC-3)
**Given** repair `id=10` has `dataRicezione="2026-02-09T10:00:00.000Z"`
**When** `GET /api/riparazioni/10/ricevuta` is called by authenticated role `TECNICO`
**Then** generated PDF contains `09/02/2026` for `dataRicezione`

### AC-4: Richiesta non autenticata rifiutata (Derived from epic-details AC-4)
**Given** request has no `Authorization` header
**When** `GET /api/riparazioni/10/ricevuta` is called
**Then** API returns `401` with JSON body containing `error` and does not return a receipt PDF payload

### Tasks
- [x] AC-1: Add route `GET /api/riparazioni/:id/ricevuta` in `packages/backend/src/routes/riparazioni.ts` with auth middleware and PDF response headers aligned to existing `/etichetta`.
- [x] AC-1, AC-2, AC-3: Add service entrypoint in `packages/backend/src/services/riparazioni-service.ts` for receipt PDF generation with typed input parsing and error mapping (`VALIDATION_ERROR`, `NOT_FOUND`, `SERVICE_UNAVAILABLE`).
- [x] AC-1, AC-2, AC-3: Implement receipt PDF builder in `packages/backend/src/services/riparazioni-ricevuta-pdf.ts` reusing deterministic `%PDF` strategy from `packages/backend/src/services/riparazioni-etichetta-pdf.ts`.
- [x] AC-2: Normalize and split `accessoriConsegnati` in `packages/backend/src/services/riparazioni-service.ts` so each accessory is rendered as individual item in PDF content.
- [x] AC-1, AC-2, AC-3, AC-4: Add ATDD tests in `packages/backend/src/__tests__/riparazioni-ricevuta-atdd.spec.ts` covering headers/content contract, accessories split, formatted date, and unauthenticated `401`.
- [x] AC-1, AC-4: Keep route error handling consistent in `packages/backend/src/routes/riparazioni.ts` so `NOT_FOUND` maps to `RIPARAZIONE_NOT_FOUND` and unauthenticated requests are blocked before service invocation.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (`docs/epics/epic-7-notifiche-integrazioni.md:74`)
- AC-2: Derived from epic-details AC-2 (`docs/epics/epic-7-notifiche-integrazioni.md:75`)
- AC-3: Derived from epic-details AC-3 (`docs/epics/epic-7-notifiche-integrazioni.md:76`)
- AC-4: Derived from epic-details AC-4 (`docs/epics/epic-7-notifiche-integrazioni.md:77`)

### Validazione Step 4 - Issue e Fix Applicati
1. Problema: AC-1 non fissava testo condizioni/firma in modo deterministico, rendendo i test di contenuto fragili.
   Fix: AC-1 ora include stringa condizioni servizio e label firma esatte da verificare.
2. Problema: AC-2 richiedeva "lista accessori" ma senza formato verificabile su output PDF.
   Fix: AC-2 ora richiede righe `- Caricabatterie` e `- custodia` e vieta token unificato.
3. Problema: task implementativi usavano percorsi generici (`packages/backend/src/services/`, `packages/backend/src/__tests__/`) non tracciabili.
   Fix: task aggiornati con file specifici `riparazioni-ricevuta-pdf.ts` e `riparazioni-ricevuta-atdd.spec.ts`.
4. Problema: AC-4 usava solo testo "Unauthorized" senza contratto payload minimo verificabile.
   Fix: AC-4 ora vincola `401` con body JSON contenente `error` e assenza payload PDF.

AC count: 4
Task count: 6
