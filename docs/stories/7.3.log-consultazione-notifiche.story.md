---
status: drafted
priority: medium
estimate: S
---

Admin must be able to consult the notifications log with pagination and filters by tipo, stato, and date range, while non-admin roles are blocked.

### AC-1: Lista notifiche paginata con 20 risultati e meta (Derived from epic-details AC-1)
**Given** there are exactly `50` notifiche in store with fields `{ id, tipo, destinatario, oggetto, stato, dataInvio }`
**When** `GET /api/notifiche?page=1&limit=20` is called with `Authorization` of role `ADMIN`
**Then** API returns `200` with `data.length=20`, each row exposing `{ id, tipo, destinatario, oggetto, stato, dataInvio }`, rows sorted by `dataInvio` descending (tie-breaker `id` descending), and `meta` containing `page=1`, `limit=20`, `total=50`, `totalPages=3`

### AC-2: Filtro per tipo PREVENTIVO (Derived from epic-details AC-2)
**Given** notifications exist with both `tipo="STATO_RIPARAZIONE"` and `tipo="PREVENTIVO"`
**When** `GET /api/notifiche?tipo=PREVENTIVO` is called as `ADMIN`
**Then** API returns `200` and every `data[]` row has `tipo="PREVENTIVO"` with no rows of `STATO_RIPARAZIONE`

### AC-3: Filtro per stato FALLITA (Derived from epic-details AC-3)
**Given** notifications exist with both `stato="INVIATA"` and `stato="FALLITA"`
**When** `GET /api/notifiche?stato=FALLITA` is called as `ADMIN`
**Then** API returns `200` and every `data[]` row has `stato="FALLITA"`

### AC-4: Filtro intervallo date febbraio 2026 (Derived from epic-details AC-4)
**Given** notifications exist with `dataInvio` values `2026-01-31T23:59:59.999Z`, `2026-02-01T00:00:00.000Z`, `2026-02-15T12:00:00.000Z`, `2026-02-28T23:59:59.999Z`, and `2026-03-01T00:00:00.000Z`
**When** `GET /api/notifiche?dataDa=2026-02-01&dataA=2026-02-28` is called as `ADMIN`
**Then** API returns `200`, includes rows on exact boundaries `2026-02-01T00:00:00.000Z` and `2026-02-28T23:59:59.999Z`, excludes out-of-range rows from `2026-01-31` and `2026-03-01`, and each returned row has `dataInvio` between `2026-02-01T00:00:00.000Z` and `2026-02-28T23:59:59.999Z`

### AC-5: Endpoint solo Admin (Derived from epic-details AC-5)
**Given** caller is authenticated with role `TECNICO`
**When** `GET /api/notifiche` is called
**Then** API returns `403` with error code `FORBIDDEN` and message `Admin only`

### Tasks
- [x] AC-1, AC-2, AC-3, AC-4: Extend query parsing in `packages/backend/src/routes/notifiche.ts` to forward `dataDa` and `dataA` along with `page`, `limit`, `tipo`, `stato`
- [x] AC-1, AC-2, AC-3, AC-4: Extend `packages/backend/src/services/notifiche-service.ts` list query model and filter pipeline to support date-range filtering plus stable pagination metadata and deterministic sort
- [x] AC-4: Add date parsing/validation helpers in `packages/backend/src/services/notifiche-service.ts` for ISO date-only input (`YYYY-MM-DD`) with inclusive boundaries
- [x] AC-5: Implement endpoint-specific `403` contract (`FORBIDDEN`, `Admin only`) for `/api/notifiche` using `packages/backend/src/routes/notifiche.ts` and, only if necessary, a non-breaking extension in `packages/backend/src/middleware/auth.ts`
- [x] AC-1..AC-5: Add ATDD coverage in `packages/backend/src/__tests__/notifiche-list-atdd.spec.ts` for pagination, deterministic ordering, tipo filter, stato filter, date-range filter, and `403` for `TECNICO`
- [x] AC-1..AC-4: Reuse setup helpers from `packages/backend/src/__tests__/preventivi-notifiche-atdd.spec.ts` and `packages/backend/src/__tests__/riparazioni-stato-notifiche-atdd.spec.ts` to seed notification data deterministically

AC count: 5
Task count: 6
