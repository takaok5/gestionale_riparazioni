---
status: drafted
priority: high
estimate: M
story_id: "4.6"
title: "Registrazione Pagamento"
---

# Story 4.6: Registrazione Pagamento

## User Story
Come Commerciale voglio registrare i pagamenti del cliente cosi' che lo stato della fattura resti aggiornato e tracciabile.

## Acceptance Criteria (Expanded)

### AC-1
**Given** la fattura `id=8` ha `totale=244.00` e non esistono pagamenti associati.
**When** invio `POST /api/fatture/8/pagamenti` con payload `{ "importo": 244.00, "metodo": "CONTANTE", "dataPagamento": "2026-02-09" }` autenticato come Commerciale.
**Then** ricevo HTTP `201` con `data.fatturaId=8`, `data.importo=244.00`, `data.metodo="CONTANTE"`, `data.fattura.stato="PAGATA"` e `data.fattura.residuo=0.00`.

### AC-2
**Given** la fattura `id=8` ha `totale=244.00` ed esiste gia' un pagamento da `100.00`.
**When** invio `POST /api/fatture/8/pagamenti` con payload `{ "importo": 144.00, "metodo": "BONIFICO" }`.
**Then** ricevo HTTP `201`, viene creato un secondo pagamento e la risposta include `data.fattura.totalePagato=244.00`, `data.fattura.residuo=0.00` e `data.fattura.stato="PAGATA"`.

### AC-3
**Given** la fattura `id=8` ha `totale=244.00` e i pagamenti esistenti totalizzano `244.00`.
**When** invio `POST /api/fatture/8/pagamenti` con payload `{ "importo": 10.00 }`.
**Then** ricevo HTTP `400` con messaggio errore esatto `"Total payments would exceed invoice total"` e il numero di pagamenti associati alla fattura `id=8` resta invariato.

### AC-4
**Given** la fattura `id=8` ha un pagamento esistente da `100.00`.
**When** invio `GET /api/fatture/8`.
**Then** ricevo HTTP `200` con `data.id=8`, `data.pagamenti` contenente almeno una riga con `importo=100.00` e `data.residuo=144.00`.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (docs/epics/epic-4-preventivi-fatturazione.md:91)
- AC-2: Derived from epic-details AC-2 (docs/epics/epic-4-preventivi-fatturazione.md:92)
- AC-3: Derived from epic-details AC-3 (docs/epics/epic-4-preventivi-fatturazione.md:93)
- AC-4: Derived from epic-details AC-4 (docs/epics/epic-4-preventivi-fatturazione.md:94)

## Task Breakdown
- [x] Estendere il dominio pagamenti in `packages/backend/src/services/fatture-service.ts` con funzione di registrazione pagamento, validazione overpayment e aggiornamento stato fattura (copertura AC-1, AC-2, AC-3).
- [x] Estendere `packages/backend/src/routes/fatture.ts` con endpoint `POST /api/fatture/:id/pagamenti` includendo autorizzazione ruolo, parsing payload e mapping errori `400/404/500` (copertura AC-1, AC-2, AC-3).
- [x] Implementare endpoint `GET /api/fatture/:id` in `packages/backend/src/routes/fatture.ts` e relativo servizio in `packages/backend/src/services/fatture-service.ts` con dati pagamento aggregati (copertura AC-4).
- [x] Aggiungere test ATDD in `packages/backend/src/__tests__/fatture-pagamenti-atdd.spec.ts` per i 4 scenari AC con assert su status code, error message, stato fattura e importi pagati/residuo.
- [x] Aggiornare `docs/sprint-artifacts/story-4.6-ATDD-MAP.md` con la mappatura scenario -> test case per mantenere tracciabilita' AC.

## Note Tecniche
- Riutilizzare il mapping errori applicato in `packages/backend/src/routes/fatture.ts` per uniformita' API.
- Gestire gli importi con arrotondamento a 2 decimali per evitare errori cumulativi sui pagamenti parziali.
- Mantenere struttura risposta coerente con gli endpoint esistenti (`{ data }` oppure `{ error: { code, message } }`).

## Validazione Step 4 - Issue e Fix Applicati
1. Problema: AC-1 non definiva campi risposta specifici, quindi il `Then` era parzialmente ambiguo.
   Fix: AC-1 ora vincola campi testabili su pagamento e stato/residuo fattura.
2. Problema: AC-2 non esplicitava totale pagato e residuo dopo il secondo pagamento.
   Fix: AC-2 ora richiede `totalePagato=244.00` e `residuo=0.00`, rendendo il controllo deterministico.
3. Problema: AC-4 non includeva HTTP status e percorso dati preciso nella risposta.
   Fix: AC-4 ora richiede HTTP `200` e campi `data.id`, `data.pagamenti[]`, `data.residuo` verificabili in test.
