---
status: ready-for-dev
priority: medium
estimate: M
story_id: "2.3"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.3: Dettaglio e Modifica Cliente

**As a** Commerciale, **I want** to view and edit customer details with repair history, **so that** I can maintain accurate customer records.

## Dependencies

- 2.1
- 2.2

## Acceptance Criteria

### AC-1
**Given** esiste il cliente `id=5` con dati `{ codiceCliente: "CLI-000004", nome: "Cliente Story 4", tipologia: "AZIENDA", telefono: "3331234504", email: "story23-4@test.it", indirizzo: "Via Story 4", cap: "20100", citta: "Milano", provincia: "MI" }`
**When** invio `GET /api/clienti/5`
**Then** ricevo `200` e il body contiene `data.id = 5`, `data.codiceCliente` valorizzato e tutti i campi anagrafici del cliente richiesti dalla story
Source: Derived from epic-details AC-1

### AC-2
**Given** non esiste alcun cliente con `id=999`
**When** invio `GET /api/clienti/999`
**Then** ricevo `404` con errore `{ error: { code: "CLIENTE_NOT_FOUND" } }`
Source: Derived from epic-details AC-2

### AC-3
**Given** esiste il cliente `id=5` con `telefono = "3331234567"` e `email = "mario@test.it"`
**When** invio `PUT /api/clienti/5` con payload `{ telefono: "3339876543", email: "newemail@test.it" }`
**Then** ricevo `200` e il body contiene `data.id = 5`, `data.telefono = "3339876543"`, `data.email = "newemail@test.it"`
Source: Derived from epic-details AC-3

### AC-4
**Given** il cliente `id=5` ha esattamente `3` riparazioni associate e ogni riparazione ha i campi `{ id, codiceRiparazione, stato, dataRicezione, tipoDispositivo }`
**When** invio `GET /api/clienti/5/riparazioni`
**Then** ricevo `200` con `data` array di lunghezza `3` e ogni elemento espone esattamente i campi `{ id, codiceRiparazione, stato, dataRicezione, tipoDispositivo }`
Source: Derived from epic-details AC-4

## Target Modules

- `packages/backend/src/routes/clienti.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/prisma/schema.prisma`
- `anagrafiche/models.py`
- `packages/backend/src/__tests__/clienti-detail-update-atdd.spec.ts`
- `packages/backend/src/__tests__/audit-trail.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2): estendere `packages/backend/src/routes/clienti.ts` con `GET /api/clienti/:id` e mapping errori dominio -> HTTP (`NOT_FOUND` -> `CLIENTE_NOT_FOUND`, status `404`).
- [x] Task 2 (AC-3): estendere `packages/backend/src/routes/clienti.ts` con `PUT /api/clienti/:id` per update parziale di `telefono` e `email`, con response `200` e payload aggiornato.
- [x] Task 3 (AC-4): aggiungere in `packages/backend/src/routes/clienti.ts` l'endpoint `GET /api/clienti/:id/riparazioni` con risposta array nei campi richiesti.
- [x] Task 4 (AC-1, AC-2): aggiungere in `packages/backend/src/services/anagrafiche-service.ts` i metodi service per recupero dettaglio cliente e gestione not-found.
- [x] Task 5 (AC-3): aggiungere in `packages/backend/src/services/anagrafiche-service.ts` il metodo di update cliente con validazione input e ritorno payload aggiornato.
- [x] Task 6 (AC-4): aggiungere in `packages/backend/src/services/anagrafiche-service.ts` il metodo di recupero riparazioni per `clienteId` con shape `{ id, codiceRiparazione, stato, dataRicezione, tipoDispositivo }`.
- [x] Task 7 (AC-4): verificare/aggiornare `packages/backend/prisma/schema.prisma` per supportare la relazione cliente-riparazioni necessaria all'endpoint.
- [x] Task 8 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/__tests__/clienti-detail-update-atdd.spec.ts` con scenari RED per `GET /api/clienti/:id`, `GET /api/clienti/999`, `PUT /api/clienti/:id`, `GET /api/clienti/:id/riparazioni`.
- [x] Task 9 (AC-3): estendere `packages/backend/src/__tests__/audit-trail.spec.ts` per mantenere coerenza audit sull'update cliente.
- [x] Task 10 (AC-4): verificare l'impatto cross-stack in `anagrafiche/models.py` e documentare eventuale non-scope implementativo nel summary della story.

## Implementation Notes

- AC e dipendenze derivano da `docs/epics/epic-2-anagrafiche.md` (Story 2.3).
- Vincoli tecnici e moduli target derivano da `docs/sprint-artifacts/story-brief-2.3.yaml`.
- Pattern da seguire: mapping errori route in `packages/backend/src/routes/fornitori.ts:17`, update route con `/:id` in `packages/backend/src/routes/users.ts:195`, query service in `packages/backend/src/services/anagrafiche-service.ts:1251`.
- Prisma schema esteso con `model Riparazione` + relazione `Cliente.riparazioni` e Prisma Client rigenerato.
- Verifica cross-stack eseguita: implementazione applicata al backend TypeScript (`packages/backend/**`), nessuna modifica al codice Django (`anagrafiche/models.py`).

## Validation Fixes Applied

1. Problema: testo story corrotto (escape non valido su backtick) con campi/path non leggibili (`telefono`, `anagrafiche/models.py`).
   Fix: riscritta la story in formato markdown pulito con path e campi ASCII corretti.

2. Problema: AC-1 era ambigua su "dati completi" e non specificava valori verificabili in assert.
   Fix: AC-1 ora elenca i campi concreti e gli assert minimi (`id`, `codiceCliente`, campi anagrafici richiesti).

3. Problema: AC-4 non rendeva verificabile in modo deterministico la shape della lista riparazioni.
   Fix: AC-4 ora impone `data.length = 3` e set di campi obbligatorio per ogni elemento.

4. Problema: Task test puntavano a file lista/ricerca esistente, riducendo tracciabilita story-specifica.
   Fix: introdotto task esplicito per nuovo file `clienti-detail-update-atdd.spec.ts` dedicato alla story 2.3.
