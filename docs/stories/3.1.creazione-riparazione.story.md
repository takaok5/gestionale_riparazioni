---
status: ready-for-dev
priority: medium
estimate: M
story_id: "3.1"
epic: "Epic 3 - Gestione Riparazioni"
---

# Story 3.1: Creazione Riparazione

**As a** Tecnico, **I want** to create a new repair record, **so that** I can track a device from intake to delivery.

## Dependencies

- none

## Acceptance Criteria

### AC-1
**Given** sono autenticato come utente applicativo e il cliente `id=5` esiste in anagrafica
**When** invio `POST /api/riparazioni` con payload `{ clienteId: 5, tipoDispositivo: "Smartphone", marcaDispositivo: "Samsung", modelloDispositivo: "Galaxy S21", serialeDispositivo: "SN123456789", descrizioneProblema: "Schermo rotto", accessoriConsegnati: "Caricabatterie, custodia", priorita: "NORMALE" }`
**Then** ricevo `201` e la risposta contiene una riparazione con `id` numerico, `codiceRiparazione = "RIP-20260209-0001"`, `stato = "RICEVUTA"`, `clienteId = 5` e i campi dispositivo uguali al payload inviato
Source: Derived from epic-details AC-1

### AC-2
**Given** la data applicativa e fissata a `2026-02-09` e nel sistema esistono gia i codici `RIP-20260209-0001`, `RIP-20260209-0002`, `RIP-20260209-0003`, `RIP-20260209-0004`, `RIP-20260209-0005`
**When** invio un nuovo `POST /api/riparazioni` valido
**Then** la nuova riparazione viene creata con `codiceRiparazione = "RIP-20260209-0006"`
Source: Derived from epic-details AC-2

### AC-3
**Given** sono autenticato e il cliente `id=999` non esiste
**When** invio `POST /api/riparazioni` con payload valido tranne `clienteId = 999`
**Then** ricevo `404` con errore `{ error: { code: "CLIENTE_NOT_FOUND", message: "Cliente non trovato" } }` e la risposta non contiene campi di creazione riparazione
Source: Derived from epic-details AC-3

### AC-4
**Given** sono autenticato e preparo un payload di creazione riparazione senza il campo obbligatorio `tipoDispositivo`
**When** invio `POST /api/riparazioni` con quel payload incompleto
**Then** ricevo `400` con errore `VALIDATION_ERROR` che include il messaggio `"tipoDispositivo is required"` e un dettaglio validazione riferito al campo `tipoDispositivo`
Source: Derived from epic-details AC-4

## Target Modules

- `packages/backend/src/index.ts`
- `packages/backend/prisma/schema.prisma`
- `packages/shared/src/types/index.ts`
- `packages/backend/src/routes/riparazioni.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/src/__tests__/riparazioni-create-atdd.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2): estendere `packages/backend/prisma/schema.prisma` con i campi mancanti del modello `Riparazione` (`marcaDispositivo`, `modelloDispositivo`, `serialeDispositivo`, `descrizioneProblema`, `accessoriConsegnati`, `priorita`) e introdurre indice utile per la generazione sequenziale giornaliera del codice (mantenendo `stato` esistente con default coerente alla creazione).
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/services/riparazioni-service.ts` con parser input, validazioni campi obbligatori, verifica esistenza cliente, generazione transazionale `codiceRiparazione` formato `RIP-YYYYMMDD-####` e create iniziale con stato `RICEVUTA`.
- [x] Task 3 (AC-1, AC-3, AC-4): creare `packages/backend/src/routes/riparazioni.ts` con endpoint `POST /`, middleware `authenticate`, mapping errori `VALIDATION_ERROR -> 400`, `CLIENTE_NOT_FOUND -> 404` e risposta `201` su successo.
- [x] Task 4 (AC-1): registrare il router in `packages/backend/src/index.ts` tramite `app.use("/api/riparazioni", riparazioniRouter)` mantenendo l'ordine coerente con gli altri moduli API.
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): estendere tipi condivisi in `packages/shared/src/types/index.ts` con payload/response della creazione riparazione per mantenere contratto tipizzato backend/frontend.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/__tests__/riparazioni-create-atdd.spec.ts` con casi ATDD espliciti per i quattro AC, inclusi assert su `201`, codice incrementale giornaliero, `404 CLIENTE_NOT_FOUND` e `400` con messaggio su `tipoDispositivo`.

## Implementation Notes

- AC e vincoli derivano da `docs/epics/epic-3-riparazioni.md` (Story 3.1, AC-1..AC-4).
- Pattern da seguire: route create con response envelope in `packages/backend/src/routes/clienti.ts:234`, mapping errori in `packages/backend/src/routes/clienti.ts:37`, validazioni parser in `packages/backend/src/services/anagrafiche-service.ts:854`, create transazionale con codice progressivo in `packages/backend/src/services/anagrafiche-service.ts:1661`.
- Rischio principale: collisioni del progressivo giornaliero in creazioni concorrenti; mitigare usando transazione e query consistente nello stesso contesto Prisma.

## Validation Fixes Applied

1. Problema: in AC-1, AC-3 e AC-4 il `Given` includeva gia l'azione `POST`, lasciando `When` poco netto.
   Fix: separati stato iniziale (`Given`) e azione singola (`When`) in tutti gli AC.

2. Problema: AC-2 era poco deterministico sulla base dati per il progressivo giornaliero.
   Fix: specificati data applicativa `2026-02-09` e codici preesistenti `0001..0005` per rendere il `Then` verificabile.

3. Problema: AC-3 non specificava completamente il contratto errore.
   Fix: aggiunti `message` atteso e vincolo di assenza campi di creazione nella risposta.

4. Problema: Task 1 richiedeva di aggiungere `stato` nello schema, ma `stato` esiste gia nel modello `Riparazione`.
   Fix: task corretto sui soli campi mancanti e mantenimento `stato` esistente con default coerente.
