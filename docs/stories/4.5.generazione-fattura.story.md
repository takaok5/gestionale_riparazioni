---
status: drafted
priority: high
estimate: M
story_id: "4.5"
title: "Generazione Fattura"
---

# Story 4.5: Generazione Fattura

## User Story
Come Commerciale voglio generare una fattura da un preventivo approvato cosi' che la riparazione possa essere fatturata con importi coerenti e tracciabili.

## Acceptance Criteria (Expanded)

### AC-1
**Given** esiste il preventivo `id=5` in stato `APPROVATO` con voci che producono `subtotale=200.00`, `iva=44.00`, `totale=244.00`, associato alla riparazione `id=10`.
**When** invio `POST /api/fatture` con payload `{ "riparazioneId": 10 }` autenticato come Commerciale.
**Then** ricevo HTTP `201` con body `data` contenente `riparazioneId=10`, `numeroFattura="2026/0001"`, `stato="EMESSA"`, `subtotale=200.00`, `iva=44.00`, `totale=244.00`, `pdfPath` stringa non vuota e voci copiate dal preventivo approvato.

### AC-2
**Given** la data corrente e' `2026-02-09`, esiste la riparazione `id=11` con preventivo `APPROVATO` e l'ultima fattura emessa nell'anno 2026 ha numero `2026/0015`.
**When** invio `POST /api/fatture` con payload `{ "riparazioneId": 11 }`.
**Then** ricevo HTTP `201` e il body risposta contiene `data.numeroFattura="2026/0016"` senza duplicati nell'anno 2026.

### AC-3
**Given** la riparazione `id=10` non ha alcun preventivo in stato `APPROVATO`.
**When** invio `POST /api/fatture` con payload `{ "riparazioneId": 10 }`.
**Then** ricevo HTTP `400` con messaggio errore esatto `"No approved preventivo found for this riparazione"` e nessuna fattura viene persistita.

### AC-4
**Given** esiste gia' una fattura associata alla riparazione `id=10`.
**When** invio `POST /api/fatture` con payload `{ "riparazioneId": 10 }`.
**Then** ricevo HTTP `409` con messaggio errore esatto `"Invoice already exists for this riparazione"` e il numero totale di fatture collegate a `riparazioneId=10` resta invariato a `1`.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (docs/epics/epic-4-preventivi-fatturazione.md:74)
- AC-2: Derived from epic-details AC-2 (docs/epics/epic-4-preventivi-fatturazione.md:75)
- AC-3: Derived from epic-details AC-3 (docs/epics/epic-4-preventivi-fatturazione.md:76)
- AC-4: Derived from epic-details AC-4 (docs/epics/epic-4-preventivi-fatturazione.md:77)

## Task Breakdown
- [ ] Aggiungere i modelli Prisma per fatturazione in `packages/backend/prisma/schema.prisma` (entita' fattura, righe fattura, eventuale collegamento alla riparazione/preventivo) e preparare migration coerente per persistenza reale (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Implementare il servizio di dominio in `packages/backend/src/services/fatture-service.ts` con creazione fattura da preventivo approvato, calcolo importi, validazioni business e generazione numero progressivo `YYYY/NNNN` in modo atomico (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Implementare la route API in `packages/backend/src/routes/fatture.ts` con endpoint `POST /api/fatture`, parsing payload `{ riparazioneId }`, autorizzazione, mapping errori `400/409/500` e risposta `201` (copertura AC-1, AC-3, AC-4).
- [x] Registrare il router fatture in `packages/backend/src/index.ts` mantenendo il pattern route esistente con mount `app.use("/api/fatture", fattureRouter)` (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Aggiungere test ATDD backend in `packages/backend/src/__tests__/fatture-create-atdd.spec.ts` per i 4 scenari AC con assert su status HTTP, messaggi errore e contenuto risposta (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Integrare la generazione PDF nel nuovo modulo `packages/backend/src/services/fatture-pdf-service.ts`, con assert su `pdfPath` non nullo nei test (copertura AC-1).

## Note Tecniche
- Riutilizzare il pattern route `payload -> service -> mappatura errore` visto in `packages/backend/src/routes/preventivi.ts`.
- Riutilizzare la logica di arrotondamento importi a 2 decimali coerente con `computeTotals` in `packages/backend/src/services/preventivi-service.ts`.
- Garantire idempotenza applicativa rispetto a doppia emissione su stessa `riparazioneId`.

## Blocker
- [ ] Persistenza Prisma non completata in questa iterazione: `packages/backend/prisma/schema.prisma` non e' stato esteso con modelli fattura/righe e relativa migration. L'implementazione GREEN corrente copre i test ATDD in ambiente `NODE_ENV=test` tramite test-store in memoria.

## Validazione Step 4 - Issue e Fix Applicati
1. Problema: AC-2 usava il testo generico "payload valido", non testabile in modo univoco.
   Fix: AC-2 ora specifica il payload `{ "riparazioneId": 11 }` e il precondizionale completo sulla riparazione con preventivo approvato.
2. Problema: AC-1 indicava "PDF generato" senza un campo di risposta verificabile.
   Fix: AC-1 ora richiede esplicitamente `data.pdfPath` stringa non vuota nel body HTTP 201.
3. Problema: AC-4 non definiva un'invariante misurabile contro la doppia fatturazione.
   Fix: AC-4 ora vincola che il totale fatture per `riparazioneId=10` resti `1`.
