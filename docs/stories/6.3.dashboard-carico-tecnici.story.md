---
status: drafted
priority: medium
estimate: S
story_id: "6.3"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.3: Dashboard Carico Tecnici

**As an** Admin, **I want** to see workload per technician, **so that** I can balance assignments.

## Acceptance Criteria

### AC-1
**Given** tecnico id=7 has 6 riparazioni with stato IN_DIAGNOSI or IN_LAVORAZIONE and tecnico id=8 has 3 riparazioni with stato IN_DIAGNOSI or IN_LAVORAZIONE  
**When** I GET /api/dashboard/carico-tecnici with a valid Admin token  
**Then** I receive 200 with JSON array exactly containing entries { tecnicoId: 7, username: "mario.rossi", nome: "Mario Rossi", riparazioniAttive: 6 } and { tecnicoId: 8, username: "anna.verdi", nome: "Anna Verdi", riparazioniAttive: 3 }

### AC-2
**Given** authenticated users include Admin, Tecnico and Commerciale roles and the user dataset contains users with roles ADMIN, TECNICO, COMMERCIALE  
**When** I GET /api/dashboard/carico-tecnici with a valid Admin token  
**Then** I receive 200 and response entries include only users with role TECNICO

### AC-3
**Given** an authenticated user with role TECNICO  
**When** the user GETs /api/dashboard/carico-tecnici  
**Then** the API returns 403 with error code FORBIDDEN and message Admin only

## Target Modules

- packages/backend/src/routes/dashboard.ts
- packages/backend/src/services/dashboard-service.ts
- packages/backend/src/services/riparazioni-service.ts
- packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts
- packages/backend/src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts

## Task Breakdown

- [ ] Task 1 (AC-1, AC-2, AC-3): add authenticated GET /carico-tecnici route in packages/backend/src/routes/dashboard.ts with service call and explicit error mapping for VALIDATION_ERROR and FORBIDDEN.
- [ ] Task 2 (AC-1, AC-2, AC-3): implement getDashboardCaricoTecnici (or equivalent) in packages/backend/src/services/dashboard-service.ts with validation of ctorUserId/ctorRole, Admin-only guard, and deterministic array output.
- [ ] Task 3 (AC-1, AC-2): aggregate active repairs (IN_DIAGNOSI, IN_LAVORAZIONE) by technician and include 	ecnicoId, username, 
ome, iparazioniAttive using data retrieval in packages/backend/src/services/riparazioni-service.ts or dedicated helper query.
- [ ] Task 4 (AC-2): ensure non-technical roles are excluded from output at service/query level, with regression-safe handling for inactive or missing technician records.
- [ ] Task 5 (AC-1, AC-2, AC-3): extend packages/backend/src/__tests__/dashboard-operativa-atdd.spec.ts and/or packages/backend/src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts with scenarios for payload shape/counts, TECNICO-only filtering, and 403 on non-Admin callers.