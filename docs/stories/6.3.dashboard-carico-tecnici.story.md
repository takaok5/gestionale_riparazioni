---
status: drafted
priority: medium
estimate: S
story_id: "6.3"
epic: "Epic 6 - Dashboard e Reportistica"
---

# Story 6.3: Dashboard Carico Tecnici

**As an** Admin, **I want** to see workload per technician, **so that** I can balance assignments.

## Acceptance Criteria

### AC-1
**Given** tecnico id=7 has 6 riparazioni with stato IN_DIAGNOSI or IN_LAVORAZIONE and tecnico id=8 has 3 riparazioni with stato IN_DIAGNOSI or IN_LAVORAZIONE  
**When** I GET `/api/dashboard/carico-tecnici` with a valid Admin token  
**Then** I receive `200` with JSON array containing entries `{ tecnicoId: 7, username: "mario.rossi", nome: "Mario Rossi", riparazioniAttive: 6 }` and `{ tecnicoId: 8, username: "anna.verdi", nome: "Anna Verdi", riparazioniAttive: 3 }`, with `riparazioniAttive` integer >= 0 for each returned row

### AC-2
**Given** seeded users include `{ id: 7, role: TECNICO }`, `{ id: 8, role: TECNICO }`, `{ id: 1, role: ADMIN }`, `{ id: 9, role: COMMERCIALE }` and all have at least one repair linked in test dataset  
**When** I GET `/api/dashboard/carico-tecnici` with a valid Admin token  
**Then** I receive `200`, every returned item has `tecnicoId` in `[7, 8]`, and no item is returned for user id `1` or `9`

### AC-3
**Given** an authenticated user with role `TECNICO` and valid access token  
**When** the user GETs `/api/dashboard/carico-tecnici`  
**Then** the API returns `403` with body `{ error: { code: "FORBIDDEN", message: "Admin only" } }`

## Target Modules

- packages/backend/src/routes/dashboard.ts
- packages/backend/src/services/dashboard-service.ts
- packages/backend/src/services/users-service.ts
- packages/backend/src/__tests__/dashboard-carico-tecnici-atdd.spec.ts

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3): add authenticated `GET /carico-tecnici` route in `packages/backend/src/routes/dashboard.ts` with service call and explicit error mapping for `VALIDATION_ERROR` and `FORBIDDEN` via `buildErrorResponse`.
- [x] Task 2 (AC-1, AC-2, AC-3): implement `getDashboardCaricoTecnici` in `packages/backend/src/services/dashboard-service.ts` with validation of `actorUserId`/`actorRole`, Admin-only guard, and deterministic response ordering.
- [x] Task 3 (AC-1, AC-2): aggregate active repairs (`IN_DIAGNOSI`, `IN_LAVORAZIONE`) by technician and return `tecnicoId`, `username`, `nome`, `riparazioniAttive` using `packages/backend/src/services/riparazioni-service.ts` or dedicated helper query with user-role filtering.
- [x] Task 4 (AC-2): ensure service-level exclusion of non-`TECNICO` users (ADMIN, COMMERCIALE, inactive users) and cover exclusion with assertions in tests.
- [x] Task 5 (AC-1): add ATDD assertions for exact sample entries and integer `riparazioniAttive` shape in `packages/backend/src/__tests__/dashboard-carico-tecnici-atdd.spec.ts`.
- [x] Task 6 (AC-2, AC-3): add dedicated endpoint ATDD suite in `packages/backend/src/__tests__/dashboard-carico-tecnici-atdd.spec.ts` for TECNICO-only filtering and `403` `FORBIDDEN` body.

## Validation Notes (Step 4)

- Issue 1 fixed: AC-2 had vague dataset and non-deterministic role check; replaced with concrete user ids/roles and explicit inclusion/exclusion assertions.
- Issue 2 fixed: AC-3 lacked exact error body contract; added precise JSON structure matching `buildErrorResponse`.
- Issue 3 fixed: task breakdown had corrupted control characters and ambiguous `and/or`; rewritten with explicit file references and unambiguous deliverables.

## Implementation Deviation

- Test fixture detail: to keep tests deterministic in the current in-memory test stores, ATDD scenarios seed dedicated TECNICO users and repairs at runtime; assertions validate the same behavioral contract (admin-only access, active-workload aggregation, TECNICO-only output) with fixture-generated IDs.
