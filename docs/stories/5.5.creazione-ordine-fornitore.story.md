---
story_id: "5.5"
title: "Creazione Ordine Fornitore"
status: "draft"
priority: "high"
estimate: "M"
---

# Story 5.5: Creazione Ordine Fornitore

## Story

As an Admin, I want to create supplier orders, so that I can replenish inventory.

## Acceptance Criteria

### AC-1 - Creazione ordine in BOZZA con totale calcolato e numero auto-generato
**Given** utente autenticato con ruolo `ADMIN`, fornitore `id=3` esistente, articoli `id=5` e `id=7` esistenti.
**When** invoco `POST /api/ordini` con payload `{ fornitoreId: 3, voci: [{ articoloId: 5, quantitaOrdinata: 10, prezzoUnitario: 100.00 }, { articoloId: 7, quantitaOrdinata: 5, prezzoUnitario: 80.00 }] }`.
**Then** ricevo `201` e `response.body` contiene almeno `{ id, numeroOrdine, fornitoreId, stato, totale }` con `stato = "BOZZA"`, `totale = 1400.00`, e `numeroOrdine` valorizzato e conforme al pattern `^ORD-[0-9]{6}$`.

### AC-2 - Fornitore non trovato
**Given** utente autenticato con ruolo `ADMIN` e fornitore `id=999` inesistente.
**When** invoco `POST /api/ordini` con payload `{ fornitoreId: 999, voci: [{ articoloId: 5, quantitaOrdinata: 1, prezzoUnitario: 100.00 }] }`.
**Then** ricevo `404` con `response.body.error.code = "FORNITORE_NOT_FOUND"`.

### AC-3 - Articolo non trovato in una voce ordine
**Given** utente autenticato con ruolo `ADMIN`, fornitore `id=3` esistente, e voce con `articoloId=999` inesistente.
**When** invoco `POST /api/ordini` con payload `{ fornitoreId: 3, voci: [{ articoloId: 999, quantitaOrdinata: 2, prezzoUnitario: 50.00 }] }`.
**Then** ricevo `404` con `response.body.error.code = "ARTICOLO_NOT_FOUND"` e `response.body.error.message = "ARTICOLO_NOT_FOUND in voce"`.

### AC-4 - Accesso negato a utente non Admin
**Given** utente autenticato con ruolo `TECNICO`.
**When** invoco `POST /api/ordini` con payload `{ fornitoreId: 3, voci: [{ articoloId: 5, quantitaOrdinata: 1, prezzoUnitario: 100.00 }] }`.
**Then** ricevo `403` con `response.body.error.code = "FORBIDDEN"`.

## AC Source Mapping

- AC-1: Derived from epic-details AC-1.
- AC-2: Derived from epic-details AC-2.
- AC-3: Derived from epic-details AC-3.
- AC-4: Derived from epic-details AC-4.

## Task Breakdown

- [x] API routing: creare `packages/backend/src/routes/ordini.ts` seguendo il pattern route+failure responder, con endpoint `POST /` protetto da `authenticate` + `authorize("ADMIN")`.
- [x] Router wiring: aggiornare `packages/backend/src/index.ts` per montare `ordiniRouter` su `/api/ordini`.
- [x] Service contract: estendere `packages/backend/src/services/anagrafiche-service.ts` con input/result type per creazione ordine fornitore e validazioni su `fornitoreId`, `voci[].articoloId`, `voci[].quantitaOrdinata`, `voci[].prezzoUnitario`.
- [x] Service implementation: implementare creazione ordine in `packages/backend/src/services/anagrafiche-service.ts` (branch test store + database) con stato iniziale `BOZZA`, totale calcolato e `numeroOrdine` univoco.
- [x] Data model: estendere `packages/backend/prisma/schema.prisma` per persistere le voci ordine collegate a `OrdineFornitore` mantenendo i campi necessari agli AC.
- [x] ATDD: creare `packages/backend/src/__tests__/ordini-create-atdd.spec.ts` con scenari AC-1..AC-4 e assert puntuali su status/error code/error message/totale/numeroOrdine (incluso regex `^ORD-[0-9]{6}$`).
- [x] Regression: rieseguire test coinvolti da anagrafiche/articoli/fornitori (`fornitori-detail-update-atdd`, `articoli-create-atdd`) per verificare assenza regressioni.

## Task-to-AC Coverage

- AC-1 coperta da task: API routing, Router wiring, Service contract, Service implementation, Data model, ATDD.
- AC-2 coperta da task: Service contract, Service implementation, API routing, ATDD.
- AC-3 coperta da task: Service contract, Service implementation, API routing, Data model, ATDD.
- AC-4 coperta da task: API routing, Router wiring, ATDD.

## Dependencies

- Story 5.2 completata (articoli e lookup magazzino disponibili).
- Story 5.4 completata (pattern ATDD recente per dominio magazzino/riparazioni e mapping errori consolidato).

## Notes for Implementation

- Preservare il contratto errore standard con `buildErrorResponse` per 404/403.
- Calcolare `totale` come somma deterministica di `quantitaOrdinata * prezzoUnitario` su tutte le voci, con arrotondamento coerente a 2 decimali.
- Garantire unicita di `numeroOrdine` anche con richieste concorrenti.
