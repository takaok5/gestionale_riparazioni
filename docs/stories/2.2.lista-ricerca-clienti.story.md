---
status: ready-for-dev
priority: medium
estimate: S
story_id: "2.2"
epic: "Epic 2 - Gestione Anagrafiche"
---

# Story 2.2: Lista e Ricerca Clienti

**As a** Commerciale, **I want** to search and filter customers, **so that** I can quickly find customer information.

## Acceptance Criteria

### AC-1
**Given** esistono 25 clienti nel sistema, ciascuno con `id`, `nome`, `codiceCliente` e `tipologia`, ordinati per `id` crescente
**When** invio `GET /api/clienti?page=1&limit=10`
**Then** ricevo `200` con body `{ data: [...], meta: { page: 1, limit: 10, total: 25, totalPages: 3 } }` e `data.length = 10`
Source: Derived from epic-details AC-1

### AC-2
**Given** esistono clienti con `nome` uguale a `Mario Rossi`, `nome` uguale a `ROSSI SRL` e `codiceCliente` uguale a `CLI-ROSSI-001`
**When** invio `GET /api/clienti?search=Rossi`
**Then** ricevo solo clienti per cui `nome` o `codiceCliente` contiene `rossi` in modo case-insensitive
Source: Derived from epic-details AC-2

### AC-3
**Given** esistono clienti con `tipologia=PRIVATO` e clienti con `tipologia=AZIENDA`
**When** invio `GET /api/clienti?tipologia=AZIENDA`
**Then** ricevo solo clienti con `tipologia` uguale a `AZIENDA` e nessun cliente con `tipologia=PRIVATO`
Source: Derived from epic-details AC-3

### AC-4
**Given** viene richiesto un filtro `tipologia` con valore non ammesso (`INVALID`)
**When** invio `GET /api/clienti?tipologia=INVALID`
**Then** ricevo `400` con errore `{ code: "VALIDATION_ERROR" }` e `details` contenente almeno `field: "tipologia"`
Source: Validation extension for sad path based on service validation pattern

## Target Modules

- `packages/backend/src/routes/clienti.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/__tests__/clienti-create-atdd.spec.ts`
- `packages/backend/src/__tests__/audit-trail.spec.ts`
- `packages/backend/src/index.ts`

## Task Breakdown

- [x] Task 1 (AC-1, AC-2, AC-3, AC-4): aggiornare `packages/backend/src/routes/clienti.ts` per supportare `GET /api/clienti`, con parsing query (`page`, `limit`, `search`, `tipologia`) e mapping errori di validazione.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): introdurre in `packages/backend/src/services/anagrafiche-service.ts` il parser input lista clienti con default, validazioni e normalizzazione filtri.
- [x] Task 3 (AC-1, AC-2, AC-3): implementare in `packages/backend/src/services/anagrafiche-service.ts` la lista clienti su test store e database con ordinamento deterministico e risposta `{ data, meta }`.
- [x] Task 4 (AC-1, AC-2, AC-3, AC-4): verificare la route clienti in `packages/backend/src/index.ts` mantenendo il prefix `/api/clienti` (gia presente, nessuna modifica necessaria).
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): implementare scenari ATDD in `packages/backend/src/__tests__/clienti-list-search-atdd.spec.ts` per paginazione, ricerca, filtro tipologia e sad path `tipologia=INVALID`.
- [x] Task 6 (AC-1): riusare pattern di assert paginazione da `packages/backend/src/__tests__/audit-trail.spec.ts` per verificare `meta.page`, `meta.limit`, `meta.total`, `meta.totalPages` e `data.length`.

## Implementation Notes

- AC funzionali derivano da `docs/epics/epic-2-anagrafiche.md` (Story 2.2), con estensione sad path per coprire criteri di testabilita.
- Pattern da seguire: parsing query in route (`packages/backend/src/routes/audit-log.ts:37`) e paginazione service (`packages/backend/src/services/anagrafiche-service.ts:632`, `packages/backend/src/services/anagrafiche-service.ts:1012`).
- Deviazione dal task originale dei test: invece di estendere `clienti-create-atdd.spec.ts` e stato creato `clienti-list-search-atdd.spec.ts` per isolamento degli scenari GET e tracciamento RED->GREEN.

## Validation Fixes Applied

1. Testo AC corrotto (`nome`, `tipologia`, `totalPages`) che rendeva i requisiti non verificabili: corretto con campi e valori espliciti.
2. Nessun sad path esplicito: aggiunto `AC-4` con aspettativa `400 VALIDATION_ERROR` su `tipologia` non valida.
3. Copertura task incompleta (mancava registrazione route e regola di ordinamento): aggiunti task specifici su `index.ts` e ordinamento deterministico.
