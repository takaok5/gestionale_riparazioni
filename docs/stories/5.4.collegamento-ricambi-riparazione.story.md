---
story_id: "5.4"
title: "Collegamento Ricambi a Riparazione"
status: "draft"
priority: "high"
estimate: "M"
---

# Story 5.4: Collegamento Ricambi a Riparazione

## Story

As a Tecnico, I want to assign parts to a repair, so that parts used are tracked and inventory is updated.

## Acceptance Criteria

### AC-1 - Collegamento ricambio con scarico automatico
**Given** articolo `id=5` ha `giacenza=15` e `prezzoVendita=150.00`, e la riparazione `id=10` esiste.
**When** un utente autenticato con ruolo `TECNICO` invoca `POST /api/riparazioni/10/ricambi` con payload `{ articoloId: 5, quantita: 2 }`.
**Then** la risposta e `201` con body `data` che include almeno `{ articoloId: 5, quantita: 2, prezzoUnitario: 150.00 }`, la giacenza dell'articolo `id=5` diventa `13`, e viene registrato un movimento `SCARICO` con riferimento alla riparazione `id=10`.

### AC-2 - Blocco su stock insufficiente
**Given** articolo `id=5` ha `giacenza=1` e la riparazione `id=10` esiste.
**When** un utente autenticato con ruolo `TECNICO` invoca `POST /api/riparazioni/10/ricambi` con payload `{ articoloId: 5, quantita: 3 }`.
**Then** la risposta e `400` con errore `"Insufficient stock for articolo: available 1, requested 3"`, senza creare collegamento ricambio ne movimento di magazzino.

### AC-3 - Dettaglio riparazione con ricambi arricchiti
**Given** la riparazione `id=10` ha ricambi collegati.
**When** un utente autenticato con ruolo `TECNICO` o `ADMIN` invoca `GET /api/riparazioni/10`.
**Then** la risposta e `200` e `response.body.data.ricambi` include elementi nel formato `{ articolo: { id, nome, codiceArticolo }, quantita, prezzoUnitario }` con `quantita` numerico intero e `prezzoUnitario` numerico.

### AC-4 - Articolo non esistente
**Given** l'articolo `id=999` non esiste e la riparazione `id=10` esiste.
**When** un utente autenticato con ruolo `TECNICO` invoca `POST /api/riparazioni/10/ricambi` con payload `{ articoloId: 999, quantita: 1 }`.
**Then** la risposta e `404` con `response.body.error.code = "ARTICOLO_NOT_FOUND"` e nessuna modifica viene applicata su ricambi della riparazione o giacenza inventario.

## AC Source Mapping

- AC-1: Derived from epic-details AC-1.
- AC-2: Derived from epic-details AC-2.
- AC-3: Derived from epic-details AC-3.
- AC-4: Derived from epic-details AC-4.

## Task Breakdown

- [x] Backend route: estendere `packages/backend/src/routes/riparazioni.ts` con endpoint `POST /:id/ricambi`, middleware `authenticate` + `authorize("TECNICO", "ADMIN")`, parsing payload e mapping errori `400/404` coerente con contratto API.
- [x] Service riparazioni: implementare in `packages/backend/src/services/riparazioni-service.ts` parser input per `riparazioneId`, `articoloId`, `quantita` e funzione applicativa per collegare il ricambio alla riparazione con `prezzoUnitario` snapshot.
- [x] Integrazione magazzino: riusare logica in `packages/backend/src/services/anagrafiche-service.ts` per creare movimento `SCARICO` e garantire decremento stock atomico nella stessa operazione di collegamento.
- [x] Proiezione dettaglio: aggiornare in `packages/backend/src/services/riparazioni-service.ts` la mappatura `GET /api/riparazioni/:id` per restituire `ricambi[].articolo.{id,nome,codiceArticolo}` con `quantita` e `prezzoUnitario`.
- [x] Persistenza dati: aggiornare `packages/backend/prisma/schema.prisma` e le query in `packages/backend/src/services/riparazioni-service.ts` per aggiungere collegamento esplicito `articoloId` in `RiparazioneRicambio` mantenendo anche snapshot `codiceArticolo`, `descrizione` e `prezzoUnitario`.
- [x] ATDD API: creare/estendere `packages/backend/src/__tests__/riparazioni-ricambi-atdd.spec.ts` con scenari AC-1..AC-4 verificando status code, messaggi errore, side effects su giacenza e shape risposta dettaglio.
- [x] Regression tests: verificare che `packages/backend/src/__tests__/articoli-movimenti-atdd.spec.ts` e `packages/backend/src/__tests__/riparazioni-detail-atdd.spec.ts` restino verdi dopo le modifiche.

## Task-to-AC Coverage

- AC-1 coperta da task: Backend route, Service riparazioni, Integrazione magazzino, ATDD API.
- AC-2 coperta da task: Service riparazioni, Integrazione magazzino, Backend route, ATDD API.
- AC-3 coperta da task: Persistenza dati, Proiezione dettaglio, ATDD API, Regression tests.
- AC-4 coperta da task: Service riparazioni, Backend route, ATDD API.

## Dependencies

- Story 5.3 completata (movimenti magazzino e vincoli stock atomici disponibili).

## Notes for Implementation

- Mantenere la semantica errori coerente con `buildErrorResponse` usata nelle route backend.
- Evitare mutazioni dirette di `giacenza` fuori dalle logiche centralizzate di movimento magazzino.
- Salvare `prezzoUnitario` come snapshot per evitare drift storico in caso di variazioni future del prezzo articolo.
