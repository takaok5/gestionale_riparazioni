---
story: '3.5'
title: 'Cambio Stato Riparazione (Transizioni Base)'
status: ready-for-dev
priority: high
estimate: 6h
epic: 3
dependencies: ['3.1', '3.4']
---

# Story 3.5: Cambio Stato Riparazione (Transizioni Base)

## User Story
**As a** Tecnico, **I want** to update repair status following allowed transitions, **so that** repair progress is tracked correctly.

## Acceptance Criteria

### AC 1 - RICEVUTA -> IN_DIAGNOSI con storico
Source: Derived from epic-details AC-1.

**Given** sono autenticato come `TECNICO` con `userId=7`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, la riparazione e' in stato `RICEVUTA`, e la storia iniziale contiene `statiHistory` con lunghezza `0`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_DIAGNOSI", "note": "Iniziata diagnosi" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_DIAGNOSI" } }`, la riparazione passa a `IN_DIAGNOSI`, e viene aggiunta una entry in `statiHistory` con `stato="IN_DIAGNOSI"`, timestamp ISO valorizzato, `userId=7` e `note="Iniziata diagnosi"`.

### AC 2 - IN_DIAGNOSI -> IN_LAVORAZIONE
Source: Derived from epic-details AC-2.

**Given** sono autenticato come `TECNICO` assegnato alla riparazione `id=10`, e la riparazione e' in stato `IN_DIAGNOSI`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_LAVORAZIONE" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "IN_LAVORAZIONE" } }` e la riparazione passa a `IN_LAVORAZIONE`.

### AC 3 - IN_LAVORAZIONE -> COMPLETATA
Source: Derived from epic-details AC-3.

**Given** sono autenticato come `TECNICO` assegnato alla riparazione `id=10`, e la riparazione e' in stato `IN_LAVORAZIONE`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "COMPLETATA" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "COMPLETATA" } }` e la riparazione passa a `COMPLETATA`.

### AC 4 - COMPLETATA -> CONSEGNATA
Source: Derived from epic-details AC-4.

**Given** sono autenticato come `TECNICO` assegnato alla riparazione `id=10`, e la riparazione e' in stato `COMPLETATA`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "CONSEGNATA" }`.

**Then** ricevo `200` con payload `{ data: { id: 10, stato: "CONSEGNATA" } }` e la riparazione passa a `CONSEGNATA`.

### AC 5 - Transizione non valida da RICEVUTA
Source: Derived from epic-details AC-5.

**Given** sono autenticato come `TECNICO` assegnato alla riparazione `id=10`, e la riparazione e' in stato `RICEVUTA`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "COMPLETATA" }`.

**Then** ricevo `400` con `error.code = "VALIDATION_ERROR"` e `error.message = "Invalid state transition from RICEVUTA to COMPLETATA"`, lo stato della riparazione resta `RICEVUTA`, e `statiHistory` non aggiunge nuove entry.

### AC 6 - Divieto per tecnico non assegnato
Source: Derived from epic-details AC-6.

**Given** sono autenticato come `TECNICO` con `userId=8`, la riparazione `id=10` e' assegnata a `tecnicoId=7`, e non ho ruolo `ADMIN`.

**When** invio `PATCH /api/riparazioni/10/stato` con body JSON `{ "stato": "IN_DIAGNOSI" }`.

**Then** ricevo `403` con `error.code = "FORBIDDEN"` e `error.message = "Accesso negato"`, lo stato della riparazione resta invariato rispetto al valore iniziale, e `statiHistory` non viene modificata.

## Task Breakdown

- [x] Aggiungere endpoint `PATCH /api/riparazioni/:id/stato` in `packages/backend/src/routes/riparazioni.ts` con `authenticate` e payload `{ riparazioneId, stato, note }` inoltrato al service (copre AC-1..AC-6).
- [x] Implementare nel service il controllo autorizzativo su attore (`ADMIN` oppure tecnico assegnato) con risultato `FORBIDDEN` quando `userId` non e' autorizzato (copre AC-6).
- [x] Estendere il mapper errori route in `packages/backend/src/routes/riparazioni.ts` per gli errori del cambio stato (`VALIDATION_ERROR`, `NOT_FOUND`, `FORBIDDEN`, `SERVICE_UNAVAILABLE`) (copre AC-5, AC-6).
- [x] Introdurre input type/parser `CambiaStatoRiparazioneInput` in `packages/backend/src/services/riparazioni-service.ts` con validazione di `riparazioneId`, `stato` e `note` (copre AC-1, AC-2, AC-3, AC-4, AC-5).
- [x] Implementare matrice transizioni base consentite in `packages/backend/src/services/riparazioni-service.ts` (`RICEVUTA -> IN_DIAGNOSI`, `IN_DIAGNOSI -> IN_LAVORAZIONE`, `IN_LAVORAZIONE -> COMPLETATA`, `COMPLETATA -> CONSEGNATA`) con errore esplicito sulle transizioni non valide (copre AC-2, AC-3, AC-4, AC-5).
- [x] Implementare persistenza stato + inserimento `RiparazioneStatoHistory` in entrambi i percorsi (`NODE_ENV=test` in-memory store e Prisma transaction) includendo `userId`, timestamp ISO e `note`, e garantendo nessuna entry su transizione non valida/non autorizzata (copre AC-1, AC-5, AC-6).
- [x] Aggiungere test ATDD RED in `packages/backend/src/__tests__/riparazioni-stato-base-atdd.spec.ts` con casi separati per AC-1..AC-6 e assert su codice HTTP, payload errore e storico stato (copre AC-1..AC-6).
- [x] Eseguire regression mirata su `packages/backend/src/__tests__/riparazioni-assegnazione-atdd.spec.ts`, `packages/backend/src/__tests__/riparazioni-detail-atdd.spec.ts` e `packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts` per verificare assenza di regressioni sulle funzionalita' correlate.

## Notes
- Le risposte errore devono mantenere il formato `{ error: { code, message, details } }`.
- La business logic deve restare simmetrica tra test-store e percorso Prisma.
