---
status: ready
priority: high
estimate: M
story_id: "4.1"
title: "Creazione Preventivo"
---

# Story 4.1: Creazione Preventivo

## User Story
Come Tecnico voglio creare un preventivo con voci di dettaglio per proporre al cliente i costi della riparazione.

## Acceptance Criteria (Expanded)

### AC-1
**Given** esiste una riparazione con `id=10`  
**When** invio `POST /api/preventivi` con payload:
```json
{
  "riparazioneId": 10,
  "voci": [
    {
      "tipo": "MANODOPERA",
      "descrizione": "Sostituzione schermo",
      "quantita": 1,
      "prezzoUnitario": 80.00
    },
    {
      "tipo": "RICAMBIO",
      "descrizione": "Display LCD",
      "articoloId": 5,
      "quantita": 1,
      "prezzoUnitario": 120.00
    }
  ]
}
```
**Then** viene creato un preventivo in stato `"BOZZA"` con `subtotale=200.00`, `iva=44.00` (22%), `totale=244.00` e risposta HTTP `201`.

### AC-2
**Given** esiste il preventivo `id=21` creato per `riparazioneId=10` con `3 voci`:
1) `MANODOPERA` "Diagnosi avanzata" `quantita=1` `prezzoUnitario=50.00`
2) `RICAMBIO` "Display LCD" `articoloId=5` `quantita=1` `prezzoUnitario=120.00`
3) `RICAMBIO` "Batteria" `articoloId=8` `quantita=1` `prezzoUnitario=90.00`  
**When** invio `GET /api/preventivi/21`  
**Then** la risposta include `data.voci` con esattamente `3` elementi e i totali `subtotale=260.00`, `iva=57.20`, `totale=317.20`.

### AC-3
**Given** invio `POST /api/preventivi` con `riparazioneId=999` (riparazione inesistente)  
**When** la richiesta viene processata  
**Then** ricevo HTTP `404` con errore `"RIPARAZIONE_NOT_FOUND"`.

### AC-4
**Given** invio `POST /api/preventivi` con una `voce` senza campo `descrizione`  
**When** la richiesta viene validata  
**Then** ricevo HTTP `400` con `error.code = "VALIDATION_ERROR"` e messaggio esatto `"descrizione is required for each voce"`.

## Task Breakdown

- [x] Registrare il nuovo router preventivi in `packages/backend/src/index.ts` con mount centrale su `/api/preventivi` (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Creare `packages/backend/src/routes/preventivi.ts` con endpoint `POST /` e `GET /:id`, mapping errori via `buildErrorResponse` (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Estendere il modello dati in `packages/backend/prisma/schema.prisma` per supportare voci preventivo e campi di totale (`subtotale`, `iva`, `totale`) necessari a creazione e dettaglio (copertura AC-1, AC-2).
- [x] Implementare nel service dedicato `packages/backend/src/services/preventivi-service.ts`:
  - create preventivo con calcolo `subtotale/iva/totale` e stato iniziale `BOZZA`;
  - recupero dettaglio preventivo con array `voci` completo;
  - gestione not found su riparazione con codice `RIPARAZIONE_NOT_FOUND`;
  - validazione campo obbligatorio `descrizione` per ogni voce con `error.code = VALIDATION_ERROR`.
- [x] Implementare in `packages/backend/src/routes/preventivi.ts` i mapping HTTP:
  - successo creazione con `201`;
  - dettaglio con `200`;
  - errore `RIPARAZIONE_NOT_FOUND` con `404`;
  - errore validazione con `400` e messaggio esatto richiesto.
- [x] Aggiungere/estendere test ATDD:
  - creare `packages/backend/src/__tests__/preventivi-create-atdd.spec.ts` per i casi POST (happy path + validation error + 404 riparazione inesistente);
  - creare `packages/backend/src/__tests__/preventivi-detail-atdd.spec.ts` per GET dettaglio preventivo `id=21` e payload con 3 voci;
  - verificare status code, `error.code` e messaggi esatti (`RIPARAZIONE_NOT_FOUND`, `descrizione is required for each voce`).

## Note Tecniche
- Pattern da seguire: registrazione router centralizzata, mapping esplicito failure->HTTP, validazioni deterministiche con messaggi stabili, test sad-path con assert su codice e messaggio esatto.
- Rischi principali: endpoint non registrati in bootstrap, disallineamento schema dati per `voci/totali`, divergenza tra path test-store e path Prisma.

## Validazione Step 4 - Issue e Fix Applicati

1. Problema: AC-2 era poco deterministica ("preventivo creato con 3 voci") e non consentiva assert numerici univoci.
   Fix: AC-2 ora specifica `preventivo id=21`, dettaglio completo delle 3 voci e totali attesi (`260.00`, `57.20`, `317.20`).
2. Problema: AC-4 non imponeva il contratto errore standard (`error.code`) usato negli ATDD backend.
   Fix: AC-4 ora richiede esplicitamente `error.code = "VALIDATION_ERROR"` oltre al messaggio esatto.
3. Problema: task breakdown ambiguo su dove implementare (route/service riparazioni o modulo dedicato), con rischio di scope creep.
   Fix: task breakdown reso esplicito su moduli dedicati `routes/preventivi.ts` e `services/preventivi-service.ts`, con file test ATDD dedicati.
