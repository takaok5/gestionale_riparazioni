---
status: drafted
priority: high
estimate: M
story_id: "4.3"
title: "Invio Preventivo al Cliente"
---

# Story 4.3: Invio Preventivo al Cliente

## User Story
Come Commerciale voglio inviare il preventivo al cliente cosi' che possa leggerlo e approvarlo.

## Acceptance Criteria (Expanded)

### AC-1
**Given** esiste il preventivo `id=5` con `stato="BOZZA"`, la riparazione collegata ha `id=10`, `stato="PREVENTIVO_EMESSO"` e il cliente associato ha `email="cliente@test.it"`.
**When** invio `POST /api/preventivi/5/invia` autenticato come Commerciale.
**Then** ricevo HTTP `200` con body che include `id=5`, `stato="INVIATO"` e `dataInvio` valorizzato (ISO timestamp non nullo), il servizio PDF viene invocato una volta per `preventivoId=5`, il servizio email viene invocato una volta verso `cliente@test.it`, e la riparazione `id=10` viene aggiornata a `stato="IN_ATTESA_APPROVAZIONE"`.

### AC-2
**Given** esiste il preventivo `id=5` con `stato="INVIATO"`.
**When** invio `POST /api/preventivi/5/invia`.
**Then** ricevo HTTP `400` con errore esatto `"Preventivo already sent"`.

### AC-3
**Given** esiste il preventivo `id=5` con `stato="BOZZA"` collegato a una riparazione il cui cliente ha `email=null`.
**When** invio `POST /api/preventivi/5/invia`.
**Then** ricevo HTTP `400` con errore esatto `"Customer email is required to send quotation"`.

### AC-4
**Given** esiste il preventivo `id=5` in `stato="BOZZA"`, con cliente `email="cliente@test.it"`, e il servizio email fallisce durante l'invio.
**When** invio `POST /api/preventivi/5/invia`.
**Then** ricevo HTTP `500` con errore esatto `"Failed to send email"`, il preventivo resta `stato="BOZZA"`, `dataInvio` resta `null`, e la riparazione collegata non cambia stato.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (docs/epics/epic-4-preventivi-fatturazione.md:42)
- AC-2: Derived from epic-details AC-2 (docs/epics/epic-4-preventivi-fatturazione.md:43)
- AC-3: Derived from epic-details AC-3 (docs/epics/epic-4-preventivi-fatturazione.md:44)
- AC-4: Derived from epic-details AC-4 (docs/epics/epic-4-preventivi-fatturazione.md:45)

## Task Breakdown

- [x] Estendere packages/backend/src/routes/preventivi.ts con endpoint POST /:id/invia, payload/context auth coerenti, e mapping errori HTTP per i codici/messaggi attesi (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Estendere packages/backend/src/services/preventivi-service.ts con use case inviaPreventivo su path test-store + Prisma: verifica stato iniziale, validazione email cliente, aggiornamento stato/dataInvio e ritorno risposta API (copertura AC-1, AC-2, AC-3).
- [x] Integrare la transizione riparazione a IN_ATTESA_APPROVAZIONE in transazione applicativa sul flusso di invio, mantenendo coerenza stato preventivo/riparazione (copertura AC-1).
- [x] Introdurre hook testabili per simulare email mancante/fallimento invio nel test-store con rollback dello stato preventivo in caso di errore (copertura AC-1, AC-4).
- [x] Aggiornare packages/backend/prisma/schema.prisma (campo dataInvio) e allineare persistenza + fixture seed/reset test in packages/backend/src/services/preventivi-service.ts per casi BOZZA, INVIATO, email-null, email-failure (copertura AC-1, AC-2, AC-3, AC-4).
- [x] Aggiungere test ATDD dedicati in packages/backend/src/__tests__/preventivi-send-atdd.spec.ts per i quattro scenari AC, includendo assert su stato preventivo, dataInvio, stato riparazione, messaggi di errore e comportamento su failure email (copertura AC-1, AC-2, AC-3, AC-4).

## Note Tecniche
- Riutilizzare pattern route gia' presenti in packages/backend/src/routes/preventivi.ts (payload tipizzato + respond*Failure).
- Mantenere simmetria tra runtime Prisma e test-store in-memory.
- Rendere i side-effect esterni (PDF/email) iniettabili per test deterministici.

## Validazione Step 4 - Issue e Fix Applicati

1. Problema: AC-1 era troppo ampia nel Then ("genera PDF" e "invia email") senza criterio verificabile lato test.
   Fix: AC-1 ora esplicita assert testabili: campi body (`id`, `stato`, `dataInvio`) e invocazioni singole dei servizi PDF/email con dati specifici.
2. Problema: AC-3 non bloccava l'ambiguita' con AC-2, perche' mancava il prerequisito `stato="BOZZA"`.
   Fix: AC-3 ora dichiara esplicitamente `stato="BOZZA"` + `email=null`, rendendo deterministico l'errore atteso.
3. Problema: AC-4 non definiva completamente il rollback, lasciando indefinito cosa accade a `dataInvio` e allo stato riparazione.
   Fix: AC-4 ora richiede esplicitamente `dataInvio=null` e nessuna transizione stato riparazione in caso di fallimento email.
