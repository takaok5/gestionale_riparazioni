---
status: in progress
priority: high
estimate: 3d
---

Riparazione status transitions must drive email notifications so customers with codiceRiparazione `RIP-20260209-0001` always know when their device moves through the workshop. Every AC below uses the specific riparazione, cliente, and subject lines coming from `docs/epics/epic-7-notifiche-integrazioni.md` and follows the Notifica blueprint (tipo, stato, riferimento) defined in `docs/architecture.md`.

### AC-1: Riparazione RICEVUTA genera email e Notifica INVIATA (Derived from epic-details AC-1)
**Given** riparazione `id=10`, cliente email `cliente@test.it`, codiceRiparazione `RIP-20260209-0001`, and dispositivo metadata (marca Samsung, modello Galaxy S21) is available inside `cambiaStatoRiparazione`
**When** the PATCH `/api/riparazioni/10/stato` payload sets `stato` to `RICEVUTA` and the service persists the transition
**Then** the backend sends an email to `cliente@test.it` with subject `Riparazione Ricevuta - RIP-20260209-0001`, the template body includes `codiceRiparazione` plus marca/modello, and a `Notifica` row is inserted with `tipo: "STATO_RIPARAZIONE"`, `stato: "INVIATA"`, `riferimentoTipo: "RIPARAZIONE"`, `riferimentoId: 10`, and the current timestamp so the append-only log records the `RICEVUTA` update

### AC-2: Riparazione COMPLETATA informa il cliente (Derived from epic-details AC-2)
**Given** riparazione `id=10` currently in `IN_LAVORAZIONE`, cliente email `cliente@test.it`, and codiceRiparazione `RIP-20260209-0001`
**When** the PATCH `/api/riparazioni/10/stato` payload sets `stato` to `COMPLETATA`
**Then** the API returns `200` with `data.id=10` and `data.stato="COMPLETATA"`, an email is sent to `cliente@test.it` with subject `Riparazione Completata` and body text `La sua riparazione e pronta per il ritiro`, and a `Notifica` row is stored with `tipo: "STATO_RIPARAZIONE"`, `stato: "INVIATA"`, `riferimentoTipo: "RIPARAZIONE"`, `riferimentoId: 10`

### AC-3: Riparazione CONSEGNATA conferma la consegna (Derived from epic-details AC-3)
**Given** riparazione `id=10` currently in `COMPLETATA` with cliente email `cliente@test.it`
**When** the PATCH `/api/riparazioni/10/stato` payload sets `stato` to `CONSEGNATA`
**Then** the API returns `200` with `data.id=10` and `data.stato="CONSEGNATA"`, an email with subject `Riparazione Consegnata` is sent to `cliente@test.it`, and a `Notifica` row is inserted with `tipo: "STATO_RIPARAZIONE"` and `stato: "INVIATA"` for `riferimentoId: 10`

### AC-4: Email failure still records Notifica FALLITA (Derived from epic-details AC-4)
**Given** the email helper throws a failure (matching `sendPreventivoEmail` toggles from `packages/backend/src/services/preventivi-service.ts:990-1055`) during a `stato` update for riparazione id=10
**When** the failure bubbles up inside `cambiaStatoRiparazione`
**Then** the riparazione stato change still commits and PATCH `/api/riparazioni/10/stato` returns `200` with the new stato, an error log entry is emitted, and a `Notifica` record is saved with `tipo: "STATO_RIPARAZIONE"`, `stato: "FALLITA"`, `riferimentoTipo: "RIPARAZIONE"`, `riferimentoId: 10`

### Tasks
- [x] Update `packages/backend/src/services/riparazioni-service.ts` so `cambiaStatoRiparazione` extracts the Notifica payload matching `docs/architecture.md:460-472` (tipo, destinatario, oggetto, contenuto, stato, riferimentoTipo/Id, timestamp), calls a new email helper, and always inserts the Notifica row whether the helper succeeds or fails
- [x] Implement/send logic (`packages/backend/src/services/notifiche-service.ts`) that composes the status-subject/body pairs for `RICEVUTA`, `COMPLETATA`, and `CONSEGNATA`, uses cliente email from the riparazione, and records `Notifica.stato` as `FALLITA` on email errors without rolling back the riparazione update
- [x] Adjust routing by adding `packages/backend/src/routes/notifiche.ts` and wiring it in `packages/backend/src/index.ts` while keeping PATCH `/api/riparazioni/:id/stato` success contract (`200` with updated stato)
- [x] Extend test coverage in `packages/backend/src/__tests__/riparazioni-stato-notifiche-atdd.spec.ts` and `packages/backend/src/__tests__/riparazioni-stato-base-atdd.spec.ts` to assert notification side effects and failure handling

AC count: 4
Task count: 4
