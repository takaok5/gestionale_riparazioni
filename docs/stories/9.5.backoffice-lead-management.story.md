---
status: drafted
priority: medium
estimate: M
story_id: "9.5"
epic: "Epic 9 - Vetrina Pubblica e Lead Capture"
---

# Story 9.5: Backoffice Lead Management

**As a** Commerciale, **I want** to manage incoming public requests, **so that** I can convert them into customers and repair jobs.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** there are `30` public requests persisted with fields `stato`, `tipo`, `contatto`, `createdAt`
**When** a Commerciale or Admin calls `GET /api/richieste?page=1&limit=20`
**Then** the API responds with HTTP `200`, `response.body.data` contains exactly `20` items with `stato`, `tipo`, `contatto`, `createdAt`, and `response.body.pagination` is `{ "page": 1, "pageSize": 20, "totalItems": 30, "totalPages": 2 }`

### AC-2
_Derived from epic-details AC-2._
**Given** richiesta `id=12` exists with `stato="NUOVA"` and actor user is authenticated with role `COMMERCIALE` or `ADMIN`
**When** the actor calls `PATCH /api/richieste/12/stato` with body `{ "stato": "IN_LAVORAZIONE" }`
**Then** the API responds with HTTP `200`, richiesta `id=12` becomes `IN_LAVORAZIONE`, and `GET /api/audit-log?modelName=RichiestaPubblica&page=1` returns at least one row with `objectId="12"`, `dettagli.old.stato="NUOVA"`, and `dettagli.new.stato="IN_LAVORAZIONE"`

### AC-3
_Derived from epic-details AC-3._
**Given** authenticated user has role `COMMERCIALE`, `userId=5001`, and richiesta `id=12` is currently unassigned
**When** the user calls `PATCH /api/richieste/12/assegna` with body `{ "commercialeId": 5001 }`
**Then** the API responds with HTTP `200`, `response.body.data.id=12`, and `response.body.data.assegnataAUserId="5001"`

### AC-4
_Derived from epic-details AC-4._
**Given** authenticated user role is `TECNICO`
**When** the user calls `GET /api/richieste`
**Then** the API responds with HTTP `403` and `error.code="FORBIDDEN"`

## Target Modules

- `packages/backend/src/routes/richieste.ts` (new)
- `packages/backend/src/index.ts`
- `packages/backend/src/services/anagrafiche-service.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/__tests__/richieste-backoffice-api.atdd.spec.ts` (new)

## Task Breakdown

- [x] Task 1 (AC-1, AC-4): create `packages/backend/src/routes/richieste.ts` with `GET /` handler, `authenticate` + `authorize("COMMERCIALE", "ADMIN")`, query parsing for `page`/`limit`, and `403 FORBIDDEN` mapping for unauthorized roles.
- [x] Task 2 (AC-2): add `PATCH /:id/stato` in `packages/backend/src/routes/richieste.ts`, map body `{ stato }`, enforce actor role `COMMERCIALE|ADMIN`, invoke service transition, and map `200/400/404` failures through `buildErrorResponse`.
- [x] Task 3 (AC-3): add `PATCH /:id/assegna` in `packages/backend/src/routes/richieste.ts`, accept body `{ commercialeId }`, enforce Commerciale self-assignment, and return payload with `id` + `assegnataAUserId`.
- [x] Task 4 (AC-1, AC-2, AC-3): extend `packages/backend/src/services/anagrafiche-service.ts` with lead list pagination (`page`, `pageSize`, `totalItems`, `totalPages`), stato transition `NUOVA -> IN_LAVORAZIONE`, assignment, and audit details `dettagli.old.stato`/`dettagli.new.stato`.
- [x] Task 5 (AC-1, AC-2, AC-3, AC-4): register router in `packages/backend/src/index.ts` as `app.use("/api/richieste", richiesteRouter)` and keep response envelope consistency with existing routes.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): create `packages/backend/src/__tests__/richieste-backoffice-api.atdd.spec.ts` covering paginated list, stato transition with audit assertion, assignment flow, and `403 FORBIDDEN` for Tecnico.
