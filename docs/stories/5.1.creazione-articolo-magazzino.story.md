---
status: drafted
priority: high
estimate: M
story_id: "5.1"
title: "Creazione Articolo Magazzino"
---

# Story 5.1: Creazione Articolo Magazzino

## User Story
Come Admin voglio creare articoli di magazzino cosi' da tracciare i ricambi e gestire la disponibilita'.

## Acceptance Criteria (Expanded)

### AC-1
**Given** sono autenticato come `ADMIN` e invio `POST /api/articoli` con `{ codiceArticolo: "LCD-SAMS21", nome: "Display Samsung S21", descrizione: "LCD originale", categoria: "DISPLAY", fornitoreId: 3, prezzoAcquisto: 100.00, prezzoVendita: 150.00, sogliaMinima: 5 }`.
**When** la richiesta raggiunge il backend.
**Then** ricevo HTTP `201` e il body contiene `id` numerico, `codiceArticolo="LCD-SAMS21"` e `giacenza=0`.

### AC-2
**Given** esiste gia' un articolo con `codiceArticolo="LCD-SAMS21"`.
**When** invio un nuovo `POST /api/articoli` con lo stesso `codiceArticolo`.
**Then** ricevo HTTP `409` con `error.code="CODICE_ARTICOLO_EXISTS"`, `error.message="Codice articolo gia esistente"` e nessun campo `id` nel body.

### AC-3
**Given** sono autenticato come `ADMIN`.
**When** invio `POST /api/articoli` con `prezzoAcquisto=100.00` e `prezzoVendita=80.00`.
**Then** ricevo HTTP `400` con `error.code="VALIDATION_ERROR"`, `error.details.field="prezzoVendita"` e messaggio `prezzoVendita must be greater than prezzoAcquisto`.

### AC-4
**Given** sono autenticato come `TECNICO`.
**When** invio `POST /api/articoli`.
**Then** ricevo HTTP `403` con `error.code="FORBIDDEN"` e `error.message="Accesso negato"`.

### AC-5
**Given** sono autenticato come `ADMIN` e `fornitoreId=99999` non esiste.
**When** invio `POST /api/articoli` con payload altrimenti valido.
**Then** ricevo HTTP `404` con `error.code="FORNITORE_NOT_FOUND"`.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (`docs/epics/epic-5-magazzino-ordini.md`)
- AC-2: Derived from epic-details AC-2 (`docs/epics/epic-5-magazzino-ordini.md`)
- AC-3: Derived from epic-details AC-3 (`docs/epics/epic-5-magazzino-ordini.md`)
- AC-4: Derived from epic-details AC-4 (`docs/epics/epic-5-magazzino-ordini.md`)
- AC-5: NO SOURCE in epic-details, added during Step 4 validation to cover mandatory sad path on FK dependency (`fornitoreId`).

## Task Breakdown
- [x] Estendere `packages/backend/prisma/schema.prisma` con il model `Articolo` (campi: codiceArticolo univoco, nome, descrizione, categoria, fornitoreId, prezzoAcquisto, prezzoVendita, sogliaMinima, giacenza, timestamp) e relazione con `Fornitore` (AC-1, AC-2, AC-5).
- [x] Implementare create articolo in `packages/backend/src/services/anagrafiche-service.ts` con validazioni dominio (univocita' codice, `prezzoVendita > prezzoAcquisto`, giacenza iniziale 0, `fornitoreId` esistente) mantenendo coerenza tra test-store e database path (AC-1, AC-2, AC-3, AC-5).
- [x] Creare `packages/backend/src/routes/articoli.ts` con endpoint `POST /api/articoli`, `authenticate`, `authorize("ADMIN")` e mapping errori (`CODICE_ARTICOLO_EXISTS`, `VALIDATION_ERROR`, `FORNITORE_NOT_FOUND`) verso HTTP 409/400/404 (AC-1, AC-2, AC-3, AC-5).
- [x] Registrare il router articoli in `packages/backend/src/index.ts` su `/api/articoli` (AC-1..AC-5).
- [x] Aggiungere test ATDD in `packages/backend/src/__tests__/articoli-create-atdd.spec.ts` per 201 (giacenza=0), 409 codice duplicato con assenza `id`, 400 prezzo non valido con `error.details.field`, 403 ruolo TECNICO, 404 fornitore inesistente (AC-1..AC-5).

## Note Tecniche
- Riutilizzare i pattern di route e mapping errori presenti in `packages/backend/src/routes/fornitori.ts`.
- Riutilizzare pattern di validazione centralizzata in `packages/backend/src/services/anagrafiche-service.ts`.
- Applicare role guard coerente con `packages/backend/src/middleware/auth.ts`.

## Validazione Step 4 - Issue e Fix Applicati
1. Problema: AC-2 non era completamente testabile sul payload errore (solo error.code).
   Fix: AC-2 ora richiede anche `error.message` e assenza di `id` per evitare false positive.
2. Problema: AC-3 non specificava il campo di validazione da asserire.
   Fix: AC-3 ora include `error.code`, `error.details.field="prezzoVendita"` e messaggio esatto.
3. Problema: mancava un sad path su dipendenza critica `fornitoreId` (FK), con rischio comportamento non deterministico.
   Fix: aggiunto AC-5 con risposta 404 `FORNITORE_NOT_FOUND` e task dedicati in service/route/test.
