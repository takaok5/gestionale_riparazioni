---
status: ready-for-dev
priority: high
estimate: M
story_id: "1.5"
epic: "Epic 1 - Autenticazione e Gestione Utenti"
---

# Story 1.5: Modifica e Disattivazione Utente (Admin)

**As an** Admin, **I want** to edit user roles and deactivate accounts, **so that** I can manage access and permissions.

## Acceptance Criteria

### AC-1
_Derived from epic-details AC-1._
**Given** I am authenticated as `ADMIN` with header `Authorization: Bearer <admin_access_token>` and user `id=2` exists with role `TECNICO`
**When** I send `PUT /api/users/2` with JSON payload `{ "role": "COMMERCIALE" }`
**Then** I receive `200` and `response.body` contains `{ id: 2, role: "COMMERCIALE", isActive: true|false }` while `username` and `email` stay unchanged

### AC-2
_Derived from epic-details AC-2._
**Given** I am authenticated as `ADMIN` and test/database setup has user `id=2` active (`isActive=true`) before the request
**When** I send `PATCH /api/users/2/deactivate`
**Then** I receive `200` and `response.body` contains `{ id: 2, isActive: false }`

### AC-3
_Derived from epic-details AC-3._
**Given** user `id=1` is the only active account with role `ADMIN` in the users store/database and I am authenticated as `ADMIN`
**When** I send `PATCH /api/users/1/deactivate`
**Then** I receive `400` with `response.body.error.code = "LAST_ADMIN_DEACTIVATION_FORBIDDEN"` and `response.body.error.message = "Cannot deactivate the last admin"`

### AC-4
_Derived from epic-details AC-4._
**Given** I am authenticated as `TECNICO` with header `Authorization: Bearer <tecnico_access_token>`
**When** I send `PUT /api/users/2` with payload `{ "role": "COMMERCIALE" }`
**Then** I receive `403` with `response.body.error.code = "FORBIDDEN"`

## Target Modules

- `packages/backend/src/routes/users.ts`
- `packages/backend/src/services/users-service.ts`
- `packages/backend/src/middleware/auth.ts`
- `packages/backend/src/lib/errors.ts`
- `packages/shared/src/types/index.ts`
- `packages/backend/src/__tests__/users-update-deactivate.spec.ts`

## Task Breakdown

- [x] Task 1 (AC-1): estendere `packages/backend/src/routes/users.ts` con endpoint `PUT /api/users/:id`, middleware `authenticate` + `authorize("ADMIN")`, mapping errori dominio su status HTTP.
- [x] Task 2 (AC-1): implementare in `packages/backend/src/services/users-service.ts` update ruolo con validazione `role` (`ADMIN|TECNICO|COMMERCIALE`), lookup utente e persistenza su store test/Prisma.
- [x] Task 3 (AC-2): aggiungere endpoint `PATCH /api/users/:id/deactivate` in `packages/backend/src/routes/users.ts` con risposta payload utente aggiornato.
- [x] Task 4 (AC-2, AC-3): implementare in `packages/backend/src/services/users-service.ts` la disattivazione account e il blocco ultimo admin attivo con errore `LAST_ADMIN_DEACTIVATION_FORBIDDEN`.
- [x] Task 5 (AC-4): applicare enforcement RBAC in `packages/backend/src/routes/users.ts` usando `authorize("ADMIN")` su update/deactivate.
- [x] Task 6 (AC-1, AC-2, AC-3, AC-4): creare `packages/backend/src/__tests__/users-update-deactivate.spec.ts` con test API per update ruolo, deattivazione, blocco ultimo admin e `403` su ruolo non admin.
- [x] Task 7 (AC-2, AC-3): estendere helper/reset test in `packages/backend/src/services/users-service.ts` per setup deterministico stato `isActive` e conteggio admin.
- [x] Task 8 (AC-1, AC-2, AC-3): aggiornare `packages/shared/src/types/index.ts` con tipi payload/response per update e deactivate mantenendo coerenza backend/frontend.
