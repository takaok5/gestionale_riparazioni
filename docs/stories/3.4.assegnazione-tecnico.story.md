---
story: '3.4'
title: 'Assegnazione Tecnico'
status: drafted
priority: high
estimate: 4h
epic: 3
dependencies: ['3.1']
---

# Story 3.4: Assegnazione Tecnico

## User Story
**As an** Admin, **I want** to assign repairs to technicians, **so that** work is distributed among the team.

## Acceptance Criteria

### AC 1 - Assegnazione valida a tecnico
Source: Derived from epic-details AC-1.

**Given** sono autenticato come ADMIN e l'utente con id=7 ha ruolo TECNICO, e la riparazione con id=10 esiste.

**When** invio PATCH /api/riparazioni/10/assegna con body JSON { "tecnicoId": 7 }.

**Then** il campo iparazione.tecnicoId viene aggiornato a 7 e la risposta HTTP e' 200 con payload di successo.

### AC 2 - Rifiuto assegnazione a utente non tecnico
Source: Derived from epic-details AC-2.

**Given** sono autenticato come ADMIN e l'utente con id=5 ha ruolo COMMERCIALE.

**When** invio PATCH /api/riparazioni/10/assegna con body JSON { "tecnicoId": 5 }.

**Then** la risposta HTTP e' 400 con errore User must have TECNICO role e nessuna modifica a iparazione.tecnicoId.

### AC 3 - Riassegnazione a un altro tecnico
Source: Derived from epic-details AC-3.

**Given** sono autenticato come ADMIN, la riparazione id=10 e' gia' assegnata a 	ecnicoId=7, e l'utente con id=8 ha ruolo TECNICO.

**When** invio PATCH /api/riparazioni/10/assegna con body JSON { "tecnicoId": 8 }.

**Then** la riparazione viene riassegnata e iparazione.tecnicoId diventa 8 con risposta HTTP 200.

### AC 4 - Divieto assegnazione per non Admin
Source: Derived from epic-details AC-4.

**Given** sono autenticato con ruolo TECNICO (non ADMIN).

**When** invio PATCH /api/riparazioni/10/assegna con body JSON valido.

**Then** la risposta HTTP e' 403 con codice errore FORBIDDEN.

## Task Breakdown

- [ ] Implementare endpoint PATCH /api/riparazioni/:id/assegna in packages/backend/src/routes/riparazioni.ts con uthenticate e uthorize("ADMIN").
- [ ] Aggiungere nel route handler parsing di id da params e 	ecnicoId da body, con mapping errori coerente al pattern del file.
- [ ] Implementare funzione service per assegnazione/riassegnazione in packages/backend/src/services/riparazioni-service.ts con validazione sPositiveInteger.
- [ ] Validare che l'utente destinazione abbia ruolo TECNICO e restituire errore di validazione con messaggio User must have TECNICO role.
- [ ] Aggiornare sia percorso test-store sia percorso Prisma nel service per mantenere comportamento coerente tra test e runtime.
- [ ] Creare test ATDD RED in packages/backend/src/__tests__/riparazioni-assegnazione-atdd.spec.ts che coprano AC-1..AC-4 con codici HTTP e messaggi attesi.
- [ ] Verificare assenza regressioni sui test esistenti di riparazioni in packages/backend/src/__tests__/riparazioni-*.spec.ts.

## Notes
- Le risposte devono usare il formato errore standard backend { error: { code, message, details } }.
- Le validazioni di input devono seguire i pattern gia' presenti in iparazioni-service.ts.
