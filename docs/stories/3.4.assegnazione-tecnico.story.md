---
story: '3.4'
title: 'Assegnazione Tecnico'
status: ready-for-dev
priority: high
estimate: 4h
epic: 3
dependencies: ['3.1']
---

# Story 3.4: Assegnazione Tecnico

## User Story
**As an** Admin, **I want** to assign repairs to technicians, **so that** work is distributed among the team.

## Acceptance Criteria

### AC 1 - Assegnazione valida a tecnico
Source: Derived from epic-details AC-1.

**Given** sono autenticato come `ADMIN`, la riparazione con `id=10` esiste, e l'utente con `id=7` ha ruolo `TECNICO`.

**When** invio `PATCH /api/riparazioni/10/assegna` con body JSON `{ "tecnicoId": 7 }`.

**Then** ricevo `200` e il payload contiene `data.id = 10` e `data.tecnicoId = 7`.

### AC 2 - Rifiuto assegnazione a utente non tecnico
Source: Derived from epic-details AC-2.

**Given** sono autenticato come `ADMIN`, la riparazione con `id=10` esiste, e l'utente con `id=5` ha ruolo `COMMERCIALE`.

**When** invio `PATCH /api/riparazioni/10/assegna` con body JSON `{ "tecnicoId": 5 }`.

**Then** ricevo `400` con `error.message = "User must have TECNICO role"` e `error.code = "VALIDATION_ERROR"`.

### AC 3 - Riassegnazione a un altro tecnico
Source: Derived from epic-details AC-3.

**Given** sono autenticato come `ADMIN`, la riparazione con `id=10` e' gia' assegnata a `tecnicoId=7`, e l'utente con `id=8` ha ruolo `TECNICO`.

**When** invio `PATCH /api/riparazioni/10/assegna` con body JSON `{ "tecnicoId": 8 }`.

**Then** ricevo `200` e il payload contiene `data.id = 10` e `data.tecnicoId = 8`.

### AC 4 - Divieto assegnazione per non Admin
Source: Derived from epic-details AC-4.

**Given** sono autenticato con ruolo `TECNICO` (non `ADMIN`).

**When** invio `PATCH /api/riparazioni/10/assegna` con body JSON `{ "tecnicoId": 7 }`.

**Then** ricevo `403` con `error.code = "FORBIDDEN"` e `error.message = "Accesso negato"`.

## Task Breakdown

- [ ] Aggiungere endpoint `PATCH /api/riparazioni/:id/assegna` in `packages/backend/src/routes/riparazioni.ts` con `authenticate` e `authorize("ADMIN")` (copre AC-1 e AC-4).
- [ ] Implementare mapping errori route -> HTTP in `packages/backend/src/routes/riparazioni.ts` usando `buildErrorResponse` come negli altri handler riparazioni (copre AC-2).
- [ ] Introdurre input type e parser per assegnazione in `packages/backend/src/services/riparazioni-service.ts` con `asPositiveInteger` su `riparazioneId` e `tecnicoId` (copre AC-1/2/3).
- [ ] Implementare validazione ruolo utente assegnato (`TECNICO`) con errore `VALIDATION_ERROR` e messaggio `User must have TECNICO role` (copre AC-2).
- [ ] Implementare aggiornamento assegnazione/riassegnazione in entrambi i percorsi service (`NODE_ENV=test` e Prisma) mantenendo `tecnicoId` coerente (copre AC-1 e AC-3).
- [ ] Creare test ATDD RED in `packages/backend/src/__tests__/riparazioni-assegnazione-atdd.spec.ts` con casi separati per AC-1, AC-2, AC-3 e AC-4.
- [ ] Eseguire regression test su `packages/backend/src/__tests__/riparazioni-create-atdd.spec.ts`, `packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts` e `packages/backend/src/__tests__/riparazioni-detail-atdd.spec.ts`.

## Notes
- Le risposte errore devono rispettare il formato `{ error: { code, message, details } }`.
- L'implementazione deve seguire i pattern di validazione gia' presenti in `riparazioni-service.ts`.
