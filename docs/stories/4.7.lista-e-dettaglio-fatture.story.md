---
status: drafted
priority: high
estimate: S
story_id: "4.7"
title: "Lista e Dettaglio Fatture"
---

# Story 4.7: Lista e Dettaglio Fatture

## User Story
Come Commerciale voglio visualizzare, filtrare e consultare i PDF delle fatture cosi' da gestire la fatturazione in modo rapido e verificabile.

## Acceptance Criteria (Expanded)

### AC-1
**Given** esistono 20 fatture persistite e sono accessibili con credenziali ruolo `COMMERCIALE`.
**When** invio `GET /api/fatture?page=1&limit=10`.
**Then** ricevo HTTP `200` con `data` contenente 10 fatture e `meta.page=1`, `meta.limit=10`, `meta.total=20`.

### AC-2
**Given** esistono fatture in stato `EMESSA` e `PAGATA`.
**When** invio `GET /api/fatture?stato=PAGATA`.
**Then** ricevo HTTP `200` e ogni elemento in `data[]` ha `stato="PAGATA"`.

### AC-3
**Given** esistono fatture con `dataEmissione` compresa tra `2026-02-01` e `2026-02-28`.
**When** invio `GET /api/fatture?dataDa=2026-02-01&dataA=2026-02-28`.
**Then** ricevo HTTP `200` e ogni fattura in `data[]` rispetta il range date richiesto.

### AC-4
**Given** la fattura `id=8` ha 2 pagamenti registrati.
**When** invio `GET /api/fatture/8`.
**Then** ricevo HTTP `200` con `data.id=8`, `data.pagamenti.length=2` e ogni elemento `data.pagamenti[]` include campi testabili `id`, `importo`, `metodo`, `dataPagamento`.

### AC-5
**Given** la fattura `id=8` ha un PDF generato.
**When** invio `GET /api/fatture/8/pdf`.
**Then** ricevo HTTP `200` con header `Content-Type: application/pdf` e `Content-Disposition` che contiene `filename=` terminante in `.pdf` e include `numeroFattura` normalizzato (`/` sostituito con `-`).

### AC-6
**Given** il limite massimo di paginazione consentito e' `100`.
**When** invio `GET /api/fatture?limit=1000`.
**Then** ricevo HTTP `400` con `error.code="VALIDATION_ERROR"` e `error.details.field="limit"`.

## AC Source Mapping
- AC-1: Derived from epic-details AC-1 (`docs/epics/epic-4-preventivi-fatturazione.md:106`)
- AC-2: Derived from epic-details AC-2 (`docs/epics/epic-4-preventivi-fatturazione.md:107`)
- AC-3: Derived from epic-details AC-3 (`docs/epics/epic-4-preventivi-fatturazione.md:108`)
- AC-4: Derived from epic-details AC-4 (`docs/epics/epic-4-preventivi-fatturazione.md:109`)
- AC-5: Derived from epic-details AC-5 (`docs/epics/epic-4-preventivi-fatturazione.md:110`)
- AC-6: NO SOURCE in epic-details, added during Step 4 validation to cover mandatory sad path for list endpoint.

## Task Breakdown
- [x] Estendere il service in `packages/backend/src/services/fatture-service.ts` con funzione list che supporta filtri `stato`, `dataDa`, `dataA` e metadata paginazione (AC-1, AC-2, AC-3).
- [x] Estendere le route in `packages/backend/src/routes/fatture.ts` con endpoint `GET /api/fatture` usando parsing query, role guard e mapping errori coerente (AC-1, AC-2, AC-3).
- [x] Verificare/rafforzare `GET /api/fatture/:id` in `packages/backend/src/routes/fatture.ts` e `packages/backend/src/services/fatture-service.ts` per completezza `pagamenti` in risposta (AC-4).
- [x] Aggiungere endpoint `GET /api/fatture/:id/pdf` in `packages/backend/src/routes/fatture.ts` con integrazione a `packages/backend/src/services/fatture-pdf-service.ts` per stream PDF e header file (AC-5).
- [x] Aggiungere validazione query `page/limit/stato/dataDa/dataA` in `packages/backend/src/services/fatture-service.ts` e mapping errore in `packages/backend/src/routes/fatture.ts` per sad path HTTP `400` (AC-6).
- [x] Aggiungere test ATDD dedicati in `packages/backend/src/__tests__/fatture-lista-dettaglio-atdd.spec.ts` e integrare eventuali assert in `packages/backend/src/__tests__/fatture-pagamenti-atdd.spec.ts` (AC-1..AC-5).
- [x] Coprire con test ATDD il sad path `GET /api/fatture?limit=1000` e le asserzioni su `error.details.field` in `packages/backend/src/__tests__/fatture-lista-dettaglio-atdd.spec.ts` (AC-6).
- [x] Aggiornare eventuali export/bootstrap in `packages/backend/src/index.ts` se necessari per i nuovi endpoint (AC-1..AC-5) - verificato: router gia' registrato, nessuna modifica necessaria.

## Note Tecniche
- Riutilizzare il pattern di paginazione/meta gia' presente in `packages/backend/src/services/riparazioni-service.ts`.
- Mantenere il response envelope coerente (`{ data, meta }` per list, `{ data }` per detail).
- Applicare autorizzazione esplicita per ruolo `COMMERCIALE` come nelle route fatture esistenti.

## Validazione Step 4 - Issue e Fix Applicati
1. Problema: AC-4 non rendeva verificabile il numero di pagamenti (solo "contiene entrambe le righe").
   Fix: AC-4 ora impone `data.pagamenti.length=2` e campi minimi testabili per ogni pagamento.
2. Problema: AC-5 usava il termine ambiguo "filename coerente", non traducibile in assert deterministico.
   Fix: AC-5 ora vincola `Content-Disposition`, estensione `.pdf` e normalizzazione `numeroFattura` (`/` -> `-`).
3. Problema: Mancava un AC di sad path, richiesto dalla checklist di validazione quality-gate.
   Fix: Aggiunto AC-6 con caso `limit=1000` e aspettativa `400 VALIDATION_ERROR` su `field=limit`.
