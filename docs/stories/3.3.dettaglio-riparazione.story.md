---
status: ready-for-dev
priority: medium
estimate: M
story_id: "3.3"
epic: "Epic 3 - Gestione Riparazioni"
---

# Story 3.3 Dettaglio Riparazione

**As a** Tecnico, **I want** to view complete repair details with history, **so that** I have full context for the repair.

## Dependencies

- Story 3.1
- Story 3.2

## Acceptance Criteria

### AC-1
**Given** esiste la riparazione con `id=10`
**When** invio `GET /api/riparazioni/10`
**Then** ricevo `200` con body `{ data: { id: 10, cliente: { id, nome, telefono, email }, tecnico: { id, username }, stato } }`
Source: Derived from epic-details AC-1

### AC-2
**Given** la riparazione `id=10` ha cambiato `stato` 3 volte
**When** invio `GET /api/riparazioni/10`
**Then** la risposta include `data.statiHistory` con esattamente `3` elementi e ogni elemento contiene `{ stato, dataOra, userId, note }` con `dataOra` in formato ISO-8601
Source: Derived from epic-details AC-2

### AC-3
**Given** la riparazione `id=10` ha `2` preventivi e `5` ricambi
**When** invio `GET /api/riparazioni/10`
**Then** la risposta include `data.preventivi` di lunghezza `2` e `data.ricambi` di lunghezza `5`, con almeno i campi `preventivi { id, numeroPreventivo, stato, totale }` e `ricambi { id, codiceArticolo, descrizione, quantita, prezzoUnitario }`
Source: Derived from epic-details AC-3

### AC-4
**Given** la riparazione `id=999` non esiste
**When** invio `GET /api/riparazioni/999`
**Then** ricevo `404` con body `{ error: { code: "RIPARAZIONE_NOT_FOUND", message: "Riparazione non trovata" } }`
Source: Derived from epic-details AC-4

## Target Modules

- `packages/backend/src/routes/riparazioni.ts`
- `packages/backend/src/services/riparazioni-service.ts`
- `packages/backend/prisma/schema.prisma`

## Task Breakdown

- [x] Task 1 (AC-1, AC-4): aggiornare `packages/backend/src/routes/riparazioni.ts` per aggiungere `GET /api/riparazioni/:id`, validare `id`, chiamare il service e mappare i fallimenti in `404 RIPARAZIONE_NOT_FOUND` e `400 VALIDATION_ERROR`.
- [x] Task 2 (AC-1, AC-2, AC-3, AC-4): implementare in `packages/backend/src/services/riparazioni-service.ts` il recupero dettaglio con shape `{ data: { id, cliente, tecnico, stato, statiHistory, preventivi, ricambi } }`, con `statiHistory` ordinato cronologicamente e mapping errori dominio.
- [x] Task 3 (AC-2, AC-3): estendere `packages/backend/prisma/schema.prisma` per le relazioni richieste da `statiHistory`, `preventivi` e `ricambi` usate nel dettaglio, mantenendo i select espliciti nelle query.
- [x] Task 4 (AC-1, AC-2, AC-3, AC-4): aggiungere test ATDD in `packages/backend/src/__tests__/riparazioni-detail-atdd.spec.ts` per `200` con shape dettagliata, `statiHistory` da 3 entry, `preventivi=2`, `ricambi=5` e `404` con `error.code = RIPARAZIONE_NOT_FOUND`.

## Validation Fixes Applied

1. Problema: AC-1 usava "dati completi", non direttamente verificabile in test.
   Fix: definita shape minima del body `data` con campi espliciti (`id`, `cliente`, `tecnico`, `stato`).

2. Problema: AC-3 usava "dettagli completi" per preventivi/ricambi senza vincoli testabili.
   Fix: specificate cardinalita (`2` preventivi, `5` ricambi) e campi minimi richiesti per entrambe le collezioni.

3. Problema: AC-4 non specificava il formato standard dell'errore.
   Fix: definito body errore esplicito `{ error: { code, message } }` coerente con le route esistenti.
