story_id: '6.1'
story_title: 'Dashboard Operativa'
source_story_file: 'docs/epics/epic-6-dashboard-reportistica.md'
source_section: 'Epic 6 -> Story 6.1'
acceptance_criteria:
  - 'AC-1: Admin GET /api/dashboard -> riparazioniPerStato + caricoTecnici + alertMagazzino + ultimiPagamenti'
  - 'AC-2: Tecnico GET /api/dashboard -> solo mieRiparazioni/nextRiparazioni; no caricoTecnici/alertMagazzino'
  - 'AC-3: Commerciale GET /api/dashboard -> clientiAttivi + preventiviPendenti + fattureNonPagate + fatturato30gg'
  - 'AC-4: unauthenticated GET /api/dashboard -> 401 Unauthorized'
target_modules:
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/index.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/middleware/auth.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/services/riparazioni-service.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/services/anagrafiche-service.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/routes/fatture.ts'
  - 'no existing files found for dashboard route/service (new module expected under packages/backend/src/routes and packages/backend/src/services)'
patterns_to_follow:
  - 'Route wiring in app bootstrap: packages/backend/src/index.ts:23-33 (app.use("/api/...", router))'
  - 'Auth + role guard middleware pattern: packages/backend/src/middleware/auth.ts:33-36,106-113'
  - 'Router error mapping with buildErrorResponse: packages/backend/src/routes/riparazioni.ts:291-309'
  - 'Role-specific guard helper in route: packages/backend/src/routes/fatture.ts:249-266'
  - 'Service split test-vs-db with NODE_ENV gate: packages/backend/src/services/riparazioni-service.ts:2065-2140'
  - 'Alert stock query/filter reusable for alertMagazzino: packages/backend/src/services/anagrafiche-service.ts:5423-5471'
  - 'ATDD style with role tokens + request(app): packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts:12,22,48,76'
dependencies:
  - 'packages/backend/src/index.ts imports all routers and is imported by backend tests via ../index.js'
  - 'Dashboard route must depend on packages/backend/src/middleware/auth.ts for 401/403 behavior consistency'
  - 'Dashboard service will likely depend on Prisma models Riparazione/User/Fattura/Cliente/Articolo from packages/backend/prisma/schema.prisma'
  - 'Potential reuse points: riparazioni-service list/query patterns and anagrafiche-service low-stock logic'
  - 'Route/service outputs should stay compatible with shared API expectations in packages/shared/src/types/index.ts'
risks:
  - 'Role-specific payload contract can regress if Admin/Tecnico/Commerciale branches share fields accidentally'
  - 'N+1 or heavy aggregate queries on dashboard can degrade performance without grouped queries/limits'
  - 'Date-window logic for ultimiPagamenti/fatturato30gg can be timezone-sensitive and flaky in tests'
  - 'Missing seeding for multi-role datasets may cause brittle ATDD tests for AC-1/2/3'
  - 'Unauthorized path may return existing localized error payload ("Token mancante") instead of exact "Unauthorized" string from AC text'
existing_tests:
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/articoli-list-search-alert-atdd.spec.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/fatture-lista-dettaglio-atdd.spec.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/auth-refresh.spec.ts'