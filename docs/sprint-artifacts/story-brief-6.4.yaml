story_id: '6.4'
story_title: 'Report Riparazioni'
source_story_file: 'docs/epics/epic-6-dashboard-reportistica.md'
source_section: 'Epic 6 -> Story 6.4'
acceptance_criteria:
  - 'AC-1: Given riparazioni completed in January 2026 When I GET /api/report/riparazioni?dateFrom=2026-01-01&dateTo=2026-01-31 Then I receive { totaleRiparazioni: 25, completate: 20, tempoMedioPerStato: { IN_DIAGNOSI: 2.5, IN_LAVORAZIONE: 5.0 }, tassoCompletamento: 80.0, countPerStato: { RICEVUTA: 1, COMPLETATA: 20, ANNULLATA: 4 } }'
  - 'AC-2: Given riparazioni for tecnico id=7 exist When I GET /api/report/riparazioni?tecnicoId=7 Then I receive report filtered only for that tecnico'
  - 'AC-3: Given I am Tecnico When I GET /api/report/riparazioni Then I receive 403 "Admin only"'
  - 'AC-4: Given riparazioni with varying durations When I GET /api/report/riparazioni Then tempoMedioPerStato shows average days spent in each stato'
target_modules:
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/index.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/routes/dashboard.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/services/dashboard-service.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/services/riparazioni-service.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/routes/riparazioni.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/middleware/auth.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/prisma/schema.prisma'
  - 'No report-specific router/service yet (expected under packages/backend/src/routes/report.ts and packages/backend/src/services/report-service.ts)'
patterns_to_follow:
  - 'packages/backend/src/index.ts:24-35 - router registration and middleware setup; mount reportRouter here'
  - 'packages/backend/src/routes/dashboard.ts:15-82 - authenticate, call service, map failures via buildErrorResponse, then return 200'
  - 'packages/backend/src/services/dashboard-service.ts:222-320 - fetch-all + reduce aggregation pattern'
  - 'packages/backend/src/services/dashboard-service.ts:473-526 - sequential service composition with consistent failure handling'
  - 'packages/backend/src/services/riparazioni-service.ts:1254-1336 - validate date filters and build Prisma where clause'
  - 'packages/backend/src/routes/riparazioni.ts:291-319 - query DTO + route wiring + error mapping pattern'
  - 'packages/backend/src/middleware/auth.ts:33-60 and 106-113 - authenticate and authorize("ADMIN") for 403 admin-only enforcement'
dependencies:
  - 'packages/backend/src/index.ts imports and mounts routers; report router must be wired here'
  - 'packages/backend/src/routes/dashboard.ts depends on packages/backend/src/services/dashboard-service.ts'
  - 'packages/backend/src/services/dashboard-service.ts depends on packages/backend/src/services/riparazioni-service.ts'
  - 'packages/backend/src/routes/riparazioni.ts depends on list/filter contracts reused by report filtering'
  - 'packages/backend/prisma/schema.prisma defines Riparazione indexed fields used by report aggregates'
risks:
  - 'Large date windows may require scanning many riparazioni if aggregation is implemented only via pagination loops'
  - 'tempoMedioPerStato can be wrong when stato-history timestamps are missing or incomplete'
  - 'Missing authorize("ADMIN") on /api/report/riparazioni would violate AC-3'
  - 'Inconsistent timezone handling for dateFrom/dateTo can break January range filtering'
  - 'No dedicated /api/report ATDD tests exist yet, so regressions can pass unnoticed'
existing_tests:
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/dashboard-carico-tecnici-atdd.spec.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/riparazioni-list-filter-atdd.spec.ts'
  - 'None yet for /api/report endpoints'