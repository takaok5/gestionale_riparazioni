story_id: "8.1"
story_title: "Attivazione Account Portale Cliente"
story_source: "docs/epics/epic-8-portale-clienti.md"
acceptance_criteria:
  - id: "AC-1"
    text: "Given cliente id=5 has email cliente@test.it and no portal account When I POST /api/clienti/5/portal-account Then account is created with stato INVITATO and activation email is sent, I receive 201"
  - id: "AC-2"
    text: "Given cliente id=5 already has active portal account When I POST /api/clienti/5/portal-account Then I receive 409 with error PORTAL_ACCOUNT_ALREADY_EXISTS"
  - id: "AC-3"
    text: "Given cliente id=5 has null email When I POST /api/clienti/5/portal-account Then I receive 400 with error CUSTOMER_EMAIL_REQUIRED"
  - id: "AC-4"
    text: "Given activation token is valid and not expired When customer sets password Then stato becomes ATTIVO and first login is allowed"
target_modules:
  - "packages/backend/src/routes/clienti.ts"
  - "packages/backend/src/services/anagrafiche-service.ts"
  - "packages/backend/src/services/auth-service.ts"
  - "packages/backend/src/middleware/auth.ts"
  - "packages/backend/src/services/notifiche-service.ts"
  - "packages/backend/src/lib/errors.ts"
  - "packages/backend/prisma/schema.prisma"
patterns_to_follow:
  - pattern: "Route-level error mapping with shared error envelope"
    example: "packages/backend/src/routes/clienti.ts:33"
    details: "Use a dedicated respond*Failure helper that maps service failure codes to HTTP status and buildErrorResponse."
  - pattern: "Service input parsing and validation failures"
    example: "packages/backend/src/services/anagrafiche-service.ts:1343"
    details: "Use parser functions returning structured ValidationFailure with details."
  - pattern: "Prisma transaction with explicit select and guarded failure mapping"
    example: "packages/backend/src/services/anagrafiche-service.ts:2748"
    details: "Wrap writes in prisma.$transaction and map catch branch to SERVICE_UNAVAILABLE."
  - pattern: "Notification creation flow for testable email-like side effects"
    example: "packages/backend/src/services/notifiche-service.ts:174"
    details: "Build subject/body payload consistently and keep deterministic behavior for tests."
  - pattern: "JWT issue/verify helpers with explicit token type"
    example: "packages/backend/src/middleware/auth.ts:84"
    details: "Reuse token payload conventions and expiration handling for activation tokens."
  - pattern: "Password hashing and auth lifecycle"
    example: "packages/backend/src/services/auth-service.ts:1"
    details: "Reuse bcrypt-based password handling and login token flow when activation completes."
dependencies:
  - "packages/backend/src/index.ts (mounts clientiRouter at /api/clienti)"
  - "packages/backend/src/services/dashboard-service.ts (imports anagrafiche-service for clienti aggregations)"
  - "packages/backend/src/services/report-service.ts (imports anagrafiche-service for cliente data)"
  - "packages/backend/src/routes/fornitori.ts (shared dependency on anagrafiche-service exports)"
  - "packages/backend/src/routes/articoli.ts (shared dependency on anagrafiche-service exports)"
risks:
  - "Dual data paths in anagrafiche-service (test store vs Prisma) can diverge if portal-account logic is added in one path only."
  - "Activation email behavior currently relies on notifications service patterns; requirement may fail without explicit integration path."
  - "Activation token flow depends on JWT configuration; missing JWT_SECRET leads to runtime auth failures."
existing_tests:
  - "packages/backend/src/__tests__/clienti-create-atdd.spec.ts"
  - "packages/backend/src/__tests__/clienti-list-search-atdd.spec.ts"
  - "packages/backend/src/__tests__/clienti-detail-update-atdd.spec.ts"
  - "packages/backend/src/__tests__/notifiche-list-atdd.spec.ts"
