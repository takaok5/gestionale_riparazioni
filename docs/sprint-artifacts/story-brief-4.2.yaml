story_id: '4.2'
story_title: 'Modifica Preventivo (Bozza)'
source_story_file: 'docs/epics/epic-4-preventivi-fatturazione.md'
acceptance_criteria:
  - id: 'AC-1'
    text: 'Given preventivo id=5 has stato BOZZA When I PUT /api/preventivi/5 with updated voci Then voci are replaced and totals are recalculated, response 200'
  - id: 'AC-2'
    text: 'Given preventivo id=5 has stato BOZZA When I PUT /api/preventivi/5 adding a new voce Then voci count increases and totals are recalculated correctly'
  - id: 'AC-3'
    text: 'Given preventivo id=5 has stato INVIATO When I PUT /api/preventivi/5 Then response 400 with cannot edit error'
  - id: 'AC-4'
    text: 'Given preventivo id=5 has stato APPROVATO When I PUT /api/preventivi/5 Then response 400 with cannot edit error'
target_modules:
  - 'packages/backend/src/routes/preventivi.ts'
  - 'packages/backend/src/services/preventivi-service.ts'
  - 'packages/backend/prisma/schema.prisma'
  - 'packages/backend/src/__tests__/preventivi-create-atdd.spec.ts'
  - 'packages/backend/src/__tests__/preventivi-detail-atdd.spec.ts'
patterns_to_follow:
  - pattern: 'Route-level Zod validation + structured error response'
    reference: 'packages/backend/src/routes/preventivi.ts:64'
  - pattern: 'Totals computed centrally via computeTotals(subtotale, iva, totale)'
    reference: 'packages/backend/src/services/preventivi-service.ts:155'
  - pattern: 'Dual-path service implementation (test store vs Prisma DB)'
    reference: 'packages/backend/src/services/preventivi-service.ts:274'
  - pattern: 'DB create/get flow for preventivo with include voci'
    reference: 'packages/backend/src/services/preventivi-service.ts:327'
dependencies:
  - module: 'packages/backend/src/index.ts'
    uses: 'registers preventiviRouter'
  - module: 'packages/backend/src/routes/preventivi.ts'
    uses: 'imports preventivi-service functions'
  - module: 'packages/backend/src/__tests__/preventivi-create-atdd.spec.ts'
    uses: 'imports resetPreventiviStoreForTests from preventivi-service'
  - module: 'packages/backend/src/__tests__/preventivi-detail-atdd.spec.ts'
    uses: 'imports resetPreventiviStoreForTests from preventivi-service'
risks:
  - 'PUT /api/preventivi/:id endpoint does not exist yet; route+service+tests must be added coherently.'
  - 'State gate (only BOZZA editable) is not enforced anywhere today; risk of unauthorized edits without explicit checks.'
  - 'Service has separate test-store and Prisma paths; implementing update in only one path will create behavior drift.'
  - 'Replacing voci in relational table may leave stale rows if delete/recreate is not transactional.'
  - 'stato is stored as string; business-state validation is purely application-side and easy to bypass if inconsistently applied.'
existing_tests:
  - 'packages/backend/src/__tests__/preventivi-create-atdd.spec.ts'
  - 'packages/backend/src/__tests__/preventivi-detail-atdd.spec.ts'
