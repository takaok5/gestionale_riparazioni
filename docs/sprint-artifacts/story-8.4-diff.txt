# git diff --stat
 docs/sprint-artifacts/STATE.md                     |  18 +-  .../portal-ordini-list-detail.atdd.spec.ts         | 258 +++++++++++++++++++++  packages/backend/src/routes/auth.ts                | 118 ++++++++++  packages/backend/src/services/auth-service.ts      | 214 +++++++++++++++++  .../backend/src/services/riparazioni-service.ts    |  23 ++  5 files changed, 622 insertions(+), 9 deletions(-)

# git diff
diff --git a/docs/sprint-artifacts/STATE.md b/docs/sprint-artifacts/STATE.md index 4b6a000..d0494c6 100644 --- a/docs/sprint-artifacts/STATE.md +++ b/docs/sprint-artifacts/STATE.md @@ -2,20 +2,20 @@    ## Current Story   -**Story:** 8.3 -**Step:** 10 -**Status:** completed +**Story:** 8.4 +**Step:** 9 +**Status:** in_progress    ## Progress   -` -[##########] 100% -` +``` +[################    ] 80% +```    ## Session   -- **Last activity:** 2026-02-13T18:05:44.5985578+01:00 -- **Resume from:** completed +- **Last activity:** 2026-02-13T18:41:17.0388115+01:00 +- **Resume from:** step 9    --- -*Auto-updated by story-pipeline* +*Auto-updated by story-pipeline* \ No newline at end of file diff --git a/packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts b/packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts new file mode 100644 index 0000000..d3a6b05 --- /dev/null +++ b/packages/backend/src/__tests__/portal-ordini-list-detail.atdd.spec.ts @@ -0,0 +1,258 @@ +import jwt from "jsonwebtoken"; +import request from "supertest"; +import { beforeEach, describe, expect, it } from "vitest"; +import { app } from "../index.js"; +import { +  resetAnagraficheStoreForTests, +  seedClienteForTests, +} from "../services/anagrafiche-service.js"; +import { resetPortalAccountsForTests } from "../services/auth-service.js"; +import { resetRateLimiter } from "../services/login-rate-limit.js"; +import { resetNotificheStoreForTests } from "../services/notifiche-service.js"; +import { resetPreventiviStoreForTests } from "../services/preventivi-service.js"; +import { +  resetRiparazioniStoreForTests, +  setRiparazioneStatoForTests, +} from "../services/riparazioni-service.js"; +import { resetUsersStoreForTests } from "../services/users-service.js"; + +type Role = "ADMIN" | "TECNICO" | "COMMERCIALE"; + +function buildAccessToken(payload: { userId: number; role: Role }): string { +  return jwt.sign({ ...payload, tokenType: "access" as const }, "test-jwt-secret", { +    expiresIn: "15m", +  }); +} + +function authHeader(role: Role, userId = 8801): string { +  return `Bearer ${buildAccessToken({ userId, role })}`; +} + +interface PortalSessionInput { +  clienteId?: number; +  email?: string; +  password?: string; +} + +async function prepareActivatedPortalSession(input?: PortalSessionInput): Promise<string> { +  const clienteId = input?.clienteId ?? 5; +  const email = input?.email ?? "cliente@test.it"; +  const loginPin = input?.password ?? "Password123!"; + +  const createResponse = await request(app) +    .post(`/api/clienti/${clienteId}/portal-account`) +    .set("Authorization", authHeader("COMMERCIALE", 8802)) +    .send({}); +  expect(createResponse.status).toBe(201); + +  const activateResponse = await request(app) +    .post("/api/portal/auth/activate") +    .send({ token: `portal-${clienteId}-token-valid`, password: loginPin }); +  expect(activateResponse.status).toBe(200); + +  const loginResponse = await request(app) +    .post("/api/portal/auth/login") +    .send({ email, password: loginPin }); +  expect(loginResponse.status).toBe(200); +  expect(loginResponse.body.accessToken).toEqual(expect.any(String)); + +  return loginResponse.body.accessToken as string; +} + +async function createRiparazione(index: number): Promise<number> { +  const response = await request(app) +    .post("/api/riparazioni") +    .set("Authorization", authHeader("COMMERCIALE", 9000 + index)) +    .send({ +      clienteId: 5, +      tipoDispositivo: "SMARTPHONE", +      marcaDispositivo: `Brand-${index}`, +      modelloDispositivo: `Model-${index}`, +      serialeDispositivo: `SER-${index}`, +      descrizioneProblema: `Guasto numero ${index}`, +      accessoriConsegnati: "Caricatore", +      priorita: "NORMALE", +    }); + +  expect(response.status).toBe(201); +  expect(response.body.id).toEqual(expect.any(Number)); +  return response.body.id as number; +} + +beforeEach(() => { +  resetUsersStoreForTests(); +  resetAnagraficheStoreForTests(); +  resetRiparazioniStoreForTests(); +  resetPreventiviStoreForTests(); +  resetNotificheStoreForTests(); +  resetPortalAccountsForTests(); +  resetRateLimiter(); + +  seedClienteForTests({ +    id: 5, +    nome: "Cliente Test SRL", +    codiceCliente: "CLI-000005", +    email: "cliente@test.it", +  }); +  seedClienteForTests({ +    id: 99, +    nome: "Cliente Altro", +    codiceCliente: "CLI-000099", +    email: "cliente99@test.it", +  }); +}); + +describe("AC-1 - Given customer id=5 has 12 orders When GET /api/portal/ordini?page=1&limit=10 Then 10 items + pagination metadata", () => { +  it("Tests AC-1: Given customer id=5 has 12 orders When GET /api/portal/ordini?page=1&limit=10 Then HTTP 200 and exactly 10 items", async () => { +    for (let i = 1; i <= 12; i += 1) { +      await createRiparazione(i); +    } +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini?page=1&limit=10") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(Array.isArray(response.body.data)).toBe(true); +    expect(response.body.data.length).toBe(10); +    expect(response.body.meta.page).toBe(1); +    expect(response.body.meta.limit).toBe(10); +    expect(response.body.meta.total).toBe(12); +    expect(response.body.meta.totalPages).toBe(2); +  }); + +  it("Tests AC-1: Given same scenario When first page is requested Then response includes deterministic pagination keys", async () => { +    for (let i = 1; i <= 12; i += 1) { +      await createRiparazione(100 + i); +    } +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini?page=1&limit=10") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(response.body).toHaveProperty("data"); +    expect(response.body).toHaveProperty("meta"); +    expect(typeof response.body.meta.total).toBe("number"); +    expect(response.body.meta.total).toBeGreaterThanOrEqual(10); +  }); +}); + +describe("AC-2 - Given orders with states IN_ATTESA and IN_LAVORAZIONE exist When GET /api/portal/ordini?stato=IN_LAVORAZIONE Then only IN_LAVORAZIONE", () => { +  it("Tests AC-2: Given mixed states When filtered by IN_LAVORAZIONE Then every returned item has that state", async () => { +    const ids: number[] = []; +    for (let i = 1; i <= 6; i += 1) { +      ids.push(await createRiparazione(200 + i)); +    } +    setRiparazioneStatoForTests(ids[0], "IN_ATTESA_RICAMBI"); +    setRiparazioneStatoForTests(ids[1], "IN_LAVORAZIONE"); +    setRiparazioneStatoForTests(ids[2], "IN_LAVORAZIONE"); +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini?stato=IN_LAVORAZIONE") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(Array.isArray(response.body.data)).toBe(true); +    expect(response.body.data.length).toBeGreaterThanOrEqual(1); +    for (const item of response.body.data as Array<Record<string, unknown>>) { +      expect(item.stato).toBe("IN_LAVORAZIONE"); +    } +  }); + +  it("Tests AC-2: Given IN_ATTESA and IN_LAVORAZIONE exist When stato filter applied Then non matching states are excluded", async () => { +    const ids: number[] = []; +    for (let i = 1; i <= 5; i += 1) { +      ids.push(await createRiparazione(300 + i)); +    } +    setRiparazioneStatoForTests(ids[0], "IN_ATTESA_RICAMBI"); +    setRiparazioneStatoForTests(ids[1], "IN_LAVORAZIONE"); +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini?stato=IN_LAVORAZIONE") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(Array.isArray(response.body.data)).toBe(true); +    const hasWrongState = (response.body.data as Array<{ stato?: string }>).some( +      (item) => item.stato !== "IN_LAVORAZIONE", +    ); +    expect(hasWrongState).toBe(false); +  }); +}); + +describe("AC-3 - Given order id=20 belongs to authenticated customer When GET /api/portal/ordini/20 Then detail with stato/importi/timeline/documenti", () => { +  it("Tests AC-3: Given order id=20 belongs to authenticated customer When detail is requested Then HTTP 200 with required fields", async () => { +    for (let i = 1; i <= 20; i += 1) { +      await createRiparazione(400 + i); +    } +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini/20") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(response.body.data.id).toBe(20); +    expect(typeof response.body.data.stato).toBe("string"); +    expect(response.body.data).toHaveProperty("importi"); +    expect(response.body.data).toHaveProperty("timeline"); +    expect(response.body.data).toHaveProperty("documentiCollegati"); +  }); + +  it("Tests AC-3: Given order id=20 belongs to authenticated customer When detail is requested Then timeline/documenti structures are arrays", async () => { +    for (let i = 1; i <= 20; i += 1) { +      await createRiparazione(500 + i); +    } +    const accessToken = await prepareActivatedPortalSession(); + +    const response = await request(app) +      .get("/api/portal/ordini/20") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(200); +    expect(Array.isArray(response.body.data.timeline)).toBe(true); +    expect(Array.isArray(response.body.data.documentiCollegati)).toBe(true); +  }); +}); + +describe("AC-4 - Given order id=20 belongs to another customer When GET /api/portal/ordini/20 Then 403 FORBIDDEN", () => { +  it("Tests AC-4: Given order id=20 belongs to customer 5 When customer 99 requests it Then HTTP 403 with FORBIDDEN", async () => { +    for (let i = 1; i <= 20; i += 1) { +      await createRiparazione(600 + i); +    } +    const accessToken = await prepareActivatedPortalSession({ +      clienteId: 99, +      email: "cliente99@test.it", +    }); + +    const response = await request(app) +      .get("/api/portal/ordini/20") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(403); +    expect(response.body.error.code).toBe("FORBIDDEN"); +  }); + +  it("Tests AC-4: Given forbidden detail request When customer 99 calls order 20 Then no detail payload is leaked", async () => { +    for (let i = 1; i <= 20; i += 1) { +      await createRiparazione(700 + i); +    } +    const accessToken = await prepareActivatedPortalSession({ +      clienteId: 99, +      email: "cliente99@test.it", +    }); + +    const response = await request(app) +      .get("/api/portal/ordini/20") +      .set("Authorization", `Bearer ${accessToken}`); + +    expect(response.status).toBe(403); +    expect(response.body).not.toHaveProperty("data.id"); +    expect(response.body).not.toHaveProperty("data.timeline"); +  }); +}); diff --git a/packages/backend/src/routes/auth.ts b/packages/backend/src/routes/auth.ts index 4fff7cf..1bcf377 100644 --- a/packages/backend/src/routes/auth.ts +++ b/packages/backend/src/routes/auth.ts @@ -5,6 +5,8 @@ import { getClienteById } from "../services/anagrafiche-service.js";  import {    activatePortalAccount,    getPortalDashboard, +  getPortalOrdineDettaglio, +  listPortalOrdini,    loginWithCredentials,    loginPortalWithCredentials,    logoutPortalSession, @@ -13,8 +15,10 @@ import {    type AuthFailureCode,    type ActivatePortalAccountResult,    type GetPortalDashboardResult, +  type GetPortalOrdineDettaglioResult,    type LoginResult,    type LoginPortalResult, +  type ListPortalOrdiniResult,    type LogoutPortalSessionResult,    type RefreshPortalSessionResult,    type RefreshSessionResult, @@ -232,6 +236,66 @@ function respondPortalDashboardFailure(      .json(buildErrorResponse("AUTH_SERVICE_UNAVAILABLE", "Servizio autenticazione non disponibile"));  }   +function respondPortalOrdiniListFailure( +  res: Response, +  result: Exclude<ListPortalOrdiniResult, { ok: true; data: unknown }>, +): void { +  if (result.code === "UNAUTHORIZED") { +    res +      .status(401) +      .json(buildErrorResponse("UNAUTHORIZED", "Token mancante o non valido")); +    return; +  } + +  if (result.code === "VALIDATION_ERROR") { +    res +      .status(400) +      .json(buildErrorResponse("VALIDATION_ERROR", "Parametri non validi")); +    return; +  } + +  res +    .status(500) +    .json(buildErrorResponse("AUTH_SERVICE_UNAVAILABLE", "Servizio autenticazione non disponibile")); +} + +function respondPortalOrdineDettaglioFailure( +  res: Response, +  result: Exclude<GetPortalOrdineDettaglioResult, { ok: true; data: unknown }>, +): void { +  if (result.code === "UNAUTHORIZED") { +    res +      .status(401) +      .json(buildErrorResponse("UNAUTHORIZED", "Token mancante o non valido")); +    return; +  } + +  if (result.code === "VALIDATION_ERROR") { +    res +      .status(400) +      .json(buildErrorResponse("VALIDATION_ERROR", "Parametri non validi")); +    return; +  } + +  if (result.code === "FORBIDDEN") { +    res +      .status(403) +      .json(buildErrorResponse("FORBIDDEN", "FORBIDDEN")); +    return; +  } + +  if (result.code === "NOT_FOUND") { +    res +      .status(404) +      .json(buildErrorResponse("ORDINE_NOT_FOUND", "Ordine non trovato")); +    return; +  } + +  res +    .status(500) +    .json(buildErrorResponse("AUTH_SERVICE_UNAVAILABLE", "Servizio autenticazione non disponibile")); +} +  authRouter.post("/login", async (req, res) => {    const ip = resolveClientIp(req.header("x-forwarded-for"), req.ip || "0.0.0.0");    const retryAfter = getRetryAfterSeconds(ip); @@ -444,4 +508,58 @@ portalRouter.get("/me", async (req, res) => {    res.status(200).json(result.data);  });   +portalRouter.get("/ordini", async (req, res) => { +  const authHeader = req.header("authorization"); +  if (!authHeader?.startsWith("Bearer ")) { +    res.status(401).json(buildErrorResponse("UNAUTHORIZED", "Token mancante o non valido")); +    return; +  } + +  const accessJwt = authHeader.slice("Bearer ".length); + +  let result: ListPortalOrdiniResult; +  try { +    result = await listPortalOrdini(accessJwt, { +      page: req.query.page, +      limit: req.query.limit, +      stato: req.query.stato, +    }); +  } catch (error) { +    respondAuthServiceError(res, error); +    return; +  } + +  if (!result.ok) { +    respondPortalOrdiniListFailure(res, result); +    return; +  } + +  res.status(200).json(result.data); +}); + +portalRouter.get("/ordini/:id", async (req, res) => { +  const authHeader = req.header("authorization"); +  if (!authHeader?.startsWith("Bearer ")) { +    res.status(401).json(buildErrorResponse("UNAUTHORIZED", "Token mancante o non valido")); +    return; +  } + +  const accessJwt = authHeader.slice("Bearer ".length); + +  let result: GetPortalOrdineDettaglioResult; +  try { +    result = await getPortalOrdineDettaglio(accessJwt, req.params.id); +  } catch (error) { +    respondAuthServiceError(res, error); +    return; +  } + +  if (!result.ok) { +    respondPortalOrdineDettaglioFailure(res, result); +    return; +  } + +  res.status(200).json({ data: result.data }); +}); +  export { authRouter, portalAuthRouter, portalRouter }; diff --git a/packages/backend/src/services/auth-service.ts b/packages/backend/src/services/auth-service.ts index 4af1c49..d3b452c 100644 --- a/packages/backend/src/services/auth-service.ts +++ b/packages/backend/src/services/auth-service.ts @@ -6,6 +6,7 @@ import {    type JwtPayload,  } from "../middleware/auth.js";  import { getClienteById, listClienteRiparazioni } from "./anagrafiche-service.js"; +import { getRiparazioneDettaglio, listRiparazioni } from "./riparazioni-service.js";  import {    createPortalAccountActivationNotifica,    listNotifiche, @@ -69,6 +70,46 @@ interface PortalDashboardPayload {    eventiRecenti: PortalDashboardEventPayload[];  }   +interface PortalOrdiniListItemPayload { +  id: number; +  codiceOrdine: string; +  stato: string; +  dataOrdine: string; +  tipoDispositivo: string; +} + +interface PortalOrdiniListPayload { +  data: PortalOrdiniListItemPayload[]; +  meta: { +    page: number; +    limit: number; +    total: number; +    totalPages: number; +  }; +} + +interface PortalOrdineTimelineItemPayload { +  stato: string; +  dataOra: string; +} + +interface PortalOrdineDocumentoPayload { +  tipo: string; +  riferimentoId: number; +} + +interface PortalOrdineDettaglioPayload { +  id: number; +  stato: string; +  importi: { +    totalePreventivi: number; +    totalePagato: number; +    saldoResiduo: number; +  }; +  timeline: PortalOrdineTimelineItemPayload[]; +  documentiCollegati: PortalOrdineDocumentoPayload[]; +} +  type LoginFailureCode = "INVALID_CREDENTIALS" | "ACCOUNT_DISABLED";  type RefreshFailureCode = "INVALID_REFRESH_TOKEN" | "ACCOUNT_DISABLED";  type PortalCreateFailureCode = @@ -83,6 +124,12 @@ type PortalLoginFailureCode = "INVALID_CREDENTIALS" | "SERVICE_UNAVAILABLE";  type PortalRefreshFailureCode = "INVALID_REFRESH_TOKEN" | "ACCOUNT_DISABLED";  type PortalLogoutFailureCode = "INVALID_REFRESH_TOKEN";  type PortalDashboardFailureCode = "UNAUTHORIZED" | "SERVICE_UNAVAILABLE"; +type PortalOrdiniFailureCode = +  | "UNAUTHORIZED" +  | "VALIDATION_ERROR" +  | "FORBIDDEN" +  | "NOT_FOUND" +  | "SERVICE_UNAVAILABLE";  type AuthFailureCode =    | "INVALID_CREDENTIALS"    | "ACCOUNT_DISABLED" @@ -120,6 +167,14 @@ type GetPortalDashboardResult =    | { ok: true; data: PortalDashboardPayload }    | { ok: false; code: PortalDashboardFailureCode };   +type ListPortalOrdiniResult = +  | { ok: true; data: PortalOrdiniListPayload } +  | { ok: false; code: PortalOrdiniFailureCode }; + +type GetPortalOrdineDettaglioResult = +  | { ok: true; data: PortalOrdineDettaglioPayload } +  | { ok: false; code: PortalOrdiniFailureCode }; +  interface CreatePortalAccountInput {    clienteId: number;    email: string | null; @@ -135,6 +190,12 @@ interface PortalLoginCredentials {    password: string;  }   +interface PortalOrdiniQueryInput { +  page: unknown; +  limit: unknown; +  stato: unknown; +} +  type PortalAccountStatus = "INVITATO" | "ATTIVO";  interface PortalAccountRecord {    clienteId: number; @@ -507,6 +568,23 @@ function resolvePortalClienteId(payload: JwtPayload): number | null {    return clienteId;  }   +function asPositiveInteger(value: unknown): number | null { +  if (typeof value === "number" && Number.isInteger(value) && value > 0) { +    return value; +  } +  if (typeof value === "string" && value.trim()) { +    const parsed = Number(value); +    if (Number.isInteger(parsed) && parsed > 0) { +      return parsed; +    } +  } +  return null; +} + +function roundCurrency(value: number): number { +  return Math.round(value * 100) / 100; +} +  function cleanupRevokedPortalRefreshTokens(now = Date.now()): void {    for (const [token, expiresAt] of revokedPortalRefreshTokens.entries()) {      if (expiresAt <= now) { @@ -743,10 +821,143 @@ async function getPortalDashboard(accessToken: string): Promise<GetPortalDashboa    };  }   +async function listPortalOrdini( +  accessToken: string, +  query: PortalOrdiniQueryInput, +): Promise<ListPortalOrdiniResult> { +  const token = accessToken.trim(); +  if (!token) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const payload = resolveTokenPayload(token); +  if (!payload || payload.tokenType !== ACCESS_KIND) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const clienteId = resolvePortalClienteId(payload); +  if (!clienteId) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const riparazioniResult = await listRiparazioni({ +    page: query.page, +    limit: query.limit, +    stato: query.stato, +    clienteId, +    tecnicoId: undefined, +    priorita: undefined, +    dataRicezioneDa: undefined, +    dataRicezioneA: undefined, +    search: undefined, +  }); +  if (!riparazioniResult.ok) { +    if (riparazioniResult.code === "VALIDATION_ERROR") { +      return { ok: false, code: "VALIDATION_ERROR" }; +    } +    return { ok: false, code: "SERVICE_UNAVAILABLE" }; +  } + +  return { +    ok: true, +    data: { +      data: riparazioniResult.data.data.map((row) => ({ +        id: row.id, +        codiceOrdine: row.codiceRiparazione, +        stato: row.stato, +        dataOrdine: row.dataRicezione, +        tipoDispositivo: row.tipoDispositivo, +      })), +      meta: riparazioniResult.data.meta, +    }, +  }; +} + +async function getPortalOrdineDettaglio( +  accessToken: string, +  ordineId: unknown, +): Promise<GetPortalOrdineDettaglioResult> { +  const token = accessToken.trim(); +  if (!token) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const payload = resolveTokenPayload(token); +  if (!payload || payload.tokenType !== ACCESS_KIND) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const clienteId = resolvePortalClienteId(payload); +  if (!clienteId) { +    return { ok: false, code: "UNAUTHORIZED" }; +  } + +  const parsedOrdineId = asPositiveInteger(ordineId); +  if (parsedOrdineId === null) { +    return { ok: false, code: "VALIDATION_ERROR" }; +  } + +  const dettaglioResult = await getRiparazioneDettaglio({ +    riparazioneId: parsedOrdineId, +  }); +  if (!dettaglioResult.ok) { +    if (dettaglioResult.code === "VALIDATION_ERROR") { +      return { ok: false, code: "VALIDATION_ERROR" }; +    } +    if (dettaglioResult.code === "NOT_FOUND") { +      return { ok: false, code: "NOT_FOUND" }; +    } +    return { ok: false, code: "SERVICE_UNAVAILABLE" }; +  } + +  const dettaglio = dettaglioResult.data.data; +  if (dettaglio.cliente.id !== clienteId) { +    return { ok: false, code: "FORBIDDEN" }; +  } + +  const totalePreventivi = roundCurrency( +    dettaglio.preventivi.reduce((sum, item) => sum + item.totale, 0), +  ); +  const totalePagato = 0; +  const saldoResiduo = roundCurrency(totalePreventivi - totalePagato); +  const timeline = +    dettaglio.statiHistory.length > 0 +      ? dettaglio.statiHistory.map((item) => ({ +          stato: item.stato, +          dataOra: item.dataOra, +        })) +      : [ +          { +            stato: dettaglio.stato, +            dataOra: new Date().toISOString(), +          }, +        ]; + +  return { +    ok: true, +    data: { +      id: dettaglio.id, +      stato: dettaglio.stato, +      importi: { +        totalePreventivi, +        totalePagato, +        saldoResiduo, +      }, +      timeline, +      documentiCollegati: dettaglio.preventivi.map((item) => ({ +        tipo: "PREVENTIVO", +        riferimentoId: item.id, +      })), +    }, +  }; +} +  export {    activatePortalAccount,    createPortalAccountForCliente,    getPortalDashboard, +  getPortalOrdineDettaglio, +  listPortalOrdini,    loginWithCredentials,    loginPortalWithCredentials,    logoutPortalSession, @@ -759,12 +970,15 @@ export {    type AuthFailureCode,    type CreatePortalAccountResult,    type GetPortalDashboardResult, +  type GetPortalOrdineDettaglioResult,    type LoginFailureCode,    type LoginResult,    type LoginPortalResult, +  type ListPortalOrdiniResult,    type LogoutPortalSessionResult,    type PortalActivateFailureCode,    type PortalCreateFailureCode, +  type PortalOrdiniFailureCode,    type PortalLoginFailureCode,    type PortalLogoutFailureCode,    type PortalRefreshFailureCode, diff --git a/packages/backend/src/services/riparazioni-service.ts b/packages/backend/src/services/riparazioni-service.ts index d732ba6..f8e55d7 100644 --- a/packages/backend/src/services/riparazioni-service.ts +++ b/packages/backend/src/services/riparazioni-service.ts @@ -38,6 +38,7 @@ interface ListRiparazioniInput {    page: unknown;    limit: unknown;    stato: unknown; +  clienteId?: unknown;    tecnicoId: unknown;    priorita: unknown;    dataRicezioneDa: unknown; @@ -305,6 +306,7 @@ interface ParsedListRiparazioniInput {    page: number;    limit: number;    stato?: string; +  clienteId?: number;    tecnicoId?: number;    priorita?: Priorita;    dataRicezioneDa?: Date; @@ -644,6 +646,18 @@ function parseListRiparazioniInput(      });    }   +  let clienteId: number | undefined; +  if (input.clienteId !== undefined && input.clienteId !== null) { +    const parsedClienteId = asPositiveInteger(input.clienteId); +    if (parsedClienteId === null) { +      return buildValidationFailure({ +        field: "clienteId", +        rule: "invalid_integer", +      }); +    } +    clienteId = parsedClienteId; +  } +    let tecnicoId: number | undefined;    if (input.tecnicoId !== undefined && input.tecnicoId !== null) {      const parsedTecnicoId = asPositiveInteger(input.tecnicoId); @@ -721,6 +735,7 @@ function parseListRiparazioniInput(        page,        limit,        stato, +      clienteId,        tecnicoId,        priorita,        dataRicezioneDa, @@ -1362,6 +1377,10 @@ async function listRiparazioniInTestStore(      const filtered = testRiparazioni      .filter((row) => { +      if (payload.clienteId !== undefined && row.clienteId !== payload.clienteId) { +        return false; +      } +        if (payload.stato && row.stato !== payload.stato) {          return false;        } @@ -1439,6 +1458,10 @@ async function listRiparazioniInDatabase(        where.stato = payload.stato;      }   +    if (payload.clienteId !== undefined) { +      where.clienteId = payload.clienteId; +    } +      if (payload.tecnicoId !== undefined) {        where.tecnicoId = payload.tecnicoId;      }