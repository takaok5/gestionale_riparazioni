story_id: '2.4'
story_title: 'Creazione Fornitore'
acceptance_criteria:
  - 'Given I am Admin When I POST /api/fornitori with { nome: "Ricambi SRL", categoria: "RICAMBI", partitaIva: "12345678901", telefono: "0612345678", email: "info@ricambi.it", indirizzo: "Via Milano 10", cap: "20100", citta: "Milano", provincia: "MI" } Then fornitore is created with auto-generated codiceFornitore "FOR-000001", I receive 201'
  - 'Given I am Admin When I POST /api/fornitori with categoria "SERVIZI" Then fornitore is created with categoria "SERVIZI"'
  - 'Given I am Admin When I POST /api/fornitori with invalid partitaIva "123" Then I receive 400 with validation error "P.IVA must be 11 digits"'
  - 'Given a fornitore with partitaIva "11111111111" exists When I POST /api/fornitori with same partitaIva Then I receive 409 with error "PARTITA_IVA_EXISTS"'
  - 'Given I am Tecnico When I POST /api/fornitori Then I receive 403 "FORBIDDEN"'
target_modules:
  - path: 'packages/backend/src/routes/fornitori.ts'
    reason: 'Route fornitori esistente con solo PUT; estensione POST con mapping errori dominio.'
  - path: 'packages/backend/src/services/anagrafiche-service.ts'
    reason: 'Service anagrafiche contiene updateFornitore e pattern createCliente; va esteso con createFornitore + validazioni.'
  - path: 'packages/backend/prisma/schema.prisma'
    reason: 'Model Fornitore e enum CategoriaFornitore; possibile vincolo unique su partitaIva per AC-4.'
  - path: 'packages/backend/src/__tests__/audit-trail.spec.ts'
    reason: 'Contiene pattern test API fornitori e reset store anagrafiche.'
  - path: 'packages/backend/src/__tests__/clienti-create-atdd.spec.ts'
    reason: 'Pattern ATDD per endpoint POST con assert su 201/400/409 e casi role-based.'
  - path: 'packages/shared/src/validators/index.ts'
    reason: 'Validatore Partita IVA condiviso potenzialmente riusabile per coerenza dominio.'
patterns_to_follow:
  - file: 'packages/backend/src/routes/clienti.ts:33'
    pattern: 'Helper dedicato per mappare failure del service in status HTTP + buildErrorResponse.'
  - file: 'packages/backend/src/routes/clienti.ts:234'
    pattern: 'Pattern POST route: payload tipizzato da req, chiamata service, 201 su successo.'
  - file: 'packages/backend/src/routes/fornitori.ts:47'
    pattern: 'Uso authenticate + authorize("ADMIN") per endpoint mutativi su fornitori.'
  - file: 'packages/backend/src/middleware/auth.ts:106'
    pattern: 'Middleware authorize ritorna 403 FORBIDDEN con envelope standard.'
  - file: 'packages/backend/src/services/anagrafiche-service.ts:607'
    pattern: 'Funzione parse input con validazioni field/rule e failure strutturato.'
  - file: 'packages/backend/src/services/anagrafiche-service.ts:434'
    pattern: 'Generazione codice progressivo con prefix + padStart(6, "0").'
  - file: 'packages/backend/src/services/anagrafiche-service.ts:1134'
    pattern: 'Create in DB con transaction, auditLog e gestione P2002 per conflitti unici.'
  - file: 'packages/backend/src/services/anagrafiche-service.ts:1237'
    pattern: 'Implementazione store test separata dal path database per coerenza test NODE_ENV=test.'
dependencies:
  - from: 'packages/backend/src/index.ts:8'
    to: 'packages/backend/src/routes/fornitori.ts'
    type: 'import router'
  - from: 'packages/backend/src/index.ts:22'
    to: 'packages/backend/src/routes/fornitori.ts'
    type: 'router mount /api/fornitori'
  - from: 'packages/backend/src/routes/fornitori.ts:4'
    to: 'packages/backend/src/services/anagrafiche-service.ts'
    type: 'service import'
  - from: 'packages/backend/src/routes/fornitori.ts:3'
    to: 'packages/backend/src/middleware/auth.ts'
    type: 'RBAC middleware dependency'
  - from: 'packages/backend/src/routes/fornitori.ts:2'
    to: 'packages/backend/src/lib/errors.ts'
    type: 'error envelope builder'
  - from: 'packages/backend/src/__tests__/audit-trail.spec.ts:5'
    to: 'packages/backend/src/services/anagrafiche-service.ts'
    type: 'test reset dependency'
risks:
  - 'createFornitore non esiste nel service: rischio gap funzionale tra route e dominio.'
  - 'Model Fornitore non ha unique esplicito su partitaIva: rischio mancato 409 su duplicati (AC-4).'
  - 'Store test Fornitore oggi contiene solo ragioneSociale/telefono: rischio inconsistenza test per campi required e codiceFornitore.'
  - 'Scelta validazione P.IVA (regex vs algoritmo checksum) puo generare mismatch tra backend e validator condiviso.'
  - 'Generazione codice FOR-NNNNNN deve gestire race condition in DB (retry su unique conflict).'
existing_tests:
  - 'packages/backend/src/__tests__/audit-trail.spec.ts'
  - 'packages/backend/src/__tests__/clienti-create-atdd.spec.ts'
  - 'packages/backend/src/__tests__/clienti-list-search-atdd.spec.ts'
  - 'packages/backend/src/__tests__/clienti-detail-update-atdd.spec.ts'
  - 'anagrafiche/tests.py'
