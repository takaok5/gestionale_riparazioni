story_id: '6.7'
story_title: 'Export Report'
acceptance_criteria:
  - id: 'AC-1'
    given: 'riparazioni exist'
    when: 'GET /api/report/export/riparazioni?dateFrom=2026-01-01&dateTo=2026-01-31'
    then: 'CSV with headers codiceRiparazione,cliente,tecnico,stato,dataRicezione,dataCompletamento and content-type text/csv'
  - id: 'AC-2'
    given: 'fatture exist'
    when: 'GET /api/report/export/finanziari?dateFrom=2026-01-01&dateTo=2026-01-31'
    then: 'CSV with fatture data'
  - id: 'AC-3'
    given: 'articoli exist'
    when: 'GET /api/report/export/magazzino'
    then: 'CSV with articoli and giacenze'
  - id: 'AC-4'
    given: 'actor role is TECNICO'
    when: 'GET /api/report/export/riparazioni'
    then: '403 FORBIDDEN Admin only'

target_modules:
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/routes/report.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/services/report-service.ts'
  - 'C:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend/src/__tests__/report-export-atdd.spec.ts'

patterns_to_follow:
  - pattern: 'Router endpoints with authenticate middleware and typed payload per endpoint'
    reference: 'packages/backend/src/routes/report.ts:94'
  - pattern: 'Error mapping: VALIDATION_ERROR -> 400, FORBIDDEN -> 403, fallback -> 500'
    reference: 'packages/backend/src/routes/report.ts:33'
  - pattern: 'Admin authorization guard in service layer with explicit FORBIDDEN/Admin only'
    reference: 'packages/backend/src/services/report-service.ts:560'
  - pattern: 'File download response headers (Content-Type + Content-Disposition attachment)'
    reference: 'packages/backend/src/routes/fatture.ts:341'
  - pattern: 'ATDD style with Given/When/Then naming and supertest Authorization header'
    reference: 'packages/backend/src/__tests__/report-riparazioni-atdd.spec.ts:116'

dependencies:
  - module: 'packages/backend/src/index.ts'
    reason: 'Registers /api/report router; new export endpoints become available via this mount'
    evidence: 'packages/backend/src/index.ts:37'
  - module: 'packages/backend/src/services/riparazioni-service.ts'
    reason: 'Used by report-service to source riparazioni data for CSV export'
    evidence: 'packages/backend/src/services/report-service.ts:2'
  - module: 'packages/backend/src/services/fatture-service.ts'
    reason: 'Used by report-service for financial rows'
    evidence: 'packages/backend/src/services/report-service.ts:14'
  - module: 'packages/backend/src/services/anagrafiche-service.ts'
    reason: 'Used by report-service for articoli and stock-related rows'
    evidence: 'packages/backend/src/services/report-service.ts:9'
  - module: 'packages/backend/src/services/preventivi-service.ts'
    reason: 'Already used in financial report flow; may influence exported financial columns/filters'
    evidence: 'packages/backend/src/services/report-service.ts:15'

risks:
  - 'CSV injection in spreadsheet clients if fields start with =,+,-,@; requires sanitization/escaping policy.'
  - 'Large exports can increase memory usage if CSV is built in-memory instead of streamed response.'
  - 'Date filtering mismatch between JSON report and CSV export can create data discrepancies perceived as bug.'
  - 'Header/schema drift between AC-expected columns and implementation can break consumers and tests.'

existing_tests:
  - 'packages/backend/src/__tests__/report-riparazioni-atdd.spec.ts'
  - 'packages/backend/src/__tests__/report-finanziari-atdd.spec.ts'
  - 'packages/backend/src/__tests__/report-magazzino-atdd.spec.ts'
  - 'no existing files found for export CSV endpoints (new test file required)'
