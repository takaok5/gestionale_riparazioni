npm warn Unknown cli config "--run". This will stop working in the next major version of npm.

> gestionale-riparazioni@0.1.0 test
> npm run test --workspaces --if-present

npm warn Unknown env config "run". This will stop working in the next major version of npm.

> @gestionale/backend@0.1.0 test
> vitest run


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/backend[39m

 [32mâœ“[39m src/__tests__/clienti-create-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 297[2mms[22m[39m
 [32mâœ“[39m src/__tests__/preventivi-update-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 382[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fornitori-create-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 411[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-create-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 467[2mms[22m[39m
 [31mâ¯[39m src/__tests__/preventivi-notifiche-atdd.spec.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 454[2mms[22m[39m
[31m   [31mÃ—[31m AC-1 - POST /api/preventivi/5/invia creates PREVENTIVO notification with PDF attachment[2m > [22mTests AC-1: Given preventivo id=5 and cliente@test.it When POST /api/preventivi/5/invia Then 200 and GET /api/notifiche?tipo=PREVENTIVO returns INVIATA record[39m[32m 65[2mms[22m[39m
[31m     â†’ expected undefined to be 'PREVENTIVO' // Object.is equality[39m
[31m   [31mÃ—[31m AC-1 - POST /api/preventivi/5/invia creates PREVENTIVO notification with PDF attachment[2m > [22mTests AC-1: Given successful send When listing PREVENTIVO notifications Then record contains subject "Preventivo - RIP-20260209-0001" and allegato preventivo-5.pdf[39m[32m 30[2mms[22m[39m
[31m     â†’ expected undefined to be 'Preventivo - RIP-20260209-0001' // Object.is equality[39m
[31m   [31mÃ—[31m AC-2 - Email body contains preventivo details (voci, subtotale, IVA, totale)[2m > [22mTests AC-2: Given preventivo totale 244.00 EUR When send succeeds Then notification body contains subtotale=200.00, IVA=44.00, totale=244.00[39m[32m 68[2mms[22m[39m
[31m     â†’ expected '' to contain 'subtotale'[39m
[31m   [31mÃ—[31m AC-2 - Email body contains preventivo details (voci, subtotale, IVA, totale)[2m > [22mTests AC-2: Given successful send When reading PREVENTIVO notification Then body contains preventivo voci details[39m[32m 58[2mms[22m[39m
[31m     â†’ expected '' to contain 'voci'[39m
[31m   [31mÃ—[31m AC-3 - Email failure creates PREVENTIVO FALLITA notification and returns 500[2m > [22mTests AC-3: Given email service fails When POST /api/preventivi/5/invia Then 500 "Failed to send email" and PREVENTIVO FALLITA notification exists[39m[32m 69[2mms[22m[39m
[31m     â†’ expected undefined to be 'PREVENTIVO' // Object.is equality[39m
   [32mâœ“[39m AC-3 - Email failure creates PREVENTIVO FALLITA notification and returns 500[2m > [22mTests AC-3: Given failed send When reading preventivo detail Then preventivo remains BOZZA and dataInvio is null[32m 49[2mms[22m[39m
[31m   [31mÃ—[31m AC-4 - GET /api/notifiche?tipo=PREVENTIVO exposes destinatario, dataInvio, stato[2m > [22mTests AC-4: Given preventivo sent successfully When GET /api/notifiche?tipo=PREVENTIVO Then response contains only PREVENTIVO notifications[39m[32m 65[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m AC-4 - GET /api/notifiche?tipo=PREVENTIVO exposes destinatario, dataInvio, stato[2m > [22mTests AC-4: Given PREVENTIVO notifications exist When listing them Then each row exposes destinatario, dataInvio, stato[39m[32m 47[2mms[22m[39m
[31m     â†’ expected 'undefined' to be 'string' // Object.is equality[39m
 [32mâœ“[39m src/__tests__/users-create.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 493[2mms[22m[39m
 [32mâœ“[39m src/__tests__/articoli-create-atdd.spec.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 490[2mms[22m[39m
 [32mâœ“[39m src/__tests__/audit-trail.spec.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 709[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fornitori-list-search-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 868[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista fornitori paginata[2m > [22mtests AC-1: should return 200 with 15 fornitori and meta {page:1,limit:20,total:15,totalPages:1} [33m 476[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-ricambi-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 883[2mms[22m[39m
 [32mâœ“[39m src/__tests__/clienti-detail-update-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 871[2mms[22m[39m
 [32mâœ“[39m src/__tests__/articoli-movimenti-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 980[2mms[22m[39m
 [32mâœ“[39m src/__tests__/preventivi-create-atdd.spec.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1077[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Creazione preventivo con totali[2m > [22mTests AC-1: Given esiste una riparazione con id=10 When invio POST /api/preventivi con payload MANODOPERA+RICAMBIO Then viene creato preventivo in stato "BOZZA" con subtotale=200.00, iva=44.00, totale=244.00 e HTTP 201 [33m 379[2mms[22m[39m
 [32mâœ“[39m src/__tests__/auth-refresh.spec.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 1159[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Rinnovo con refresh token valido[2m > [22mreturns 200 with new accessToken and refreshToken [33m 493[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Rinnovo con refresh token valido[2m > [22mreturns user payload with id, username, email and role [33m 501[2mms[22m[39m
 [32mâœ“[39m src/__tests__/users-change-password.spec.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1240[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-2 - Current password errata[2m > [22mkeeps old password valid when change fails [33m 938[2mms[22m[39m
 [32mâœ“[39m src/__tests__/clienti-list-search-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1281[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista clienti paginata[2m > [22mtests AC-1: should return 200 with data[10] and meta {page:1,limit:10,total:25,totalPages:3} [33m 684[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista clienti paginata[2m > [22mtests AC-1: should return records ordered by id asc on page 1 [33m 311[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-detail-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1407[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Dettaglio riparazione con cliente, tecnico e stato corrente[2m > [22mTests AC-1: Given riparazione id=10 exists When I GET /api/riparazioni/10 Then I receive 200 with full riparazione data including cliente { id, nome, telefono, email }, tecnico { id, username }, current stato [33m 438[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-list-filter-atdd.spec.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1564[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista riparazioni paginata[2m > [22mtests AC-1: Given 30 repairs exist When GET /api/riparazioni?page=1&limit=15 Then returns 200 with 15 rows and meta {page:1,limit:15,total:30,totalPages:2} [33m 878[2mms[22m[39m
 [32mâœ“[39m src/__tests__/ordini-stato-atdd.spec.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1595[2mms[22m[39m
 [32mâœ“[39m src/__tests__/ordini-ricezione-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1653[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Given ordine SPEDITO con due voci e giacenze 3/8 When POST /api/ordini/:id/ricevi completo Then giacenze 13/13 e stato RICEVUTO[2m > [22mTests AC-1: Given ordine id=12 stato SPEDITO con voci articolo 5/7 e giacenze 3/8 When POST /api/ordini/12/ricevi con quantita 10 e 5 Then HTTP 200 e stato RICEVUTO [33m 326[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fatture-create-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1823[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Creazione fattura da preventivo approvato[2m > [22mTests AC-1: Given preventivo id=5 APPROVATO con totale 244.00 When POST /api/fatture { riparazioneId: 10 } Then HTTP 201 con numeroFattura 2026/0001 e importi 200/44/244 [33m 375[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Creazione fattura da preventivo approvato[2m > [22mTests AC-1: Given preventivo approvato per riparazione 10 When genero fattura Then risposta include stato EMESSA, riparazioneId=10 e pdfPath non vuoto [33m 330[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-annullamento-admin-atdd.spec.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1885[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Admin annulla da IN_LAVORAZIONE con nota[2m > [22mTests AC-1: Given ADMIN userId=1 and riparazione 10 in stato IN_LAVORAZIONE When PATCH /api/riparazioni/10/stato {"stato":"ANNULLATA","note":"Cliente ha ritirato dispositivo"} Then 200 with data.stato ANNULLATA [33m 565[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Admin annulla da IN_LAVORAZIONE con nota[2m > [22mTests AC-1: Given admin cancellation succeeds When GET /api/riparazioni/10 Then latest statiHistory row has stato ANNULLATA userId 1 note "Cliente ha ritirato dispositivo" [33m 364[2mms[22m[39m
 [32mâœ“[39m src/__tests__/report-magazzino-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1894[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - KPI report magazzino[2m > [22mTests AC-1: Given articoli with giacenze and prezzi When GET /api/report/magazzino Then returns 200 with KPI keys [33m 490[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - KPI report magazzino[2m > [22mTests AC-1: Given Display Samsung S21 with SCARICO 45 When report is returned Then top item includes articoloId=5 and quantitaUtilizzata=45 [33m 360[2mms[22m[39m
 [32mâœ“[39m src/__tests__/articoli-list-search-alert-atdd.spec.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1965[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista paginata articoli[2m > [22mTests AC-1: Given 30 articoli exist When GET /api/articoli?page=1&limit=20 Then 200 with 20 rows and meta [33m 859[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista paginata articoli[2m > [22mTests AC-1: Given page=2 limit=10 When listing Then meta reflects pagination and deterministic boundaries [33m 442[2mms[22m[39m
 [32mâœ“[39m src/__tests__/auth-login.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2049[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Login Utente valido[2m > [22mreturns 200 with accessToken and refreshToken when credentials are valid [33m 463[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Login Utente valido[2m > [22mreturns user payload with id, username, email, role [33m 476[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-3 - Account disabilitato[2m > [22mreturns 401 ACCOUNT_DISABLED for mario.disabilitato [33m 498[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-3 - Account disabilitato[2m > [22mreturns no tokens for disabled account [33m 480[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-stato-notifiche-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2190[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - RICEVUTA generates email and INVIATA Notifica[2m > [22mTests AC-1: Given riparazione id=10 and cliente@test.it When PATCH /api/riparazioni/10/stato sets stato=RICEVUTA Then 200 and email subject "Riparazione Ricevuta - RIP-20260209-0001" is returned in payload [33m 557[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - RICEVUTA generates email and INVIATA Notifica[2m > [22mTests AC-1: Given transition to RICEVUTA succeeds When GET /api/notifiche?tipo=STATO_RIPARAZIONE Then latest row has stato INVIATA and riferimentoId 10 [33m 382[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-assegnazione-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2433[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Assegnazione valida a tecnico[2m > [22mTests AC-1: Given admin and user id=7 role TECNICO When PATCH /api/riparazioni/10/assegna {tecnicoId:7} Then 200 and data.id=10 data.tecnicoId=7 [33m 578[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Assegnazione valida a tecnico[2m > [22mTests AC-1: Given assignment to tecnico id=7 succeeds When requesting detail Then riparazione 10 has tecnico.id=7 [33m 385[2mms[22m[39m
 [32mâœ“[39m src/__tests__/report-riparazioni-atdd.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 146[2mms[22m[39m
 [32mâœ“[39m src/__tests__/users-update-deactivate.spec.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 132[2mms[22m[39m
 [32mâœ“[39m src/__tests__/dashboard-carico-tecnici-atdd.spec.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 138[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fornitori-detail-update-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 119[2mms[22m[39m
 [32mâœ“[39m src/__tests__/dashboard-riparazioni-per-stato-atdd.spec.ts [2m([22m[2m11 tests[22m[2m)[22m[32m 127[2mms[22m[39m
 [32mâœ“[39m src/__tests__/ordini-create-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 151[2mms[22m[39m
 [32mâœ“[39m src/__tests__/preventivi-response-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 142[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-stato-base-atdd.spec.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2917[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - RICEVUTA -> IN_DIAGNOSI con storico[2m > [22mTests AC-1: Given userId=7 role TECNICO assigned to riparazione 10 in stato RICEVUTA When PATCH /api/riparazioni/10/stato with {"stato":"IN_DIAGNOSI","note":"Iniziata diagnosi"} Then 200 with data {id:10, stato:IN_DIAGNOSI} [33m 570[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - RICEVUTA -> IN_DIAGNOSI con storico[2m > [22mTests AC-1: Given transition to IN_DIAGNOSI succeeds When GET /api/riparazioni/10 Then statiHistory latest row contains stato IN_DIAGNOSI, userId 7, note "Iniziata diagnosi" [33m 374[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fatture-pagamenti-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2918[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Registrazione pagamento totale[2m > [22mTests AC-1: Given fattura id=8 totale 244.00 senza pagamenti When POST /api/fatture/8/pagamenti importo 244.00 Then HTTP 201 e stato PAGATA [33m 857[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Registrazione pagamento totale[2m > [22mTests AC-1: Given pagamento totale registrato When GET /api/fatture/8 Then residuo 0.00 [33m 501[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-2 - Registrazione pagamento parziale + saldo[2m > [22mTests AC-2: Given pagamento iniziale 100.00 When POST saldo 144.00 Then totalePagato 244.00 e stato PAGATA [33m 403[2mms[22m[39m
 [32mâœ“[39m src/__tests__/preventivi-send-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 88[2mms[22m[39m
 [32mâœ“[39m src/__tests__/report-export-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 80[2mms[22m[39m
 [32mâœ“[39m src/__tests__/dashboard-operativa-atdd.spec.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 85[2mms[22m[39m
 [32mâœ“[39m src/__tests__/report-finanziari-atdd.spec.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 70[2mms[22m[39m
 [32mâœ“[39m src/__tests__/preventivi-detail-atdd.spec.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 36[2mms[22m[39m
 [32mâœ“[39m src/__tests__/riparazioni-stato-preventivo-atdd.spec.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3363[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - IN_DIAGNOSI -> PREVENTIVO_EMESSO[2m > [22mTests AC-1: Given riparazione 10 in stato IN_DIAGNOSI and actor TECNICO userId=7 When PATCH /api/riparazioni/10/stato with {"stato":"PREVENTIVO_EMESSO","note":"Preventivo emesso"} Then 200 with data.stato PREVENTIVO_EMESSO [33m 572[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - IN_DIAGNOSI -> PREVENTIVO_EMESSO[2m > [22mTests AC-1: Given transition to PREVENTIVO_EMESSO succeeds When GET /api/riparazioni/10 Then latest statiHistory row contains stato PREVENTIVO_EMESSO, userId 7 and note "Preventivo emesso" [33m 380[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-2 - PREVENTIVO_EMESSO -> IN_ATTESA_APPROVAZIONE[2m > [22mTests AC-2: Given riparazione 10 in stato PREVENTIVO_EMESSO and actor TECNICO userId=7 When PATCH /api/riparazioni/10/stato with {"stato":"IN_ATTESA_APPROVAZIONE","note":"In attesa approvazione preventivo"} Then 200 with data.stato IN_ATTESA_APPROVAZIONE [33m 302[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-2 - PREVENTIVO_EMESSO -> IN_ATTESA_APPROVAZIONE[2m > [22mTests AC-2: Given transition to IN_ATTESA_APPROVAZIONE succeeds When GET /api/riparazioni/10 Then latest statiHistory row contains stato IN_ATTESA_APPROVAZIONE, userId 7 and note "In attesa approvazione preventivo" [33m 309[2mms[22m[39m
 [32mâœ“[39m src/__tests__/fatture-lista-dettaglio-atdd.spec.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3447[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista fatture paginata[2m > [22mTests AC-1: Given 20 fatture exist When I GET /api/fatture?page=1&limit=10 Then I receive 200 with data array of 10 fatture and meta { page: 1, limit: 10, total: 20 } [33m 1590[2mms[22m[39m
   [33m[2mâœ“[22m[39m AC-1 - Lista fatture paginata[2m > [22mTests AC-1: Given 20 fatture exist When I GET /api/fatture?page=1&limit=10 Then response keeps deterministic first page boundaries [33m 647[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 7 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-1 - POST /api/preventivi/5/invia creates PREVENTIVO notification with PDF attachment[2m > [22mTests AC-1: Given preventivo id=5 and cliente@test.it When POST /api/preventivi/5/invia Then 200 and GET /api/notifiche?tipo=PREVENTIVO returns INVIATA record
[31m[1mAssertionError[22m: expected undefined to be 'PREVENTIVO' // Object.is equality[39m

[32m- Expected:[39m 
"PREVENTIVO"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m55:26[22m[39m
    [90m 53| [39m    [34mexpect[39m([33mArray[39m[33m.[39m[34misArray[39m(notificheResponse[33m.[39mbody[33m?.[39mdata))[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m 54| [39m    [35mconst[39m latest [33m=[39m (notificheResponse[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m 55| [39m    [34mexpect[39m(latest[33m?.[39mtipo)[33m.[39m[34mtoBe[39m([32m"PREVENTIVO"[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 56| [39m    [34mexpect[39m(latest[33m?.[39mstato)[33m.[39m[34mtoBe[39m([32m"INVIATA"[39m)[33m;[39m
    [90m 57| [39m    [34mexpect[39m(latest[33m?.[39mdestinatario)[33m.[39m[34mtoBe[39m([32m"cliente@test.it"[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-1 - POST /api/preventivi/5/invia creates PREVENTIVO notification with PDF attachment[2m > [22mTests AC-1: Given successful send When listing PREVENTIVO notifications Then record contains subject "Preventivo - RIP-20260209-0001" and allegato preventivo-5.pdf
[31m[1mAssertionError[22m: expected undefined to be 'Preventivo - RIP-20260209-0001' // Object.is equality[39m

[32m- Expected:[39m 
"Preventivo - RIP-20260209-0001"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m70:29[22m[39m
    [90m 68| [39m
    [90m 69| [39m    [35mconst[39m latest [33m=[39m (notificheResponse[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m 70| [39m    [34mexpect[39m(latest[33m?.[39moggetto)[33m.[39m[34mtoBe[39m([32m"Preventivo - RIP-20260209-0001"[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m 71| [39m    expect(String(latest?.allegato ?? "")).toContain("preventivo-5.pdfâ€¦
    [90m 72| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-2 - Email body contains preventivo details (voci, subtotale, IVA, totale)[2m > [22mTests AC-2: Given preventivo totale 244.00 EUR When send succeeds Then notification body contains subtotale=200.00, IVA=44.00, totale=244.00
[31m[1mAssertionError[22m: expected '' to contain 'subtotale'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- subtotale[39m

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m87:18[22m[39m
    [90m 85| [39m    [35mconst[39m latest [33m=[39m (notificheResponse[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m 86| [39m    [35mconst[39m body [33m=[39m [33mString[39m(latest[33m?.[39mcontenuto [33m??[39m [32m""[39m)[33m;[39m
    [90m 87| [39m    [34mexpect[39m(body)[33m.[39m[34mtoContain[39m([32m"subtotale"[39m)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m 88| [39m    [34mexpect[39m(body)[33m.[39m[34mtoContain[39m([32m"200.00"[39m)[33m;[39m
    [90m 89| [39m    [34mexpect[39m(body)[33m.[39m[34mtoContain[39m([32m"IVA"[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-2 - Email body contains preventivo details (voci, subtotale, IVA, totale)[2m > [22mTests AC-2: Given successful send When reading PREVENTIVO notification Then body contains preventivo voci details
[31m[1mAssertionError[22m: expected '' to contain 'voci'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- voci[39m

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m105:45[22m[39m
    [90m103| [39m
    [90m104| [39m    [35mconst[39m latest [33m=[39m (notificheResponse[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m105| [39m    [34mexpect[39m([33mString[39m(latest[33m?.[39mcontenuto [33m??[39m [32m""[39m))[33m.[39m[34mtoContain[39m([32m"voci"[39m)[33m;[39m
    [90m   | [39m                                            [31m^[39m
    [90m106| [39m  })[33m;[39m
    [90m107| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-3 - Email failure creates PREVENTIVO FALLITA notification and returns 500[2m > [22mTests AC-3: Given email service fails When POST /api/preventivi/5/invia Then 500 "Failed to send email" and PREVENTIVO FALLITA notification exists
[31m[1mAssertionError[22m: expected undefined to be 'PREVENTIVO' // Object.is equality[39m

[32m- Expected:[39m 
"PREVENTIVO"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m126:26[22m[39m
    [90m124| [39m
    [90m125| [39m    [35mconst[39m latest [33m=[39m (notificheResponse[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m126| [39m    [34mexpect[39m(latest[33m?.[39mtipo)[33m.[39m[34mtoBe[39m([32m"PREVENTIVO"[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m127| [39m    [34mexpect[39m(latest[33m?.[39mstato)[33m.[39m[34mtoBe[39m([32m"FALLITA"[39m)[33m;[39m
    [90m128| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-4 - GET /api/notifiche?tipo=PREVENTIVO exposes destinatario, dataInvio, stato[2m > [22mTests AC-4: Given preventivo sent successfully When GET /api/notifiche?tipo=PREVENTIVO Then response contains only PREVENTIVO notifications
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m159:25[22m[39m
    [90m157| [39m    [35mconst[39m rows [33m=[39m response[33m.[39mbody[33m?.[39mdata [33m??[39m [][33m;[39m
    [90m158| [39m    [34mexpect[39m([33mArray[39m[33m.[39m[34misArray[39m(rows))[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m159| [39m    [34mexpect[39m(rows[33m.[39mlength)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m160| [39m    expect(rows.every((row: { tipo?: string }) => row.tipo === "PREVENâ€¦
    [90m161| [39m      [35mtrue[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/preventivi-notifiche-atdd.spec.ts[2m > [22mAC-4 - GET /api/notifiche?tipo=PREVENTIVO exposes destinatario, dataInvio, stato[2m > [22mTests AC-4: Given PREVENTIVO notifications exist When listing them Then each row exposes destinatario, dataInvio, stato
[31m[1mAssertionError[22m: expected 'undefined' to be 'string' // Object.is equality[39m

Expected: [32m"string"[39m
Received: [31m"undefined"[39m

[36m [2mâ¯[22m src/__tests__/preventivi-notifiche-atdd.spec.ts:[2m175:41[22m[39m
    [90m173| [39m
    [90m174| [39m    [35mconst[39m latest [33m=[39m (response[33m.[39mbody[33m?.[39mdata [33m??[39m [])[33m.[39m[34mat[39m([33m-[39m[34m1[39m)[33m;[39m
    [90m175| [39m    [34mexpect[39m([35mtypeof[39m latest[33m?.[39mdestinatario)[33m.[39m[34mtoBe[39m([32m"string"[39m)[33m;[39m
    [90m   | [39m                                        [31m^[39m
    [90m176| [39m    [34mexpect[39m(latest[33m?.[39mdestinatario)[33m.[39m[34mtoBe[39m([32m"cliente@test.it"[39m)[33m;[39m
    [90m177| [39m    [34mexpect[39m([35mtypeof[39m latest[33m?.[39mdataInvio)[33m.[39m[34mtoBe[39m([32m"string"[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/7]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m42 passed[39m[22m[90m (43)[39m
[2m      Tests [22m [1m[31m7 failed[39m[22m[2m | [22m[1m[32m392 passed[39m[22m[90m (399)[39m
[2m   Start at [22m 10:19:59
[2m   Duration [22m 7.25s[2m (transform 3.52s, setup 0ms, collect 112.43s, tests 46.48s, environment 12ms, prepare 12.95s)[22m

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path C:\Users\FAT-E\progetti\gestionale_riparazioni-main\packages\backend
npm error workspace @gestionale/backend@0.1.0
npm error location C:\Users\FAT-E\progetti\gestionale_riparazioni-main\packages\backend
npm error command failed
npm error command C:\WINDOWS\system32\cmd.exe /d /s /c vitest run


> @gestionale/frontend@0.1.0 test
> vitest run


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/frontend[39m

No test files found, exiting with code 0

[2minclude: [22m[33msrc/**/*.test.ts[2m, [22msrc/**/*.spec.ts[39m
[2mexclude:  [22m[33m**/node_modules/**[2m, [22m**/dist/**[2m, [22m**/cypress/**[2m, [22m**/.{idea,git,cache,output,temp}/**[2m, [22m**/{karma,rollup,webpack,vite,vitest,jest,ava,babel,nyc,cypress,tsup,build,eslint,prettier}.config.*[39m


> @gestionale/shared@0.1.0 test
> vitest run


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/FAT-E/progetti/gestionale_riparazioni-main/packages/shared[39m

 [32mâœ“[39m src/validators/index.spec.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 2[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m4 passed[39m[22m[90m (4)[39m
[2m   Start at [22m 10:20:07
[2m   Duration [22m 535ms[2m (transform 36ms, setup 0ms, collect 36ms, tests 2ms, environment 0ms, prepare 156ms)[22m

